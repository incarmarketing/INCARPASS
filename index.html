<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>INCARPASS PRO - Universal Event Platform</title>
    
    <!-- 필수 라이브러리 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- 폰트 다양화 -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Nanum+Brush+Script&family=Nanum+Myeongjo:wght@400;700;800&family=Noto+Sans+KR:wght@100;300;400;500;700;900&family=Gugi&family=Gamja+Flower&family=Hi+Melody&family=Sunflower:wght@300;500;700&family=Gowun+Dodum&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        incar: '#27398C', 
                        'incar-dark': '#1a2b6d', 
                        'incar-light': '#eef2ff',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    },
                    boxShadow: { 'card': '0 4px 20px rgba(39, 57, 140, 0.08)' },
                    fontFamily: {
                        'sans': ['Noto Sans KR', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; color: #334155; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .scan-line { width: 100%; height: 2px; background: #ef4444; position: absolute; top: 0; left: 0; animation: scan 2s infinite linear; z-index: 20; box-shadow: 0 0 4px #ef4444; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        
        .mobile-only { display: block; }
        .pc-only { display: none; }
        @media (min-width: 768px) {
            .mobile-only { display: none; }
            .pc-only { display: block; }
        }
        
        .data-table th { background-color: #f8fafc; color: #64748b; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; padding: 12px 16px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        .data-table td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; font-weight: 500; color: #334155; }
        .data-table tr:hover td { background-color: #f8fafc; }

        /* [수정] 인쇄 스타일 대폭 개선 - 스크롤 이슈 해결 */
        @media print {
            @page { size: A4 portrait; margin: 0; }
            
            /* 모든 스크롤과 높이 제한 해제: 브라우저가 전체 콘텐츠를 인식하도록 함 */
            html, body, #root, main, .overflow-y-auto {
                width: 100%;
                height: auto !important;
                min-height: auto !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                position: static !important; /* fixed/absolute 해제 */
            }

            /* 화면에 있는 모든 요소 숨김 처리 */
            body * {
                visibility: hidden;
            }

            /* 인쇄 컨테이너와 그 자식들만 보이게 설정 */
            .print-only-container, .print-only-container * {
                visibility: visible !important;
            }

            /* 인쇄 컨테이너를 문서 흐름의 최상단으로 강제 이동 */
            .print-only-container {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: white;
                z-index: 9999;
                display: block !important;
                overflow: visible !important;
            }

            /* 인쇄 목록 컨테이너의 flex/scroll 속성 제거 */
            .print-reset-spacing {
                display: block !important;
                overflow: visible !important;
                height: auto !important;
            }

            /* 인쇄 시 숨겨야 할 UI 요소들 */
            .no-print { display: none !important; }

            /* 각 명찰 페이지 설정: 강제 페이지 넘김 */
            .page-wrapper {
                width: 100%;
                height: 100vh;
                display: flex !important;
                justify-content: center;
                align-items: center;
                break-after: page; /* 표준 페이지 넘김 */
                page-break-after: always; /* 레거시 지원 */
                page-break-inside: avoid;
                margin: 0;
                padding: 0;
                position: relative !important;
            }
            
            /* 마지막 페이지 뒤에는 공백 페이지 방지 */
            .page-wrapper:last-child {
                break-after: auto;
                page-break-after: auto;
            }

            .badge-card {
                border: none !important;
                box-shadow: none !important;
                page-break-inside: avoid;
            }
        }
        .print-only { display: none; }
        
        .font-noto { font-family: 'Noto Sans KR', sans-serif; }
        .font-serif { font-family: 'Nanum Myeongjo', serif; }
        .font-black-han { font-family: 'Black Han Sans', sans-serif; }
        .font-dohyeon { font-family: 'Do Hyeon', sans-serif; }
        .font-brush { font-family: 'Nanum Brush Script', cursive; }
        .font-gugi { font-family: 'Gugi', cursive; }
        .font-gamja { font-family: 'Gamja Flower', cursive; }
        .font-melody { font-family: 'Hi Melody', cursive; }
        .font-sunflower { font-family: 'Sunflower', sans-serif; }
        .font-gowun { font-family: 'Gowun Dodum', sans-serif; }
    </style>
</head>
<body class="h-[100dvh] w-screen flex flex-col md:flex-row bg-slate-50">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment, useCallback } = React;
        const CURRENCY = '$';

        // ... (Icon Component remains the same)
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                menu: <path d="M3 12h18M3 6h18M3 18h18"/>,
                dashboard: <path d="M3 3h7v7H3V3m11 0h7v7h-7V3m0 11h7v7h-7v-7M3 14h7v7H3v-7"/>,
                qr: <path d="M3 7V3h4M3 17v4h4M17 3h4v4M21 17v-4h4m-4 4h-4M7 11h2v2H7v-2m4 0h2v2h-2v-2m4 0h2v2h-2v-2"/>,
                users: <g><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                money: <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>,
                edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></g>,
                settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 15a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>,
                check: <polyline points="20 6 9 17 4 12"/>,
                x: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
                alert: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12" y2="16"/></g>,
                history: <g><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></g>,
                upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
                download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>,
                table: <g><path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/></g>,
                print: <g><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></g>,
                bus: <g><path d="M19 17h2l.64-2.54c.24-1.12.36-2.26.36-3.41V8.5a4.5 4.5 0 0 0-4.5-4.5h-11A4.5 4.5 0 0 0 2 8.5v2.55c0 1.15.12 2.29.36 3.41L3 17h2"/><path d="M15 17v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2"/><path d="M16 8.5h.01"/><path d="M8 8.5h.01"/></g>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="2"/>}</svg>;
        };

        // ... (ResultModal, SessionDetailModal, QRCodeCanvas components remain the same) ...
        const ResultModal = ({ result, onClose, onForceUpdate }) => {
            if (!result) return null;
            const { status, msg, subMsg, user, logs, relatedLogs, requiredChoice, session } = result;
            const isSuccess = status === 'success';
            const isTargetMismatch = status === 'error' && msg === '대상자 아님';
            
            useEffect(() => {
                if(isSuccess) {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }
            }, [isSuccess]);

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm animate-slide-up no-print">
                    <div className="bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl relative z-[201]">
                        <div className={`p-8 text-center flex flex-col items-center justify-center ${isSuccess ? 'bg-emerald-50' : (status==='duplicate'?'bg-amber-50':'bg-rose-50')}`}>
                            <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 ${isSuccess ? 'bg-emerald-100 text-emerald-600' : (status==='duplicate'?'bg-amber-100 text-amber-600':'bg-rose-100 text-rose-600')}`}>
                                <Icon name={isSuccess ? 'check' : (status==='duplicate'?'alert':'x')} size={40} />
                            </div>
                            <h2 className={`text-2xl font-bold mb-1 ${isSuccess ? 'text-emerald-800' : (status==='duplicate'?'text-amber-800':'text-rose-800')}`}>{msg}</h2>
                            <p className="text-slate-500 font-medium">{subMsg}</p>
                        </div>
                        {user && (
                            <div className="p-6 bg-white space-y-4">
                                <div className="flex items-center gap-4 p-4 rounded-2xl bg-slate-50 border border-slate-100">
                                    <div className="w-12 h-12 rounded-full bg-incar text-white flex items-center justify-center font-bold text-lg">{user.name[0]}</div>
                                    <div>
                                        <div className="font-bold text-lg text-slate-900">{user.name}</div>
                                        <div className="text-xs text-slate-400 font-medium">{user.org} | {user.uid}</div>
                                    </div>
                                </div>
                                {isSuccess && logs && logs.finalAmount !== undefined && (
                                    <div className="flex justify-between items-center p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                                        <span className="text-emerald-700 font-bold text-sm">최종 지급액</span>
                                        <div className="text-right">
                                            <span className="text-2xl font-bold text-emerald-600">{CURRENCY}{logs.finalAmount}</span>
                                            {logs.penaltyApplied > 0 && <div className="text-[10px] text-rose-500 font-bold">(-패널티 {CURRENCY}{logs.penaltyApplied})</div>}
                                        </div>
                                    </div>
                                )}
                                
                                {isTargetMismatch && (
                                    <div className="p-4 bg-rose-50 border border-rose-100 rounded-xl text-center">
                                        <p className="text-sm font-bold text-rose-600 mb-2">현장에서 바로 변경하시겠습니까?</p>
                                        <p className="text-xs text-rose-400 mb-3">주의: 이전 옵션에 대한 완료 기록이 있다면 삭제됩니다.</p>
                                        <button onClick={() => onForceUpdate(user, session, requiredChoice)} className="w-full py-3 bg-rose-500 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform text-sm">
                                            네, 일정 변경 후 승인
                                        </button>
                                    </div>
                                )}

                                {relatedLogs && relatedLogs.length > 0 && (
                                    <div className="mt-4 border-t border-slate-100 pt-4">
                                        <h4 className="text-xs font-bold text-slate-400 mb-2">오늘의 다른 활동 내역</h4>
                                        <div className="space-y-2">
                                            {relatedLogs.map((log, idx) => (
                                                <div key={idx} className="flex items-center justify-between text-xs p-2 bg-slate-50 rounded-lg">
                                                    <span className="text-slate-600 font-medium">{log.sessionTitle}</span>
                                                    <span className="text-emerald-600 font-bold">{log.action === '지급' ? '지급완료' : '탑승완료'}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        <button onClick={onClose} className="w-full py-5 bg-slate-900 text-white font-bold text-lg hover:bg-slate-800 transition-colors">닫기</button>
                    </div>
                </div>
            );
        };

        const SessionDetailModal = ({ session, users, logs, onClose, onManualComplete }) => {
            const [tab, setTab] = useState('done');
            
            const targetUsers = useMemo(() => {
                if (!session) return [];
                if (session.targetKey === 'ALL') return users;
                return users.filter(u => u.options && u.options[session.targetKey] && u.options[session.targetKey].includes(session.targetVal));
            }, [session, users]);

            const { doneList, yetList } = useMemo(() => {
                const doneIds = new Set(logs.filter(l => l.sessionId === session.id).map(l => l.uid));
                const done = [];
                const yet = [];
                targetUsers.forEach(u => {
                    if (doneIds.has(u.uid)) {
                        const log = logs.find(l => l.sessionId === session.id && l.uid === u.uid);
                        done.push({ ...u, log });
                    } else {
                        yet.push(u);
                    }
                });
                return { doneList: done, yetList: yet };
            }, [targetUsers, logs, session]);

            const currentList = tab === 'done' ? doneList : yetList;

            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-fade-in no-print" onClick={onClose}>
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50">
                            <div>
                                <span className={`inline-block px-2 py-1 rounded text-[10px] font-bold mb-1 ${session.type==='PAYMENT'?'bg-emerald-100 text-emerald-600':'bg-indigo-100 text-incar'}`}>{session.type==='PAYMENT'?'지급':'탑승'}</span>
                                <h3 className="font-bold text-lg text-slate-800 leading-tight">{session.title}</h3>
                                <p className="text-xs text-slate-500 mt-1">{session.displayDate} | 대상 {targetUsers.length}명</p>
                            </div>
                            <button onClick={onClose} className="p-2 text-slate-400 hover:text-slate-600"><Icon name="x" size={24}/></button>
                        </div>
                        
                        <div className="flex border-b border-slate-100">
                            <button onClick={()=>setTab('done')} className={`flex-1 py-4 text-sm font-bold transition-colors ${tab==='done'?'text-emerald-600 border-b-2 border-emerald-600 bg-emerald-50/50':'text-slate-400 hover:bg-slate-50'}`}>
                                완료 ({doneList.length})
                            </button>
                            <button onClick={()=>setTab('yet')} className={`flex-1 py-4 text-sm font-bold transition-colors ${tab==='yet'?'text-rose-500 border-b-2 border-rose-500 bg-rose-50/50':'text-slate-400 hover:bg-slate-50'}`}>
                                미완료 ({yetList.length})
                            </button>
                        </div>

                        <div className="overflow-y-auto flex-1 p-4 space-y-2">
                            {currentList.length === 0 ? (
                                <div className="py-10 text-center text-slate-400 text-sm">해당 인원이 없습니다.</div>
                            ) : (
                                currentList.map(u => (
                                    <div key={u.uid} className="flex justify-between items-center p-3 rounded-xl border border-slate-100 hover:border-slate-300 transition-colors">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white ${tab==='done'?'bg-emerald-500':'bg-slate-300'}`}>{u.name[0]}</div>
                                            <div>
                                                <div className="font-bold text-slate-800 text-sm">{u.name} <span className="text-xs font-normal text-slate-500">({u.options && (u.options['직책'] || u.org)})</span></div>
                                                <div className="text-[10px] text-slate-400 font-mono">{u.uid}</div>
                                            </div>
                                        </div>
                                        {tab === 'done' && u.log && (
                                            <div className="text-right">
                                                {session.type === 'PAYMENT' && (
                                                    <div className="font-bold text-emerald-600 text-sm">{CURRENCY}{u.log.finalAmount}</div>
                                                )}
                                                <div className="text-[10px] text-slate-400">{new Date(u.log.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                            </div>
                                        )}
                                        {tab === 'yet' && (
                                            <button onClick={() => onManualComplete(u, session)} className="px-3 py-1.5 bg-slate-800 text-white text-[10px] font-bold rounded-lg hover:bg-slate-700 transition-colors shadow-sm">
                                                수동 완료
                                            </button>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const QRCodeCanvas = ({ text, size = 100, transparent = false }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (canvasRef.current && window.QRious) {
                    new QRious({
                        element: canvasRef.current,
                        value: text,
                        size: size,
                        level: 'H',
                        background: transparent ? 'transparent' : 'white',
                        foreground: 'black'
                    });
                }
            }, [text, size, transparent]);
            return <canvas ref={canvasRef} />;
        };

        // ... (DashboardView, ScanView, ChangeView, ManageView components remain the same) ...
        const DashboardView = ({ users, logs, scheduleStats, groupedStats, changeLogs, onSessionClick }) => (
            <div className="space-y-6 animate-slide-up">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-incar">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Participants</div>
                        <div className="text-4xl font-bold text-slate-800">{users.length}</div>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-emerald-500">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Payout</div>
                        <div className="text-4xl font-bold text-slate-800">{CURRENCY}{logs.reduce((sum, l) => sum + (l.finalAmount||0), 0).toLocaleString()}</div>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-indigo-400 hidden md:block">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Completion Rate</div>
                        <div className="text-4xl font-bold text-slate-800">
                            {scheduleStats.length > 0 ? Math.round(scheduleStats.reduce((acc, s) => acc + s.percent, 0) / scheduleStats.length) : 0}%
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-rose-400 hidden md:block">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Penalties</div>
                        <div className="text-4xl font-bold text-slate-800">{changeLogs.length}건</div>
                    </div>
                </div>

                <div>
                    <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                        <Icon name="dashboard" className="text-incar"/> 일정별 진행률 (요약)
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {scheduleStats.map(stat => (
                            <div key={stat.id} onClick={() => onSessionClick(stat)} className="cursor-pointer bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-md transition-shadow active:scale-[0.98] transition-transform">
                                <div className="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><Icon name={stat.type === 'PAYMENT' ? 'money' : 'bus'} size={60} /></div>
                                <div className="relative z-10">
                                    <div className="flex justify-between items-start mb-2">
                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${stat.type==='PAYMENT'?'bg-emerald-100 text-emerald-600':'bg-indigo-50 text-incar'}`}>{stat.type==='PAYMENT'?'지급':'탑승'}</span>
                                        <span className="text-xs font-bold text-slate-400">{stat.displayDate}</span>
                                    </div>
                                    <h4 className="font-bold text-slate-800 mb-4 truncate pr-8">{stat.title}</h4>
                                    <div className="flex justify-between items-end mb-1">
                                        <span className="text-3xl font-bold text-slate-800">{stat.doneCount}<span className="text-sm text-slate-400 font-medium ml-1">/ {stat.targetCount}</span></span>
                                        <span className={`text-xl font-bold ${stat.percent === 100 ? 'text-emerald-500' : 'text-incar'}`}>{stat.percent}%</span>
                                    </div>
                                    <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden mb-2">
                                        <div className={`h-full rounded-full transition-all duration-1000 ${stat.percent===100?'bg-emerald-500':'bg-incar'}`} style={{width: `${stat.percent}%`}}></div>
                                    </div>
                                    {stat.type === 'PAYMENT' && (
                                        <div className="pt-2 border-t border-slate-50 flex justify-between text-xs">
                                            <span className="text-slate-400">집행액: <b>{CURRENCY}{stat.actualAmount.toLocaleString()}</b></span>
                                            <span className="text-slate-400">예상: {CURRENCY}{stat.expectedAmount.toLocaleString()}</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        {scheduleStats.length === 0 && <div className="col-span-full py-10 text-center text-slate-400 bg-white rounded-2xl border border-dashed border-slate-200">등록된 일정이 없습니다.</div>}
                    </div>
                </div>
                
                <div className="pc-only bg-white rounded-3xl border border-slate-200 shadow-card overflow-hidden mt-8">
                    <div className="p-5 border-b border-slate-100 bg-slate-50/50">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="table" className="text-incar"/> 상세 현황 분석표</h3>
                    </div>
                    {Object.entries(groupedStats).length === 0 ? <div className="p-10 text-center text-slate-400">데이터가 없습니다.</div> : (
                        <div className="p-6 space-y-8">
                            {Object.entries(groupedStats).sort().map(([date, stats]) => (
                                <div key={date}>
                                    <h4 className="text-xs font-bold text-incar bg-indigo-50 px-3 py-1.5 rounded-lg inline-block mb-3">{date}</h4>
                                    <div className="overflow-hidden rounded-xl border border-slate-200">
                                        <table className="w-full text-left data-table">
                                            <thead><tr><th className="w-1/3">일정명</th><th className="text-center">구분</th><th className="text-right">대상(Target)</th><th className="text-right">완료(Done)</th><th className="text-center border-l border-slate-200">미완료</th><th className="text-right">예상 금액</th><th className="text-right">실제 집행</th><th className="text-center border-l border-slate-200">차액 (Diff)</th></tr></thead>
                                            <tbody>
                                                {stats.map(s => (
                                                    <tr key={s.id} onClick={() => onSessionClick(s)} className="cursor-pointer hover:bg-slate-50 transition-colors">
                                                        <td className="font-bold text-slate-700">{s.title}</td>
                                                        <td className="text-center"><span className={`px-2 py-0.5 rounded text-[10px] font-bold border ${s.type==='PAYMENT'?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-indigo-50 text-incar border-indigo-100'}`}>{s.type==='PAYMENT'?'지급':'탑승'}</span></td>
                                                        <td className="text-right text-slate-500">{s.targetCount}</td>
                                                        <td className="text-right font-bold text-slate-900">{s.doneCount}</td>
                                                        <td className="text-center border-l border-slate-50">{s.targetCount - s.doneCount === 0 ? <span className="text-emerald-500 font-bold text-xs">Complete</span> : <span className="text-rose-500 font-bold text-xs">{s.targetCount - s.doneCount}명 남음</span>}</td>
                                                        <td className="text-right text-slate-400">{s.type==='PAYMENT'?`${CURRENCY}${s.expectedAmount.toLocaleString()}`:'-'}</td>
                                                        <td className="text-right font-bold text-emerald-600">{s.type==='PAYMENT'?`${CURRENCY}${s.actualAmount.toLocaleString()}`:'-'}</td>
                                                        <td className="text-center border-l border-slate-50">{s.type !== 'PAYMENT' ? '-' : (s.diffAmount === 0 ? <span className="text-emerald-500 font-bold text-xs">OK</span> : s.diffAmount < 0 ? <span className="text-rose-500 font-bold text-xs">{s.diffAmount}</span> : <span className="text-blue-500 font-bold text-xs">+{s.diffAmount}</span>)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );

        const ScanView = ({ mode, schedules, targetSessionId, setTargetSessionId, targetBus, setTargetBus, manualBus, setManualBus, isScanning, setIsScanning, processScan, users, isMobile }) => {
            const scannerRef = useRef(null);
            const isRunningRef = useRef(false);
            
            const filteredSchedules = useMemo(() => {
                return schedules.filter(s => s.type === mode);
            }, [schedules, mode]);

            useEffect(() => {
                if (filteredSchedules.length > 0) {
                    const exists = filteredSchedules.find(s => s.id === targetSessionId);
                    if (!exists) setTargetSessionId(filteredSchedules[0].id);
                } else {
                    setTargetSessionId('');
                }
            }, [mode, filteredSchedules]);

            useEffect(() => {
                return () => {
                    stopScanner();
                };
            }, []);

            const startScanner = () => {
                if (isRunningRef.current) return;
                setIsScanning(true);
                
                setTimeout(() => {
                    const element = document.getElementById("reader");
                    if (!element) return;

                    if (!scannerRef.current) {
                        scannerRef.current = new Html5Qrcode("reader");
                    }
                    const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
                    scannerRef.current.start({ facingMode: "environment" }, config, (decodedText) => {
                        stopScanner();
                        processScan(decodedText);
                    }, () => {}).then(() => {
                        isRunningRef.current = true;
                    }).catch(err => {
                        console.error("Camera start failed", err);
                        setIsScanning(false);
                        alert("카메라 시작 실패. 권한을 확인해주세요.");
                    });
                }, 100);
            };

            const stopScanner = () => {
                if (scannerRef.current && isRunningRef.current) {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current.clear();
                        isRunningRef.current = false;
                        setIsScanning(false);
                    }).catch(err => {
                        console.log("Failed to stop scanner", err);
                        setIsScanning(false);
                        isRunningRef.current = false;
                    });
                } else {
                    setIsScanning(false);
                }
            };

            return (
                <div className="space-y-6 h-full flex flex-col animate-slide-up">
                    <div className="bg-white p-6 rounded-3xl shadow-card border border-slate-200">
                        <div className="flex items-center gap-2 mb-4">
                            <span className={`px-2 py-1 rounded-lg text-xs font-bold ${mode==='BOARDING'?'bg-incar text-white':'bg-emerald-500 text-white'}`}>{mode==='BOARDING' ? 'STEP 1' : '지급'}</span>
                            <h3 className="text-lg font-bold text-slate-800">{mode==='BOARDING' ? '탑승 일정 선택' : '지급 항목 선택'}</h3>
                        </div>
                        <div className="mb-6">
                            <select value={targetSessionId} onChange={(e) => setTargetSessionId(e.target.value)} className={`w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-lg outline-none focus:ring-4 transition-all ${mode==='BOARDING'?'focus:ring-incar/20':'focus:ring-emerald-500/20'}`}>
                                {filteredSchedules.length === 0 && <option>해당하는 일정이 없습니다</option>}
                                {filteredSchedules.map(s => <option key={s.id} value={s.id}>[{s.displayDate}] {s.title}</option>)}
                            </select>
                        </div>
                        {mode === 'BOARDING' && (
                            <div className="animate-slide-up">
                                <div className="flex items-center gap-2 mb-3">
                                    <span className="px-2 py-1 rounded-lg text-xs font-bold bg-slate-800 text-white">STEP 2</span>
                                    <div className="flex justify-between items-center flex-1">
                                        <h3 className="text-lg font-bold text-slate-800">차량 번호 선택</h3>
                                        <button onClick={()=>setManualBus(!manualBus)} className="text-xs font-bold text-slate-400 underline decoration-slate-300">{manualBus ? '목록에서 선택' : '직접 입력'}</button>
                                    </div>
                                </div>
                                {manualBus ? 
                                    <input type="text" value={targetBus} onChange={e=>setTargetBus(e.target.value)} className="w-full p-4 bg-white border-2 border-slate-200 rounded-2xl font-bold text-center text-lg focus:border-incar outline-none" placeholder="차량 번호 입력" /> :
                                    <div className="grid grid-cols-4 gap-2">
                                        {[1,2,3,4,5,6,7,8,9,10,11,12].map(n => (
                                            <button key={n} onClick={()=>setTargetBus(`${n}호차`)} className={`py-3 rounded-xl text-sm font-bold transition-all ${targetBus===`${n}호차`?'bg-incar text-white shadow-lg scale-105':'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>{n}호차</button>
                                        ))}
                                    </div>
                                }
                            </div>
                        )}
                    </div>

                    <div className="flex-1 flex flex-col justify-end">
                        <button onClick={startScanner} className={`w-full py-6 text-white rounded-3xl font-bold text-xl shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-transform ${mode==='BOARDING'?'bg-incar shadow-incar/30':'bg-emerald-500 shadow-emerald-500/30'}`}>
                            <Icon name="qr" size={28}/> {mode==='BOARDING' ? '탑승 스캔 시작' : '지급 스캔 시작'}
                        </button>
                        {!isMobile && users.length > 0 && <button onClick={()=>processScan(users[0].uid)} className="mt-4 text-xs text-slate-400 underline text-center">테스트: 첫번째 유저 강제 인식</button>}
                    </div>

                    {isScanning && (
                        <div className="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-6 animate-fade-in" style={{ touchAction: 'none' }}>
                            <button onClick={stopScanner} className="absolute top-8 right-8 text-white p-3 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-[101]">
                                <Icon name="x" size={32} />
                            </button>
                            
                            <div className="relative w-full max-w-sm aspect-square bg-black rounded-3xl overflow-hidden shadow-2xl border border-white/20">
                                <div id="reader" className="w-full h-full object-cover"></div>
                                <div className={`scan-line ${mode==='BOARDING'?'bg-incar':'bg-emerald-500'}`}></div>
                                <div className="absolute inset-0 border-2 border-white/30 rounded-3xl pointer-events-none"></div>
                                <div className="absolute top-0 left-0 w-16 h-16 border-t-4 border-l-4 border-white rounded-tl-3xl pointer-events-none"></div>
                                <div className="absolute top-0 right-0 w-16 h-16 border-t-4 border-r-4 border-white rounded-tr-3xl pointer-events-none"></div>
                                <div className="absolute bottom-0 left-0 w-16 h-16 border-b-4 border-l-4 border-white rounded-bl-3xl pointer-events-none"></div>
                                <div className="absolute bottom-0 right-0 w-16 h-16 border-b-4 border-r-4 border-white rounded-br-3xl pointer-events-none"></div>
                            </div>
                            
                            <p className="text-white mt-10 font-bold text-xl animate-pulse text-center">
                                QR코드를 사각형 안에 비춰주세요
                            </p>
                            
                            <div className="mt-8 flex gap-4">
                                <button onClick={stopScanner} className="px-8 py-3 bg-white text-slate-900 rounded-xl font-bold text-sm hover:bg-slate-200 transition-colors">닫기</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ChangeView = ({ searchQuery, setSearchQuery, selectedUser, setSelectedUser, editForm, setEditForm, handleUserUpdate, users, schedules }) => {
            const [manualInput, setManualInput] = useState(false);

            // [추가] 선택된 유저의 여행 일정 필터링 및 정렬
            const userSchedules = useMemo(() => {
                if (!selectedUser || !schedules) return [];
                return schedules.filter(s => {
                    if (s.targetKey === 'ALL') return true;
                    // 유저 옵션 확인 (Target Key가 유저 옵션에 있고, Target Value가 포함되어 있는지)
                    const userOpt = selectedUser.options?.[s.targetKey];
                    if (!userOpt) return false;
                    return s.targetVal === 'ALL' || userOpt.includes(s.targetVal);
                }).sort((a,b) => a.date > b.date ? 1 : -1);
            }, [selectedUser, schedules]);

            const uniqueValues = useMemo(() => {
                if (!editForm.optKey) return [];
                const values = new Set();
                
                if (users) {
                    users.forEach(u => {
                        if (u.options && u.options[editForm.optKey]) {
                            values.add(u.options[editForm.optKey]);
                        }
                    });
                }

                if (schedules) {
                    schedules.forEach(s => {
                        if (s.targetKey === editForm.optKey && s.targetVal !== 'ALL') {
                            values.add(s.targetVal);
                        }
                    });
                }

                return Array.from(values).sort();
            }, [editForm.optKey, users, schedules]);

            useEffect(() => {
                if (!selectedUser || !editForm.optKey || !editForm.optVal || !schedules) return;

                const oldVal = selectedUser.options[editForm.optKey];
                const newVal = editForm.optVal;

                if (oldVal === newVal) return;

                const getPriceForOption = (val) => {
                    return schedules
                        .filter(s => s.targetKey === editForm.optKey && s.targetVal === val && s.type === 'PAYMENT')
                        .reduce((sum, s) => sum + (s.price || 0), 0);
                };

                const oldPrice = getPriceForOption(oldVal);
                const newPrice = getPriceForOption(newVal);
                const diff = oldPrice - newPrice;

                if (diff > 0) {
                    setEditForm(prev => ({
                        ...prev,
                        penalty: diff,
                        reason: `일정 변경 차액 (${oldVal}: ${CURRENCY}${oldPrice} -> ${newVal}: ${CURRENCY}${newPrice})`
                    }));
                }
            }, [editForm.optVal, editForm.optKey, selectedUser, schedules]);

            return (
                <div className="space-y-6 animate-slide-up">
                    <div className="bg-white p-6 rounded-3xl shadow-card">
                        <h3 className="font-bold text-lg mb-4 text-slate-800">참가자 일정 변경 및 패널티 관리</h3>
                        <div className="flex flex-col md:flex-row gap-2 mb-6">
                            <input type="text" value={searchQuery} onChange={(e)=>setSearchQuery(e.target.value)} placeholder="사번 또는 이름 검색" className="flex-1 p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold outline-none focus:border-incar" />
                            <button onClick={()=>{
                                const found = users.find(u => u.uid.includes(searchQuery) || u.name.includes(searchQuery));
                                if(found) setSelectedUser(found); else alert("사용자를 찾을 수 없습니다.");
                            }} className="w-full md:w-auto bg-slate-800 text-white px-6 py-4 md:py-0 rounded-2xl font-bold">검색</button>
                        </div>
                        {selectedUser && (
                            <div className="border-t border-slate-100 pt-6 space-y-4">
                                <div className="flex flex-col md:flex-row gap-6 mb-6">
                                    <div className="flex-1 bg-slate-50 p-5 rounded-2xl border border-slate-100 flex flex-col justify-center">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <div className="font-black text-2xl text-slate-800">{selectedUser.name}</div>
                                                <div className="text-sm font-bold text-slate-500">{selectedUser.org}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-[10px] font-bold text-slate-400 uppercase">사번(ID)</div>
                                                <div className="font-mono font-bold text-incar">{selectedUser.uid}</div>
                                            </div>
                                        </div>
                                        <div className="mt-4 pt-4 border-t border-slate-200/50 flex justify-between items-center">
                                            <span className="text-xs font-bold text-slate-400">누적 패널티</span>
                                            <span className="font-black text-rose-500 text-lg">-{CURRENCY}{selectedUser.penaltyTotal || 0}</span>
                                        </div>
                                    </div>
                                    <div className="bg-white border-2 border-dashed border-slate-200 rounded-2xl p-4 flex flex-col items-center justify-center text-center w-full md:w-auto">
                                        <div className="mb-2 w-32 h-32 flex items-center justify-center bg-slate-50">
                                            <QRCodeCanvas text={selectedUser.uid} />
                                        </div>
                                        <p className="text-[10px] font-bold text-slate-400">QR 데이터: {selectedUser.uid}</p>
                                    </div>
                                </div>

                                {/* [추가] 해당 인원의 여행 일정 리스트 */}
                                <div className="bg-indigo-50 border border-indigo-100 rounded-2xl p-5 mb-4">
                                    <h4 className="font-bold text-incar mb-3 flex items-center gap-2"><Icon name="dashboard" size={16}/> {selectedUser.name}님의 전체 여행 일정</h4>
                                    {userSchedules.length === 0 ? (
                                        <div className="text-center text-slate-400 text-xs py-4">배정된 일정이 없습니다.</div>
                                    ) : (
                                        <div className="max-h-60 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                                            {userSchedules.map((s, idx) => (
                                                <div key={idx} className="bg-white p-3 rounded-xl border border-indigo-100 shadow-sm flex justify-between items-center">
                                                    <div>
                                                        <span className="text-[10px] font-bold text-slate-400 block">{s.displayDate}</span>
                                                        <span className="font-bold text-slate-800">{s.title}</span>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold ${s.type==='PAYMENT'?'bg-emerald-100 text-emerald-600':'bg-slate-100 text-slate-500'}`}>
                                                            {s.type==='PAYMENT' ? `지급 ${CURRENCY}${s.price}` : '탑승'}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-bold text-slate-400 mb-1">변경할 옵션 (Key)</label><select value={editForm.optKey} onChange={e=>setEditForm({...editForm, optKey: e.target.value})} className="w-full p-3 border rounded-xl font-bold text-sm bg-white"><option value="">선택하세요</option>{Object.keys(selectedUser.options).map(key => <option key={key} value={key}>{key} (현재: {selectedUser.options[key]})</option>)}</select></div>
                                    
                                    <div>
                                        <div className="flex justify-between items-center mb-1">
                                            <label className="block text-xs font-bold text-slate-400">변경값 (New)</label>
                                            <button onClick={()=>setManualInput(!manualInput)} className="text-[10px] text-incar underline font-bold">{manualInput ? '목록에서 선택' : '직접 입력'}</button>
                                        </div>
                                        {manualInput ? (
                                            <input type="text" value={editForm.optVal} onChange={e=>setEditForm({...editForm, optVal: e.target.value})} className="w-full p-3 border rounded-xl font-bold text-sm bg-white" placeholder="직접 입력하세요" />
                                        ) : (
                                            <select value={editForm.optVal} onChange={e=>setEditForm({...editForm, optVal: e.target.value})} className="w-full p-3 border rounded-xl font-bold text-sm bg-white">
                                                <option value="">선택하세요</option>
                                                {uniqueValues.map(val => (
                                                    <option key={val} value={val}>{val}</option>
                                                ))}
                                                <option value="직접입력">[목록에 없음]</option>
                                            </select>
                                        )}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-1">패널티 ({CURRENCY})</label>
                                    <input type="number" value={editForm.penalty} onChange={e=>setEditForm({...editForm, penalty: e.target.value})} className="w-full p-3 border border-rose-200 bg-rose-50 rounded-xl font-bold text-rose-600" />
                                    <p className="text-[10px] text-slate-400 mt-1">* 기존 일정보다 저렴한 일정으로 변경 시 차액이 자동 계산됩니다.</p>
                                </div>
                                <div><label className="block text-xs font-bold text-slate-400 mb-1">변경 사유</label><input type="text" value={editForm.reason} onChange={e=>setEditForm({...editForm, reason: e.target.value})} className="w-full p-3 border rounded-xl font-bold text-sm" /></div>
                                <button onClick={handleUserUpdate} className="w-full py-4 bg-incar text-white font-bold rounded-2xl shadow-lg mt-4 hover:bg-incar-dark">저장하기</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const BadgePrintView = ({ users, onClose, config }) => (
            <div className="fixed inset-0 bg-white z-[100] overflow-auto animate-fade-in print-only-container">
                <div className="no-print fixed top-0 left-0 w-full bg-slate-900 text-white p-4 flex justify-between items-center shadow-xl z-50">
                    <div className="font-bold text-lg flex items-center gap-4">
                        <span className="bg-incar px-2 py-1 rounded text-xs">PRINT MODE</span> 
                        <span>명찰 일괄 출력 (총 {users.length}명)</span>
                    </div>
                    <div className="flex gap-3">
                        <button onClick={() => window.print()} className="bg-emerald-500 hover:bg-emerald-600 px-6 py-2 rounded-lg font-bold flex items-center gap-2">
                            <Icon name="print" /> 인쇄 / PDF저장
                        </button>
                        <button onClick={onClose} className="bg-slate-700 hover:bg-slate-600 px-6 py-2 rounded-lg font-bold">닫기</button>
                    </div>
                </div>
                
                <div className="print-reset-spacing p-8 pt-24 w-full min-h-screen bg-slate-100 flex flex-col items-center gap-8 print:bg-white">
                    {users.map((u, i) => (
                        <div key={u.uid} className="page-wrapper relative">
                            <div className="badge-card relative overflow-hidden bg-white shadow-lg" 
                                    style={{
                                        width: '545px',
                                        height: '697px',
                                        border: config?.bgImage ? 'none' : '2px solid #0f172a',
                                        borderRadius: '0', 
                                        flexShrink: 0
                                    }}>
                                {config && config.bgImage ? (
                                    <>
                                        <img src={config.bgImage} className="absolute inset-0 w-full h-full object-cover z-0" />
                                        
                                        <div style={{ position: 'absolute', top: `${config.qr.y}%`, left: `${config.qr.x}%`, transform: 'translate(-50%, -50%)', zIndex: 10 }}>
                                            <QRCodeCanvas text={u.uid} size={config.qr.size} transparent={true} />
                                        </div>
                                        
                                        {config.org.show && (
                                            <div className={`${config.org.font || 'font-sans'}`} 
                                                 style={{ 
                                                    position: 'absolute', top: `${config.org.y}%`, left: `${config.org.x}%`, transform: 'translate(-50%, -50%)', 
                                                    color: config.org.color, fontSize: `${config.org.size}px`, fontWeight: 'bold', whiteSpace: 'nowrap', zIndex: 10,
                                                    textShadow: config.org.shadow ? '2px 2px 4px rgba(0,0,0,0.5)' : 'none',
                                                    backgroundColor: config.org.bgColor || 'transparent',
                                                    padding: config.org.padding ? `${config.org.padding}px` : '0',
                                                    borderRadius: config.org.borderRadius ? `${config.org.borderRadius}px` : '0',
                                                    width: config.org.width ? `${config.org.width}px` : 'auto',
                                                    textAlign: config.org.textAlign || 'center',
                                                    overflow: 'hidden'
                                                }}>
                                                {u.org}
                                            </div>
                                        )}
                                        
                                        {config.name.show && (
                                            <div className={`${config.name.font || 'font-sans'}`}
                                                 style={{ 
                                                    position: 'absolute', top: `${config.name.y}%`, left: `${config.name.x}%`, transform: 'translate(-50%, -50%)', 
                                                    color: config.name.color, fontSize: `${config.name.size}px`, fontWeight: '900', whiteSpace: 'nowrap', zIndex: 10,
                                                    textShadow: config.name.shadow ? '2px 2px 4px rgba(0,0,0,0.5)' : 'none',
                                                    backgroundColor: config.name.bgColor || 'transparent',
                                                    padding: config.name.padding ? `${config.name.padding}px` : '0',
                                                    borderRadius: config.name.borderRadius ? `${config.name.borderRadius}px` : '0',
                                                    width: config.name.width ? `${config.name.width}px` : 'auto',
                                                    textAlign: config.name.textAlign || 'center',
                                                    overflow: 'hidden'
                                                }}>
                                                {u.name}
                                            </div>
                                        )}

                                        {config.role.show && (
                                            <div className={`${config.role.font || 'font-sans'}`}
                                                 style={{ 
                                                    position: 'absolute', top: `${config.role.y}%`, left: `${config.role.x}%`, transform: 'translate(-50%, -50%)', 
                                                    color: config.role.color, fontSize: `${config.role.size}px`, whiteSpace: 'nowrap', zIndex: 10,
                                                    textShadow: config.role.shadow ? '2px 2px 4px rgba(0,0,0,0.5)' : 'none',
                                                    backgroundColor: config.role.bgColor || 'transparent',
                                                    padding: config.role.padding ? `${config.role.padding}px` : '0',
                                                    borderRadius: config.role.borderRadius ? `${config.role.borderRadius}px` : '0',
                                                    width: config.role.width ? `${config.role.width}px` : 'auto',
                                                    textAlign: config.role.textAlign || 'center',
                                                    overflow: 'hidden'
                                                }}>
                                                {u.options && (u.options['직책'] || u.options['Role'] || u.options['Job'] || '-')}
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-full p-6 text-center border-2 border-slate-900 m-4">
                                        <div className="w-40 h-40 bg-white mb-6">
                                            <QRCodeCanvas text={u.uid} size={160} />
                                        </div>
                                        <div className="overflow-hidden w-full space-y-2">
                                            <div className="text-2xl font-bold text-slate-500 truncate">{u.org}</div>
                                            <div className="text-6xl font-black text-slate-900 truncate leading-tight">{u.name}</div>
                                            <div className="text-xl font-bold text-slate-400 mt-2">{u.options && (u.options['직책'] || u.options['Role'])}</div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const ManageView = ({ users, handleUserUpload, handleScheduleUpload, badgeConfig, setBadgeConfig, db, serverError, schedules, logs, setIsPrintMode, setUsers, setSchedules, setLogs, setChangeLogs }) => {
            const handleBgImageUpload = (e) => {
                const file = e.target.files[0];
                if(file){
                    const reader = new FileReader();
                    reader.onload = (evt) => setBadgeConfig(prev => ({...prev, bgImage: evt.target.result}));
                    reader.readAsDataURL(file);
                }
            };

            const downloadTemplate = (type) => {
                let content = '';
                let filename = '';
                if(type === 'users') {
                    content = '\uFEFF사번,성명,소속,직책,버스,2일차,3일차\n202401,홍길동,마케팅팀,대리,1호차,힐링코스,투어\n202402,김철수,영업팀,과장,미정,문화탐방,자유일정';
                    filename = '참가자명단_샘플.csv';
                } else {
                    content = '\uFEFF일정,장소,타입,지급,타겟옵션,타겟값\n1일차,공항미팅,관광,0,ALL,ALL\n2일차,자유식비,지급,30,2일차,자유일정\n2일차,힐링코스탑승,관광,0,2일차,힐링코스';
                    filename = '일정정보_샘플.csv';
                }
                const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            };

            const exportAllData = () => {
                if(logs.length === 0) return alert("내보낼 데이터가 없습니다.");
                
                const headers = ['스캔일시', '사번', '성명', '소속', '구분', '일정명', '탑승차량', '금액', '최종지급액', '패널티적용'];
                
                let tableRows = '';
                logs.forEach(l => {
                    tableRows += `
                        <tr>
                            <td>${l.timestamp ? new Date(l.timestamp).toLocaleString() : ''}</td>
                            <td style="mso-number-format:'@'">${l.uid}</td>
                            <td>${l.name}</td>
                            <td>${l.org}</td>
                            <td>${l.action}</td>
                            <td>${l.sessionTitle}</td>
                            <td>${l.bus}</td>
                            <td>${l.amount}</td>
                            <td>${l.finalAmount || l.amount}</td>
                            <td>${l.penaltyApplied > 0 ? 'Y' : 'N'}</td>
                        </tr>
                    `;
                });

                const excelHTML = `
                    <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                    <head>
                        <meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">
                        <style>
                            body { font-family: 'Malgun Gothic', '맑은 고딕', sans-serif; }
                            table { border-collapse: collapse; width: 100%; }
                            th { 
                                background-color: #f2f2f2; 
                                color: #333333;
                                border: 1px solid #d1d5db; 
                                padding: 10px; 
                                text-align: center; 
                                font-weight: bold;
                            }
                            td { 
                                border: 1px solid #d1d5db; 
                                padding: 8px; 
                                text-align: center;
                            }
                        </style>
                    </head>
                    <body>
                        <table>
                            <thead>
                                <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </body>
                    </html>
                `;

                const blob = new Blob([excelHTML], { type: 'application/vnd.ms-excel' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `INCARPASS_FULL_DATA_${new Date().toISOString().slice(0,10)}.xls`;
                link.click();
            };

            const handleFullReset = async () => {
                if(!confirm("⚠️ 경고: 모든 데이터가 영구적으로 삭제됩니다.\n\n로컬 스토리지와 파이어베이스의 모든 데이터(참가자, 일정, 로그 등)가 초기화됩니다. 정말 진행하시겠습니까?")) return;

                const SYSTEM_APP_ID = 'inca-prod-v1';
                
                try {
                    if (db) {
                        const collections = ['users', 'schedules', 'logs', 'changelogs'];
                        for (const colName of collections) {
                            const ref = db.collection('artifacts').doc(SYSTEM_APP_ID).collection(colName);
                            const snapshot = await ref.get();
                            
                            if (!snapshot.empty) {
                                const batch = db.batch();
                                snapshot.docs.forEach((doc) => {
                                    batch.delete(doc.ref);
                                });
                                await batch.commit();
                            }
                        }
                    }
                    
                    // 로컬스토리지 삭제
                    localStorage.removeItem('incar_pro_users');
                    localStorage.removeItem('incar_pro_schedules');
                    localStorage.removeItem('incar_pro_logs');
                    localStorage.removeItem('incar_pro_changelogs');
                    localStorage.removeItem('incar_pro_badge_config_v2_9');

                    alert("모든 데이터가 삭제되었습니다. 화면을 초기화합니다.");
                    
                    // 강제 리로드 시도
                    window.location.reload();

                    // 리로드가 차단될 경우를 대비해 수동으로 상태 초기화
                    setTimeout(() => {
                        setUsers([]);
                        setSchedules([]);
                        setLogs([]);
                        setChangeLogs([]);
                        setBadgeConfig({
                            bgImage: null,
                            qr: { x: 50, y: 20, size: 100 },
                            name: { x: 50, y: 65, size: 40, color: '#000000', show: true, font: 'font-noto', shadow: false, bgColor: 'transparent', borderRadius: 0, padding: 0, width: 0, textAlign: 'center' },
                            org: { x: 50, y: 40, size: 20, color: '#475569', show: true, font: 'font-noto', shadow: false, bgColor: 'transparent', borderRadius: 0, padding: 0, width: 0, textAlign: 'center' },
                            role: { x: 50, y: 50, size: 18, color: '#000000', show: true, font: 'font-noto', shadow: false, bgColor: 'transparent', borderRadius: 0, padding: 0, width: 0, textAlign: 'center' },
                            uid: { x: 50, y: 85, size: 14, color: '#94a3b8', show: false } 
                        });
                    }, 500);

                } catch (e) {
                    console.error("Reset Error", e);
                    alert("초기화 중 오류가 발생했습니다: " + e.message);
                }
            };

            const TextControl = ({ label, conf, onChange }) => (
                <div className="p-4 bg-slate-50 rounded-xl space-y-3 border border-slate-100">
                    <div className="flex justify-between items-center">
                        <span className="text-xs font-bold text-slate-700">{label}</span>
                        {conf.hasOwnProperty('show') && (
                            <label className="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" checked={conf.show} onChange={e => onChange('show', e.target.checked)} className="w-3 h-3 rounded text-incar focus:ring-incar"/>
                                <span className="text-[10px] text-slate-400">표시</span>
                            </label>
                        )}
                    </div>
                    <div className="grid grid-cols-1 gap-2">
                        <div className="flex gap-2 items-center">
                            <span className="w-8 text-[10px] text-slate-400 font-bold">폰트</span>
                            <select value={conf.font} onChange={e=>onChange('font', e.target.value)} className="flex-1 text-[10px] p-1 border rounded bg-white">
                                <option value="font-noto">기본 고딕 (Noto Sans)</option>
                                <option value="font-serif">명조체 (Nanum Myeongjo)</option>
                                <option value="font-black-han">제목용 굵은 고딕 (Black Han Sans)</option>
                                <option value="font-dohyeon">도현체 (Do Hyeon)</option>
                                <option value="font-brush">손글씨 (Brush Script)</option>
                                <option value="font-gugi">구기체 (Retro)</option>
                                <option value="font-gamja">감자꽃 (Cute)</option>
                                <option value="font-melody">하이멜로디 (Hand)</option>
                                <option value="font-sunflower">해바라기 (Clean)</option>
                                <option value="font-gowun">고운돋움 (Soft)</option>
                            </select>
                        </div>
                        
                        <div className="flex gap-2 items-center"><span className="w-8 text-[10px] text-slate-400 font-bold">가로(X)</span><input type="range" min="0" max="100" step="0.5" value={conf.x} onChange={e=>onChange('x', e.target.value)} className="flex-1 accent-incar h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"/></div>
                        <div className="flex gap-2 items-center"><span className="w-8 text-[10px] text-slate-400 font-bold">세로(Y)</span><input type="range" min="0" max="100" step="0.5" value={conf.y} onChange={e=>onChange('y', e.target.value)} className="flex-1 accent-incar h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"/></div>
                        <div className="flex gap-2 items-center"><span className="w-8 text-[10px] text-slate-400 font-bold">크기</span><input type="range" min="10" max={100} value={conf.size} onChange={e=>onChange('size', e.target.value)} className="flex-1 accent-incar h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"/></div>
                        
                        {/* [추가] 너비 및 정렬 컨트롤 */}
                        <div className="flex gap-2 items-center border-t border-slate-200 pt-2 mt-1">
                            <span className="w-8 text-[10px] text-slate-400 font-bold">너비</span>
                            <input type="range" min="0" max="545" step="5" value={conf.width || 0} onChange={e=>onChange('width', Number(e.target.value))} className="flex-1 accent-incar h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"/>
                            <span className="text-[9px] w-6 text-right text-slate-400">{conf.width > 0 ? conf.width : 'Auto'}</span>
                        </div>
                         <div className="flex gap-2 items-center">
                            <span className="w-8 text-[10px] text-slate-400 font-bold">정렬</span>
                            <div className="flex flex-1 bg-slate-100 rounded p-0.5">
                                {['left', 'center', 'right'].map(align => (
                                    <button 
                                        key={align}
                                        onClick={() => onChange('textAlign', align)}
                                        className={`flex-1 text-[9px] py-0.5 rounded ${conf.textAlign === align ? 'bg-white shadow text-incar font-bold' : 'text-slate-400'}`}
                                    >
                                        {align.toUpperCase()[0]}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="flex gap-2 justify-between items-center border-t border-slate-200 pt-2">
                            <span className="text-[10px] font-bold text-slate-500">스타일</span>
                            <div className="flex gap-2 items-center">
                                <span className="text-[9px] text-slate-400">색상</span>
                                <input type="color" value={conf.color} onChange={e=>onChange('color', e.target.value)} className="w-6 h-6 rounded cursor-pointer border border-slate-200"/>
                            </div>
                            <label className="flex items-center gap-1 cursor-pointer">
                                <span className="text-[9px] text-slate-400">그림자</span>
                                <input type="checkbox" checked={conf.shadow} onChange={e => onChange('shadow', e.target.checked)} className="w-3 h-3 rounded text-incar focus:ring-incar"/>
                            </label>
                        </div>

                        <div className="flex gap-2 justify-between items-center border-t border-slate-200 pt-2">
                            <span className="text-[10px] font-bold text-slate-500">박스</span>
                            <div className="flex gap-2 items-center">
                                <span className="text-[9px] text-slate-400">배경</span>
                                <input type="color" value={conf.bgColor || '#ffffff'} onChange={e=>onChange('bgColor', e.target.value)} className="w-6 h-6 rounded cursor-pointer border border-slate-200"/>
                            </div>
                            <div className="flex gap-1 items-center">
                                <span className="text-[9px] text-slate-400">R</span>
                                <input type="number" min="0" max="50" value={conf.borderRadius || 0} onChange={e=>onChange('borderRadius', e.target.value)} className="w-8 h-6 text-[10px] text-center border rounded"/>
                            </div>
                            <div className="flex gap-1 items-center">
                                <span className="text-[9px] text-slate-400">P</span>
                                <input type="number" min="0" max="50" value={conf.padding || 0} onChange={e=>onChange('padding', e.target.value)} className="w-8 h-6 text-[10px] text-center border rounded"/>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const QrControl = ({ label, conf, onChange }) => (
                <div className="p-4 bg-slate-50 rounded-xl space-y-3 border border-slate-100">
                    <div className="flex justify-between items-center"><span className="text-xs font-bold text-slate-700">{label}</span></div>
                    <div className="flex gap-2 items-center"><span className="w-6 text-[10px] text-slate-400 font-bold">가로</span><input type="range" min="0" max="100" step="0.5" value={conf.x} onChange={e=>onChange('x', e.target.value)} className="flex-1 accent-incar h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"/></div>
                    <div className="flex gap-2 items-center"><span className="w-6 text-[10px] text-slate-400 font-bold">세로</span><input type="range" min="0" max="100" step="0.5" value={conf.y} onChange={e=>onChange('y', e.target.value)} className="flex-1 accent-incar h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"/></div>
                    <div className="flex gap-2 items-center"><span className="w-6 text-[10px] text-slate-400 font-bold">크기</span><input type="range" min="50" max="250" value={conf.size} onChange={e=>onChange('size', e.target.value)} className="flex-1 accent-incar h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"/></div>
                </div>
            );

            return (
                <div className="space-y-6 animate-slide-up no-print">
                    <div className="bg-slate-800 text-white p-6 rounded-3xl shadow-card">
                        <div className="flex justify-between items-center">
                            <div>
                                <h3 className="font-bold text-lg flex items-center gap-2">
                                    <div className={`w-3 h-3 rounded-full ${db ? 'bg-emerald-400 animate-pulse' : 'bg-rose-400'}`}></div> 
                                    {db ? '서버 연결 정상' : '로컬 모드 (서버 미연결)'}
                                </h3>
                                <p className="text-xs text-slate-400 mt-1">
                                    {db ? '모든 데이터가 클라우드에 실시간으로 저장됩니다.' : 
                                            serverError ? `오류: ${serverError}` : '현재 기기에만 데이터가 저장됩니다. (공유 불가)'}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-3xl shadow-card border border-slate-200">
                        <h3 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2"><Icon name="edit" className="text-incar"/> 명찰 디자인 설정</h3>
                        <div className="flex flex-col md:flex-row gap-8 items-start">
                            <div className="flex-none bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 p-4 flex justify-center">
                                <div className="relative overflow-hidden shadow-2xl bg-white" 
                                            style={{ width: '545px', height: '697px', borderRadius: '10px' }}>
                                    {/* [추가] 중심선 가이드 */}
                                    <div className="absolute top-0 bottom-0 left-1/2 border-l border-red-400 border-dashed opacity-30 z-20 pointer-events-none"></div>
                                    <div className="absolute left-0 right-0 top-1/2 border-t border-red-400 border-dashed opacity-30 z-20 pointer-events-none"></div>

                                    {badgeConfig.bgImage ? (
                                        <>
                                            <img src={badgeConfig.bgImage} className="absolute inset-0 w-full h-full object-cover" />
                                            <div style={{ position: 'absolute', top: `${badgeConfig.qr.y}%`, left: `${badgeConfig.qr.x}%`, width: `${badgeConfig.qr.size}px`, height: `${badgeConfig.qr.size}px`, transform: 'translate(-50%, -50%)', border: '2px dashed red', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '10px', color: 'red', fontWeight: 'bold' }}>QR</div>
                                            
                                            {badgeConfig.org.show && (
                                                <div className={badgeConfig.org.font} 
                                                     style={{ position: 'absolute', top: `${badgeConfig.org.y}%`, left: `${badgeConfig.org.x}%`, transform: 'translate(-50%, -50%)', 
                                                             color: badgeConfig.org.color, fontSize: `${badgeConfig.org.size}px`, fontWeight: 'bold', border: '1px dashed blue', whiteSpace: 'nowrap',
                                                             textShadow: badgeConfig.org.shadow ? '2px 2px 4px rgba(0,0,0,0.5)' : 'none',
                                                             backgroundColor: badgeConfig.org.bgColor || 'transparent',
                                                             padding: badgeConfig.org.padding ? `${badgeConfig.org.padding}px` : '0',
                                                             borderRadius: badgeConfig.org.borderRadius ? `${badgeConfig.org.borderRadius}px` : '0',
                                                             width: badgeConfig.org.width ? `${badgeConfig.org.width}px` : 'auto',
                                                             textAlign: badgeConfig.org.textAlign || 'center',
                                                             overflow: 'hidden'
                                                        }}>
                                                    소속 (Organization)
                                                </div>
                                            )}
                                            
                                            {badgeConfig.name.show && (
                                                <div className={badgeConfig.name.font}
                                                     style={{ position: 'absolute', top: `${badgeConfig.name.y}%`, left: `${badgeConfig.name.x}%`, transform: 'translate(-50%, -50%)', 
                                                             color: badgeConfig.name.color, fontSize: `${badgeConfig.name.size}px`, fontWeight: '900', border: '1px dashed blue', whiteSpace: 'nowrap',
                                                             textShadow: badgeConfig.name.shadow ? '2px 2px 4px rgba(0,0,0,0.5)' : 'none',
                                                             backgroundColor: badgeConfig.name.bgColor || 'transparent',
                                                             padding: badgeConfig.name.padding ? `${badgeConfig.name.padding}px` : '0',
                                                             borderRadius: badgeConfig.name.borderRadius ? `${badgeConfig.name.borderRadius}px` : '0',
                                                             width: badgeConfig.name.width ? `${badgeConfig.name.width}px` : 'auto',
                                                             textAlign: badgeConfig.name.textAlign || 'center',
                                                             overflow: 'hidden'
                                                        }}>
                                                    성 명 (Name)
                                                </div>
                                            )}
                                            
                                            {badgeConfig.role.show && (
                                                <div className={badgeConfig.role.font}
                                                     style={{ position: 'absolute', top: `${badgeConfig.role.y}%`, left: `${badgeConfig.role.x}%`, transform: 'translate(-50%, -50%)', 
                                                             color: badgeConfig.role.color, fontSize: `${badgeConfig.role.size}px`, border: '1px dashed blue', whiteSpace: 'nowrap',
                                                             textShadow: badgeConfig.role.shadow ? '2px 2px 4px rgba(0,0,0,0.5)' : 'none',
                                                             backgroundColor: badgeConfig.role.bgColor || 'transparent',
                                                             padding: badgeConfig.role.padding ? `${badgeConfig.role.padding}px` : '0',
                                                             borderRadius: badgeConfig.role.borderRadius ? `${badgeConfig.role.borderRadius}px` : '0',
                                                             width: badgeConfig.role.width ? `${config.role.width}px` : 'auto',
                                                             textAlign: badgeConfig.role.textAlign || 'center',
                                                             overflow: 'hidden'
                                                        }}>
                                                    직책 (Role)
                                                </div>
                                            )}
                                        </>
                                    ) : (
                                        <div className="flex items-center justify-center h-full text-slate-400 text-sm flex-col gap-2"><Icon name="upload" size={32}/><span>배경 이미지를 업로드해주세요</span></div>
                                    )}
                                </div>
                            </div>

                            <div className="flex-1 space-y-4 w-full">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-2">배경 이미지 업로드</label>
                                    <input type="file" accept="image/*" onChange={handleBgImageUpload} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-incar-light file:text-incar hover:file:bg-indigo-100"/>
                                </div>
                                {badgeConfig.bgImage && (
                                    <div className="grid grid-cols-1 gap-3">
                                        <QrControl label="QR코드" conf={badgeConfig.qr} onChange={(k,v)=>setBadgeConfig(p=>({...p, qr:{...p.qr, [k]:v}}))} />
                                        <TextControl label="소속 (상단)" conf={badgeConfig.org} onChange={(k,v)=>setBadgeConfig(p=>({...p, org:{...p.org, [k]:v}}))} />
                                        <TextControl label="직책 (중단)" conf={badgeConfig.role} onChange={(k,v)=>setBadgeConfig(p=>({...p, role:{...p.role, [k]:v}}))} />
                                        <TextControl label="성명 (하단)" conf={badgeConfig.name} onChange={(k,v)=>setBadgeConfig(p=>({...p, name:{...p.name, [k]:v}}))} />
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="bg-incar text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
                        <div className="relative z-10">
                            <h3 className="font-black text-2xl">Master Data Setup</h3>
                            <p className="text-blue-200 text-sm mt-1 mb-6">엑셀 파일을 업로드하여 행사를 설정하세요.</p>
                            <div className="space-y-4">
                                <div className="bg-white/10 rounded-2xl border border-white/20 p-4">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-center gap-3"><Icon name="users" className="text-blue-200"/><div><div className="font-bold text-sm">1. 참가자 명단 (Users.csv)</div><div className="text-[10px] text-blue-300">사번, 성명, 직책, 옵션 포함</div></div></div>
                                        <button onClick={()=>downloadTemplate('users')} className="text-[10px] bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1"><Icon name="download" size={12} /> 양식 다운로드</button>
                                    </div>
                                    <label className="flex items-center justify-center w-full p-3 bg-white text-incar font-bold rounded-xl cursor-pointer hover:bg-slate-100 transition-colors text-sm"><input type="file" accept=".csv" onChange={handleUserUpload} className="hidden" /><Icon name="upload" size={16} className="mr-2" /> 파일 업로드</label>
                                </div>
                                <div className="bg-white/10 rounded-2xl border border-white/20 p-4">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-center gap-3"><Icon name="dashboard" className="text-blue-200"/><div><div className="font-bold text-sm">2. 일정 정보 (Schedules.csv)</div><div className="text-[10px] text-blue-300">일정, 장소, 타입, 타겟옵션 포함</div></div></div>
                                        <button onClick={()=>downloadTemplate('schedules')} className="text-[10px] bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1"><Icon name="download" size={12} /> 양식 다운로드</button>
                                    </div>
                                    <label className="flex items-center justify-center w-full p-3 bg-white text-incar font-bold rounded-xl cursor-pointer hover:bg-slate-100 transition-colors text-sm"><input type="file" accept=".csv" onChange={handleScheduleUpload} className="hidden" /><Icon name="upload" size={16} className="mr-2" /> 파일 업로드</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-slate-100 border border-slate-200 p-6 rounded-3xl shadow-sm flex justify-between items-center">
                        <div>
                            <h4 className="font-bold text-lg text-slate-800 mb-1 flex items-center gap-2"><Icon name="download" /> 운영 데이터 내보내기</h4>
                            <p className="text-xs text-slate-400">모든 스캔 기록을 엑셀(CSV) 파일로 다운로드합니다.</p>
                        </div>
                        <button onClick={exportAllData} className="px-6 py-3 bg-slate-800 text-white rounded-xl font-bold text-sm hover:bg-slate-900 transition-colors shadow-lg active:scale-95">전체 내역 다운로드</button>
                    </div>

                    <div className="bg-slate-800 text-white p-6 rounded-3xl shadow-card flex justify-between items-center relative overflow-hidden group">
                        <div className="absolute right-0 bottom-0 opacity-10 p-4"><Icon name="print" size={80} /></div>
                        <div className="relative z-10">
                            <h4 className="font-bold text-lg mb-1 flex items-center gap-2"><Icon name="print" /> 명찰 일괄 출력</h4>
                            <p className="text-xs text-slate-400">등록된 {users.length}명의 QR 명찰을 한 번에 생성합니다.</p>
                        </div>
                        <button onClick={() => {
                            if(users.length === 0) return alert("참가자 데이터가 없습니다.");
                            setIsPrintMode(true);
                        }} className="relative z-10 px-6 py-3 bg-white text-slate-900 rounded-xl font-bold text-sm hover:bg-slate-100 transition-colors shadow-lg active:scale-95">전체 인쇄 모드</button>
                    </div>

                    <div className="bg-white p-6 rounded-3xl shadow-card">
                        <h4 className="font-bold text-slate-800 mb-4">현재 데이터 현황</h4>
                        <div className="grid grid-cols-2 gap-4 text-center">
                            <div className="p-4 bg-slate-50 rounded-2xl"><div className="text-2xl font-black text-incar">{users.length}</div><div className="text-xs text-slate-400 font-bold">참가자</div></div>
                            <div className="p-4 bg-slate-50 rounded-2xl"><div className="text-2xl font-black text-emerald-600">{schedules.length}</div><div className="text-xs text-slate-400 font-bold">세션</div></div>
                        </div>
                        <button onClick={handleFullReset} className="w-full mt-6 py-4 bg-rose-50 text-rose-600 font-bold rounded-2xl hover:bg-rose-100">전체 초기화</button>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ activeTab, setActiveTab }) => (
            <aside className="w-64 bg-white h-full border-r border-slate-200 flex flex-col shadow-lg z-30 no-print">
                <div className="p-6 border-b border-slate-100 flex items-center gap-3">
                    <div className="w-8 h-8 bg-incar rounded-lg flex items-center justify-center text-white font-black">P</div>
                    <h1 className="font-black text-slate-800 tracking-tight">INCARPASS <span className="text-incar text-[10px] px-1.5 py-0.5 bg-indigo-50 rounded-md align-top">PC</span></h1>
                </div>
                <nav className="flex-1 p-4 space-y-2">
                    {[
                        {id:'dashboard', icon:'dashboard', label:'현황 (Status)'},
                        {id:'boarding', icon:'bus', label:'탑승 (Boarding)'},
                        {id:'payment', icon:'money', label:'지급 (Payment)'},
                        {id:'change', icon:'edit', label:'관리 (Management)'},
                        {id:'manage', icon:'settings', label:'설정 (Settings)'}
                    ].map(menu => (
                        <button key={menu.id} onClick={()=>setActiveTab(menu.id)} className={`w-full flex items-center gap-3 p-3 rounded-xl font-bold transition-all ${activeTab===menu.id ? 'bg-incar text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}>
                            <Icon name={menu.icon} /> {menu.label}
                        </button>
                    ))}
                </nav>
                <div className="p-6 border-t border-slate-100">
                    <div className="text-xs text-slate-400 font-bold mb-2">OPERATOR</div>
                    <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-slate-200"></div>
                        <div className="text-sm font-bold text-slate-700">관리자님</div>
                    </div>
                </div>
            </aside>
        );

        const MobileTab = ({ activeTab, setActiveTab }) => (
            <nav className="fixed bottom-0 w-full bg-white border-t border-slate-200 pb-safe pt-2 px-4 flex justify-around items-center z-30 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] no-print">
                <button onClick={()=>setActiveTab('dashboard')} className={`flex flex-col items-center gap-1 p-2 w-14 ${activeTab==='dashboard'?'text-incar':'text-slate-300'}`}><Icon name="dashboard" size={20} className={activeTab==='dashboard'?'fill-current':''} /><span className="text-[9px] font-bold">현황</span></button>
                <button onClick={()=>setActiveTab('boarding')} className={`flex flex-col items-center gap-1 p-2 w-14 relative ${activeTab==='boarding'?'text-incar':'text-slate-300'}`}><div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${activeTab==='boarding'?'bg-incar text-white shadow-lg ring-2 ring-slate-100 mb-1':''}`}><Icon name="bus" size={20} /></div>{activeTab!=='boarding' && <span className="text-[9px] font-bold">탑승</span>}</button>
                <button onClick={()=>setActiveTab('payment')} className={`flex flex-col items-center gap-1 p-2 w-14 relative ${activeTab==='payment'?'text-emerald-500':'text-slate-300'}`}><div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${activeTab==='payment'?'bg-emerald-500 text-white shadow-lg ring-2 ring-slate-100 mb-1':''}`}><Icon name="money" size={20} /></div>{activeTab!=='payment' && <span className="text-[9px] font-bold">지급</span>}</button>
                <button onClick={()=>setActiveTab('change')} className={`flex flex-col items-center gap-1 p-2 w-14 ${activeTab==='change'?'text-incar':'text-slate-300'}`}><Icon name="edit" size={20} className={activeTab==='change'?'fill-current':''} /><span className="text-[9px] font-bold">관리</span></button>
            </nav>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isPrintMode, setIsPrintMode] = useState(false);
            
            const [badgeConfig, setBadgeConfig] = useState({
                bgImage: null,
                qr: { x: 50, y: 20, size: 100 },
                name: { x: 50, y: 65, size: 40, color: '#000000', show: true, font: 'font-noto', shadow: false, bgColor: 'transparent', borderRadius: 0, padding: 0, width: 0, textAlign: 'center' },
                org: { x: 50, y: 40, size: 20, color: '#475569', show: true, font: 'font-noto', shadow: false, bgColor: 'transparent', borderRadius: 0, padding: 0, width: 0, textAlign: 'center' },
                role: { x: 50, y: 50, size: 18, color: '#000000', show: true, font: 'font-noto', shadow: false, bgColor: 'transparent', borderRadius: 0, padding: 0, width: 0, textAlign: 'center' },
                uid: { x: 50, y: 85, size: 14, color: '#94a3b8', show: false } 
            });

            const [user, setUser] = useState(null); 
            const [db, setDb] = useState(null);     
            const [isLoading, setIsLoading] = useState(true);
            const [serverError, setServerError] = useState(null);

            const [users, setUsers] = useState([]);
            const [schedules, setSchedules] = useState([]);
            const [logs, setLogs] = useState([]);
            const [changeLogs, setChangeLogs] = useState([]);
            const [scanResult, setScanResult] = useState(null);
            
            const [selectedSession, setSelectedSession] = useState(null);

            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const [isScanning, setIsScanning] = useState(false);
            const [targetSessionId, setTargetSessionId] = useState('');
            const [targetBus, setTargetBus] = useState('1호차');
            const [manualBus, setManualBus] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedUser, setSelectedUser] = useState(null);
            const [editForm, setEditForm] = useState({ optKey: '', optVal: '', penalty: 0, reason: '' });
            const [refundRequest, setRefundRequest] = useState(null);
            const [forfeitRequest, setForfeitRequest] = useState(null);

            const SYSTEM_APP_ID = 'inca-prod-v1';

            const firebaseConfig = {
 apiKey: "AIzaSyAh1dsSNobeF6Wz-0euP5AUggdqJANJ3dQ",
 authDomain: "incarpass.firebaseapp.com",
 projectId: "incarpass",
 storageBucket: "incarpass.firebasestorage.app",
 messagingSenderId: "955362361998",
 appId: "1:955362361998:web:166055dd392784f1827fdf",
 measurementId: "G-SNR3FPPQ7E"
};

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                const initSystem = async () => {
                    if (window.location.protocol === 'file:') {
                        alert("⚠️ 주의: HTML 파일을 직접 열면(file://) 파이어베이스 서버 연결이 차단됩니다.\n\nVS Code의 'Live Server'를 사용하거나, GitHub/Netlify에 올려서(http/https) 실행해주세요.");
                    }

                    if (firebaseConfig.apiKey && firebaseConfig.projectId) {
                        try {
                            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                            const _db = firebase.firestore();
                            await firebase.auth().signInAnonymously();
                            
                            setDb(_db);
                            setServerError(null);

                            const unsubS = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').onSnapshot(snap => {
                                const list = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>a.date>b.date?1:-1);
                                setSchedules(list);
                                if(list.length > 0 && !targetSessionId) setTargetSessionId(list[0].id);
                            }, err => console.error("Schedules Sync Error:", err));

                            const unsubL = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').orderBy('timestamp','desc').onSnapshot(snap => {
                                setLogs(snap.docs.map(d => ({id:d.id, ...d.data()})));
                            }, err => console.error("Logs Sync Error:", err));

                            const unsubC = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('changelogs').orderBy('timestamp','desc').onSnapshot(snap => {
                                setChangeLogs(snap.docs.map(d => ({id:d.id, ...d.data()})));
                            }, err => console.error("Changelogs Sync Error:", err));

                            const unsubU = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').onSnapshot(snap => {
                                setUsers(snap.docs.map(d => d.data()));
                            }, err => console.error("Users Sync Error:", err));

                            firebase.auth().onAuthStateChanged(u => {
                                setUser(u);
                                setIsLoading(false);
                            });

                            return () => { unsubS(); unsubL(); unsubC(); unsubU(); };

                        } catch (e) {
                            console.error("Firebase Init Failed:", e);
                            initLocal();
                        }
                    } else {
                        initLocal();
                    }
                };

                const initLocal = () => {
                    const loadedUsers = JSON.parse(localStorage.getItem('incar_pro_users') || '[]');
                    const loadedSched = JSON.parse(localStorage.getItem('incar_pro_schedules') || '[]');
                    const loadedLogs = JSON.parse(localStorage.getItem('incar_pro_logs') || '[]');
                    const loadedChanges = JSON.parse(localStorage.getItem('incar_pro_changelogs') || '[]');
                    
                    setUsers(loadedUsers);
                    setSchedules(loadedSched);
                    setLogs(loadedLogs);
                    setChangeLogs(loadedChanges);
                    
                    if (loadedSched.length > 0) setTargetSessionId(loadedSched[0].id);
                    setIsLoading(false);
                };

                initSystem();

                const loadedBadgeConfig = JSON.parse(localStorage.getItem('incar_pro_badge_config_v2_9') || 'null');
                if(loadedBadgeConfig && loadedBadgeConfig.name && loadedBadgeConfig.org) {
                    setBadgeConfig(loadedBadgeConfig);
                }
            }, []);

            useEffect(() => { if(!db) localStorage.setItem('incar_pro_users', JSON.stringify(users)); }, [users, db]);
            useEffect(() => { if(!db) localStorage.setItem('incar_pro_schedules', JSON.stringify(schedules)); }, [schedules, db]);
            useEffect(() => { if(!db) localStorage.setItem('incar_pro_logs', JSON.stringify(logs)); }, [logs, db]);
            useEffect(() => { if(!db) localStorage.setItem('incar_pro_changelogs', JSON.stringify(changeLogs)); }, [changeLogs, db]);
            useEffect(() => { localStorage.setItem('incar_pro_badge_config_v2_9', JSON.stringify(badgeConfig)); }, [badgeConfig]);

            // [수정] 로그 ID를 반환하도록 변경 (로컬 업데이트 이슈 해결)
            const getOldLogIdsToDelete = (uid, targetKey, oldVal) => {
                const oldSessions = schedules.filter(s => s.targetKey === targetKey && s.targetVal === oldVal);
                if(oldSessions.length === 0) return [];
                
                const logsToDelete = logs.filter(l => l.uid === uid && oldSessions.some(s => s.id === l.sessionId));
                return logsToDelete.map(l => l.id);
            };

            const cleanupOldLogs = async (uid, targetKey, oldVal) => {
                const oldLogIds = getOldLogIdsToDelete(uid, targetKey, oldVal);
                
                if(oldLogIds.length > 0) {
                    if(db) {
                        const batch = db.batch();
                        oldLogIds.forEach(logId => {
                            const ref = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').doc(logId);
                            batch.delete(ref);
                        });
                        await batch.commit();
                    } 
                    // 로컬 모드에서는 executeUpdate에서 일괄 처리
                    console.log(`Cleanup: Identified ${oldLogIds.length} old logs for user ${uid}`);
                }
                return oldLogIds;
            };
            
            const handleManualComplete = async (user, session) => {
                if(!confirm(`${user.name}님을 수동으로 [${session.type==='PAYMENT'?'지급완료':'탑승완료'}] 처리하시겠습니까?`)) return;
                
                const newLog = {
                    id: `LOG_${Date.now()}_MANUAL`,
                    timestamp: new Date().toISOString(),
                    uid: user.uid,
                    name: user.name,
                    org: user.org,
                    action: session.type === 'PAYMENT' ? '지급' : '탑승',
                    sessionId: session.id,
                    sessionTitle: session.title,
                    bus: '수동처리',
                    amount: session.type === 'PAYMENT' ? session.price : 0,
                    penaltyApplied: 0,
                    finalAmount: session.type === 'PAYMENT' ? session.price : 0
                };

                if(db) {
                    await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').add(newLog);
                } else {
                    setLogs([newLog, ...logs]);
                }
                alert("처리되었습니다.");
            };

            const executeUpdate = async (user, session, requiredChoice, penaltyAmount, reason, payoutOverride = null) => {
                if(!db && !confirm("로컬 모드입니다. 변경사항이 다른 기기에 반영되지 않습니다. 계속하시겠습니까?")) return;
                
                const oldVal = user.options[session.targetKey];
                // 기존 로그 삭제 (로컬에서는 ID 배열 받음)
                const logIdsToRemove = await cleanupOldLogs(user.uid, session.targetKey, oldVal);

                const newPenalty = penaltyAmount;

                if(db) {
                    const userRef = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(user.uid));
                    const updatedOptions = { ...user.options, [session.targetKey]: requiredChoice };
                    await userRef.update({ 
                        options: updatedOptions,
                        penaltyTotal: (user.penaltyTotal || 0) + newPenalty
                    });
                } else {
                    const updatedUsers = users.map(u => {
                        if (u.uid === user.uid) {
                            const newOptions = { ...u.options, [session.targetKey]: requiredChoice };
                            return { 
                                ...u, 
                                options: newOptions,
                                penaltyTotal: (u.penaltyTotal || 0) + newPenalty
                            };
                        }
                        return u;
                    });
                    setUsers(updatedUsers);
                }

                const changeLog = {
                    id: `CHG_${Date.now()}`,
                    timestamp: new Date().toLocaleString(),
                    uid: user.uid,
                    name: user.name,
                    targetOption: session.targetKey,
                    oldVal: oldVal || '미선택',
                    newVal: requiredChoice,
                    penalty: newPenalty,
                    reason: reason
                };
                if(db) await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('changelogs').add(changeLog);
                else setChangeLogs([changeLog, ...changeLogs]);

                let finalAmount = 0;
                let penaltyApplied = 0;

                if (session.type === 'PAYMENT') {
                    // [수정] payoutOverride가 있으면(예: 0원 지급), 계산된 금액 무시하고 사용
                    if (payoutOverride !== null) {
                        finalAmount = payoutOverride;
                        penaltyApplied = 0; // 특수 케이스이므로 패널티 적용 안함 (사유에 기록됨)
                    } else {
                        const baseAmount = session.price;
                        const deduction = (user.penaltyTotal || 0) + newPenalty;
                        finalAmount = Math.max(0, baseAmount - deduction);
                        penaltyApplied = (baseAmount - finalAmount);
                    }
                }

                const newLog = {
                    id: `LOG_${Date.now()}_FORCE`,
                    timestamp: new Date().toISOString(),
                    uid: user.uid,
                    name: user.name,
                    org: user.org,
                    action: session.type === 'PAYMENT' ? '지급' : '탑승',
                    sessionId: session.id,
                    sessionTitle: session.title,
                    bus: targetBus,
                    amount: session.type === 'PAYMENT' ? session.price : 0,
                    penaltyApplied: penaltyApplied,
                    finalAmount: finalAmount
                };

                if(db) {
                    await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').add(newLog);
                    if (penaltyApplied > 0) {
                        const currentPenalty = (user.penaltyTotal || 0) + newPenalty;
                        const userRef = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(user.uid));
                        await userRef.update({ penaltyTotal: currentPenalty - penaltyApplied });
                    }
                } else {
                    // [수정] 로컬 상태 업데이트: 기존 로그 제거 + 새 로그 추가를 한 번에 처리
                    setLogs(prevLogs => {
                        const filtered = prevLogs.filter(l => !logIdsToRemove.includes(l.id));
                        return [newLog, ...filtered];
                    });

                    if (penaltyApplied > 0) {
                        const currentPenalty = (user.penaltyTotal || 0) + newPenalty;
                        const updatedUsers2 = users.map(u => u.uid === user.uid ? { ...u, penaltyTotal: currentPenalty - penaltyApplied } : u);
                        setUsers(updatedUsers2);
                    }
                }

                setScanResult(null); 
                setRefundRequest(null);
                setForfeitRequest(null);
                
                let alertMsg = `${user.name}님의 일정이 [${requiredChoice}]로 변경되고 탑승 처리되었습니다.`;
                if(penaltyAmount > 0) {
                    alertMsg += `\n\n⚠️ 미반환 처리: ${CURRENCY}${penaltyAmount}가 패널티로 등록되었습니다.`;
                } else if (reason.includes('반환')) {
                    alertMsg += `\n\n✅ 반환 확인: 기존 지급액이 정상적으로 회수되었습니다.`;
                } else if (payoutOverride === 0) {
                    alertMsg += `\n\nℹ️ 지급 보류: 기존 일정 비용을 고려하여 이번 지급은 생략되었습니다.`;
                } else {
                    alertMsg += `\n(이전 일정에 대한 완료 기록은 삭제되었습니다.)`;
                }
                alert(alertMsg);
            };

            const handleForceUpdateAndProcess = async (user, session, requiredChoice) => {
                if(!db && !confirm("로컬 모드입니다. 변경사항이 다른 기기에 반영되지 않습니다. 계속하시겠습니까?")) return;
                
                const oldVal = user.options[session.targetKey];
                
                // 1. 기존 지급액(회수 대상 금액) 계산
                const oldPaymentSchedules = schedules.filter(s => 
                    s.targetKey === session.targetKey && 
                    s.targetVal === oldVal && 
                    s.type === 'PAYMENT'
                );
                
                const oldPaymentLogs = logs.filter(l => 
                    l.uid === user.uid && 
                    oldPaymentSchedules.some(s => s.id === l.sessionId)
                );
                
                const recoupAmount = oldPaymentLogs.reduce((sum, l) => sum + (l.finalAmount || 0), 0);

                if (recoupAmount > 0) {
                    setScanResult(null); 
                    setRefundRequest({ user, session, requiredChoice, amount: recoupAmount, oldVal });
                    return;
                } 
                
                // 2. [추가] 관광코스(예약) -> 지급코스(현금) 변경 체크 (지급 보류)
                // oldVal 일정이 BOARDING 타입이고, 새로운 session이 PAYMENT 타입이며 가격이 있는 경우
                const oldBoardingSchedules = schedules.filter(s => 
                    s.targetKey === session.targetKey && 
                    s.targetVal === oldVal && 
                    s.type === 'BOARDING'
                );
                
                const isFromTour = oldBoardingSchedules.length > 0;
                const isToPayment = session.type === 'PAYMENT' && session.price > 0;

                if (isFromTour && isToPayment) {
                    setScanResult(null);
                    setForfeitRequest({ user, session, requiredChoice, oldVal, price: session.price });
                    return;
                }

                // 특이사항 없으면 바로 진행
                await executeUpdate(user, session, requiredChoice, 0, '현장 스캔 시 즉시 변경');
            };

            const resolveRefundRequest = async (isReturned) => {
                if (!refundRequest) return;
                const { user, session, requiredChoice, amount } = refundRequest;
                
                if (isReturned) {
                    await executeUpdate(user, session, requiredChoice, 0, `현장 변경 (기존 지급액 ${CURRENCY}${amount} 현장 반환)`);
                } else {
                    await executeUpdate(user, session, requiredChoice, amount, `현장 변경 (기존 지급액 ${CURRENCY}${amount} 미반환/패널티)`);
                }
            };

            const resolveForfeitRequest = async (shouldPay) => {
                if (!forfeitRequest) return;
                const { user, session, requiredChoice, oldVal } = forfeitRequest;

                if (shouldPay) {
                    // 정상 지급 (기존 예약 무시)
                    await executeUpdate(user, session, requiredChoice, 0, '현장 변경 (관광->지급, 정상지급)');
                } else {
                    // 지급 보류 (0원 지급)
                    await executeUpdate(user, session, requiredChoice, 0, `현장 변경 (관광->지급, 예약비용 고려하여 지급생략)`, 0);
                }
            };

            // ... handleUserUpload, handleScheduleUpload ... (생략 없이 기존 코드 사용)
            const handleUserUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        const parsed = results.data.map(row => {
                            const uid = row['사번'] || row['ID'] || row['uid'] || Object.values(row)[0];
                            const name = row['성명'] || row['이름'] || row['Name'] || Object.values(row)[1];
                            const org = row['소속'] || row['부서'] || row['Org'] || '-';
                            const bus = row['버스'] || row['탑승버스'] || row['Bus'] || '미정';
                            const options = {};
                            
                            Object.keys(row).forEach(key => {
                                if(!['사번','ID','uid','성명','이름','Name','소속','부서','Org','버스','탑승버스','Bus'].includes(key)) {
                                    if(row[key]) options[key] = row[key];
                                }
                            });
                            return { uid, name, org, bus, options, penaltyTotal: 0 };
                        }).filter(u => u.uid);

                        if(confirm(`${parsed.length}명의 참가자 명단을 로드하시겠습니까?`)) {
                            if (db) {
                                const batch = db.batch();
                                parsed.forEach(u => {
                                    const ref = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(u.uid));
                                    batch.set(ref, u);
                                });
                                await batch.commit();
                                alert("서버 업로드 완료!");
                            } else {
                                setUsers(parsed);
                                alert("로컬 로드 완료!");
                            }
                        }
                    }
                });
            };

            const handleScheduleUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        const parsed = results.data.map((row, idx) => {
                            const rawDate = row['일정'] || row['Date'] || `Day ${idx+1}`;
                            const today = new Date();
                            const dateObj = new Date(today);
                            if(rawDate.includes('1일')) dateObj.setDate(today.getDate());
                            else if(rawDate.includes('2일')) dateObj.setDate(today.getDate()+1);
                            else if(rawDate.includes('3일')) dateObj.setDate(today.getDate()+2);
                            else if(rawDate.includes('4일')) dateObj.setDate(today.getDate()+3);
                            
                            const dateStr = dateObj.toISOString().split('T')[0];
                            
                            let rawPrice = row['지급'] || row['Price'] || '0';
                            if (typeof rawPrice === 'string') {
                                rawPrice = rawPrice.replace(/[$,\s]/g, '');
                            }
                            const price = parseInt(rawPrice) || 0;

                            let type = 'BOARDING';
                            if (price > 0) {
                                type = 'PAYMENT';
                            } else if (row['타입'] && (row['타입'].includes('지급') || row['타입'].includes('Payment'))) {
                                type = 'PAYMENT';
                            }
                            
                            return {
                                id: `SCHED_${idx}`,
                                date: dateStr,
                                displayDate: rawDate,
                                title: row['장소'] || row['Title'] || '일정',
                                type: type,
                                price: price,
                                targetKey: row['타겟옵션'] || row['OptionKey'] || 'ALL',
                                targetVal: row['타겟값'] || row['OptionVal'] || 'ALL'
                            };
                        });

                        if(confirm(`${parsed.length}개의 스케줄을 로드하시겠습니까?`)) {
                            if (db) {
                                const batch = db.batch();
                                parsed.forEach(s => {
                                    const ref = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').doc(s.id);
                                    batch.set(ref, s);
                                });
                                await batch.commit();
                                alert("서버 업로드 완료!");
                            } else {
                                setSchedules(parsed);
                                if(parsed.length > 0) setTargetSessionId(parsed[0].id);
                                alert("로컬 로드 완료!");
                            }
                        }
                    }
                });
            };

            const processScan = async (scannedUid) => {
                const user = users.find(u => u.uid === scannedUid);
                if (!user) return setScanResult({ status: 'error', msg: '미등록 참가자', subMsg: `ID: ${scannedUid}` });

                const session = schedules.find(s => s.id === targetSessionId);
                if (!session) return setScanResult({ status: 'error', msg: '세션 미선택', subMsg: '관리자에게 문의하세요' });

                const isDuplicate = logs.some(l => l.uid === user.uid && l.sessionId === session.id);
                if (isDuplicate) return setScanResult({ status: 'duplicate', msg: '이미 처리됨', subMsg: `${session.displayDate} - ${session.title}`, user });

                if (session.targetKey !== 'ALL') {
                    const userChoice = user.options[session.targetKey];
                    const requiredChoice = session.targetVal;
                    if (!userChoice || (requiredChoice !== 'ALL' && !userChoice.includes(requiredChoice))) {
                        return setScanResult({ 
                            status: 'error', 
                            msg: '대상자 아님', 
                            subMsg: `필요: ${requiredChoice} / 본인: ${userChoice || '선택없음'}`, 
                            user,
                            requiredChoice,
                            session
                        });
                    }
                }

                let finalAmount = 0;
                let penaltyApplied = 0;

                if (session.type === 'PAYMENT') {
                    const baseAmount = session.price;
                    const deduction = user.penaltyTotal || 0;
                    finalAmount = Math.max(0, baseAmount - deduction);
                    penaltyApplied = (baseAmount - finalAmount);
                }

                const newLog = {
                    id: `LOG_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,
                    timestamp: new Date().toISOString(),
                    uid: user.uid,
                    name: user.name,
                    org: user.org,
                    action: session.type === 'PAYMENT' ? '지급' : '탑승',
                    sessionId: session.id,
                    sessionTitle: session.title,
                    bus: session.type === 'BOARDING' ? targetBus : '-',
                    amount: session.type === 'PAYMENT' ? session.price : 0,
                    penaltyApplied: penaltyApplied,
                    finalAmount: finalAmount
                };

                if (db) {
                    await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').add(newLog);
                    if (penaltyApplied > 0) {
                        const userRef = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(user.uid));
                        await userRef.update({ penaltyTotal: user.penaltyTotal - penaltyApplied });
                    }
                } else {
                    setLogs([newLog, ...logs]);
                    if (penaltyApplied > 0) {
                        const updatedUsers = users.map(u => u.uid === user.uid ? { ...u, penaltyTotal: u.penaltyTotal - penaltyApplied } : u);
                        setUsers(updatedUsers);
                    }
                }
                
                const todayLogs = logs.filter(l => 
                    l.uid === user.uid && 
                    l.timestamp.slice(0, 10) === newLog.timestamp.slice(0, 10) &&
                    l.action === '지급'
                );

                setScanResult({ 
                    status: 'success', 
                    msg: session.type==='PAYMENT'?'지급 완료':'탑승 확인', 
                    subMsg: session.title, 
                    user, 
                    logs: newLog,
                    relatedLogs: todayLogs
                });
            };

            const handleUserUpdate = async () => {
                if (!selectedUser || !editForm.optKey) return;
                
                const oldVal = selectedUser.options[editForm.optKey];
                await cleanupOldLogs(selectedUser.uid, editForm.optKey, oldVal);

                const newPenalty = parseInt(editForm.penalty || 0);
                const changeLog = {
                    id: `CHG_${Date.now()}`,
                    timestamp: new Date().toLocaleString(),
                    uid: selectedUser.uid,
                    name: selectedUser.name,
                    targetOption: editForm.optKey,
                    oldVal: oldVal,
                    newVal: editForm.optVal,
                    penalty: newPenalty,
                    reason: editForm.reason
                };

                if (db) {
                    const userRef = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(selectedUser.uid));
                    const updatedOptions = { ...selectedUser.options, [editForm.optKey]: editForm.optVal };
                    await userRef.update({ 
                        options: updatedOptions,
                        penaltyTotal: (selectedUser.penaltyTotal || 0) + newPenalty
                    });
                    await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('changelogs').add(changeLog);
                } else {
                    const updatedUsers = users.map(u => {
                        if (u.uid === selectedUser.uid) {
                            const newOptions = { ...u.options, [editForm.optKey]: editForm.optVal };
                            const totalPenalty = (u.penaltyTotal || 0) + newPenalty;
                            return { ...u, options: newOptions, penaltyTotal: totalPenalty };
                        }
                        return u;
                    });
                    setUsers(updatedUsers);
                    setChangeLogs([changeLog, ...changeLogs]);
                }
                
                alert("변경 및 패널티 적용이 완료되었습니다.\n(이전 일정에 대한 완료 기록은 삭제되었습니다.)");
                setEditForm({ optKey: '', optVal: '', penalty: 0, reason: '' });
                setSelectedUser(null);
                setSearchQuery('');
            };

            const scheduleStats = useMemo(() => {
                return schedules.map(s => {
                    let targetCount = 0;
                    if(s.targetKey === 'ALL') {
                        targetCount = users.length;
                    } else {
                        targetCount = users.filter(u => u.options && u.options[s.targetKey] && u.options[s.targetKey].includes(s.targetVal)).length;
                    }
                    
                    const doneCount = logs.filter(l => l.sessionId === s.id).length;
                    const percent = targetCount > 0 ? Math.round((doneCount / targetCount) * 100) : 0;
                    
                    const expectedAmount = targetCount * (s.price || 0);
                    const actualAmount = logs.filter(l => l.sessionId === s.id).reduce((sum, l) => sum + (l.finalAmount || 0), 0);
                    const diffCount = doneCount - targetCount;
                    const diffAmount = actualAmount - expectedAmount;

                    return { ...s, targetCount, doneCount, percent, expectedAmount, actualAmount, diffCount, diffAmount };
                });
            }, [schedules, users, logs]);

            const groupedStats = useMemo(() => {
                const groups = {};
                scheduleStats.forEach(stat => {
                    const date = stat.displayDate || '기타';
                    if(!groups[date]) groups[date] = [];
                    groups[date].push(stat);
                });
                return groups;
            }, [scheduleStats]);

            return (
                <div className="h-full flex flex-row bg-slate-50 w-full">
                    { !isMobile && <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} /> }
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative w-full">
                        { isMobile && (
                            <header className="bg-white px-6 py-4 shadow-sm flex justify-between items-center z-20 no-print">
                                <div className="flex items-center gap-2"><div className="w-8 h-8 bg-incar rounded-lg flex items-center justify-center text-white font-black">P</div><h1 className="font-black text-slate-800 tracking-tight">INCARPASS</h1></div>
                                <div className="text-xs font-bold text-slate-400">{users.length}명</div>
                            </header>
                        )}
                        <div className="flex-1 overflow-y-auto p-4 pb-32 md:p-8 md:pb-8 w-full no-print-scroll">
                            <div className="max-w-5xl mx-auto w-full">
                                {activeTab === 'dashboard' && <DashboardView users={users} logs={logs} scheduleStats={scheduleStats} groupedStats={groupedStats} changeLogs={changeLogs} onSessionClick={setSelectedSession} />}
                                {activeTab === 'boarding' && <ScanView mode="BOARDING" schedules={schedules} targetSessionId={targetSessionId} setTargetSessionId={setTargetSessionId} targetBus={targetBus} setTargetBus={setTargetBus} manualBus={manualBus} setManualBus={setManualBus} isScanning={isScanning} setIsScanning={setIsScanning} processScan={processScan} users={users} isMobile={isMobile} />}
                                {activeTab === 'payment' && <ScanView mode="PAYMENT" schedules={schedules} targetSessionId={targetSessionId} setTargetSessionId={setTargetSessionId} targetBus={targetBus} setTargetBus={setTargetBus} manualBus={manualBus} setManualBus={setManualBus} isScanning={isScanning} setIsScanning={setIsScanning} processScan={processScan} users={users} isMobile={isMobile} />}
                                {activeTab === 'change' && <ChangeView searchQuery={searchQuery} setSearchQuery={setSearchQuery} selectedUser={selectedUser} setSelectedUser={setSelectedUser} editForm={editForm} setEditForm={setEditForm} handleUserUpdate={handleUserUpdate} users={users} schedules={schedules} />}
                                {activeTab === 'manage' && <ManageView users={users} handleUserUpload={handleUserUpload} handleScheduleUpload={handleScheduleUpload} badgeConfig={badgeConfig} setBadgeConfig={setBadgeConfig} db={db} serverError={serverError} schedules={schedules} logs={logs} setIsPrintMode={setIsPrintMode} setUsers={setUsers} setSchedules={setSchedules} setLogs={setLogs} setChangeLogs={setChangeLogs} />} 
                            </div>
                        </div>
                        { isMobile && <MobileTab activeTab={activeTab} setActiveTab={setActiveTab} /> }
                        {isPrintMode && <BadgePrintView users={users} config={badgeConfig} onClose={() => setIsPrintMode(false)} />}
                        
                        {selectedSession && (
                            <SessionDetailModal 
                                session={selectedSession} 
                                users={users} 
                                logs={logs} 
                                onClose={() => setSelectedSession(null)} 
                                onManualComplete={handleManualComplete}
                            />
                        )}
                        
                        {refundRequest && (
                            <div className="fixed inset-0 z-[300] flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-sm animate-fade-in no-print">
                                <div className="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl animate-slide-up">
                                    <div className="bg-rose-50 p-6 text-center border-b border-rose-100">
                                        <div className="w-16 h-16 bg-white text-rose-500 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm text-2xl font-bold">
                                            $
                                        </div>
                                        <h3 className="text-xl font-black text-rose-600 mb-1">지급금 반환 필요</h3>
                                        <p className="text-slate-600 font-bold text-sm">
                                            {refundRequest.user.name}님은<br/>이미 <span className="text-rose-600 underline">{CURRENCY}{refundRequest.amount}</span>을 지급받았습니다.
                                        </p>
                                    </div>
                                    <div className="p-6 space-y-4">
                                        <div className="text-center text-xs text-slate-400 mb-2">
                                            기존 일정: {refundRequest.oldVal} <br/>
                                            ▼ <br/>
                                            변경 일정: {refundRequest.session.title}
                                        </div>
                                        <button onClick={() => resolveRefundRequest(true)} className="w-full py-4 bg-emerald-500 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform flex flex-col items-center justify-center leading-none gap-1">
                                            <span>반환 받았습니다</span>
                                            <span className="text-[10px] opacity-80 font-normal">(패널티 없음)</span>
                                        </button>
                                        <button onClick={() => resolveRefundRequest(false)} className="w-full py-4 bg-slate-800 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform flex flex-col items-center justify-center leading-none gap-1">
                                            <span>반환받지 못했습니다</span>
                                            <span className="text-[10px] opacity-80 font-normal">(미반환금 패널티 처리)</span>
                                        </button>
                                        <button onClick={() => setRefundRequest(null)} className="w-full py-3 text-slate-400 font-bold text-sm hover:bg-slate-50 rounded-xl">
                                            취소
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {forfeitRequest && (
                            <div className="fixed inset-0 z-[300] flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-sm animate-fade-in no-print">
                                <div className="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl animate-slide-up">
                                    <div className="bg-indigo-50 p-6 text-center border-b border-indigo-100">
                                        <div className="w-16 h-16 bg-white text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm text-2xl font-bold">
                                            ?
                                        </div>
                                        <h3 className="text-xl font-black text-indigo-900 mb-1">지급 보류 확인</h3>
                                        <p className="text-slate-600 font-bold text-sm">
                                            관광 코스(예약)에서<br/>지급 일정(현금)으로 변경됩니다.
                                        </p>
                                    </div>
                                    <div className="p-6 space-y-4">
                                        <div className="text-center text-xs text-slate-400 mb-2">
                                            기존: {forfeitRequest.oldVal} (예약취소)<br/>
                                            ▼ <br/>
                                            변경: {forfeitRequest.session.title} (지급 {CURRENCY}{forfeitRequest.price})
                                        </div>
                                        <button onClick={() => resolveForfeitRequest(false)} className="w-full py-4 bg-rose-500 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform flex flex-col items-center justify-center leading-none gap-1">
                                            <span>지급하지 않음 (보류)</span>
                                            <span className="text-[10px] opacity-80 font-normal">(기존 예약 비용 고려)</span>
                                        </button>
                                        <button onClick={() => resolveForfeitRequest(true)} className="w-full py-4 bg-slate-800 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform flex flex-col items-center justify-center leading-none gap-1">
                                            <span>정상 지급</span>
                                            <span className="text-[10px] opacity-80 font-normal">({CURRENCY}{forfeitRequest.price} 지급 처리)</span>
                                        </button>
                                        <button onClick={() => setForfeitRequest(null)} className="w-full py-3 text-slate-400 font-bold text-sm hover:bg-slate-50 rounded-xl">
                                            취소
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                    <ResultModal result={scanResult} onClose={() => setScanResult(null)} onForceUpdate={handleForceUpdateAndProcess} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
