<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>INCARPASS PRO - Universal Event Platform</title>
    
    <!-- 필수 라이브러리 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- 스타일 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        incar: '#27398C', 
                        'incar-dark': '#1a2b6d', 
                        'incar-light': '#eef2ff',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    },
                    boxShadow: { 'card': '0 4px 20px rgba(39, 57, 140, 0.08)' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; color: #334155; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .scan-line { width: 100%; height: 2px; background: #ef4444; position: absolute; top: 0; left: 0; animation: scan 2s infinite linear; z-index: 20; box-shadow: 0 0 4px #ef4444; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        
        .mobile-only { display: block; }
        .pc-only { display: none; }
        @media (min-width: 768px) {
            .mobile-only { display: none; }
            .pc-only { display: block; }
        }
        
        .data-table th { background-color: #f8fafc; color: #64748b; font-weight: 800; font-size: 0.75rem; text-transform: uppercase; padding: 12px 16px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        .data-table td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; font-weight: 600; color: #334155; }
        .data-table tr:hover td { background-color: #f8fafc; }

        @media print {
            body { background-color: white; overflow: visible; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .page-break { break-after: page; page-break-after: always; margin: 0 auto; }
            #root { height: auto; overflow: visible; }
            @page { margin: 0; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row bg-slate-50">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment, useCallback } = React;
        const CURRENCY = '$';

        // --- 아이콘 컴포넌트 ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                menu: <path d="M3 12h18M3 6h18M3 18h18"/>,
                dashboard: <path d="M3 3h7v7H3V3m11 0h7v7h-7V3m0 11h7v7h-7v-7M3 14h7v7H3v-7"/>,
                qr: <path d="M3 7V3h4M3 17v4h4M17 3h4v4M21 17v-4h4m-4 4h-4M7 11h2v2H7v-2m4 0h2v2h-2v-2m4 0h2v2h-2v-2"/>,
                users: <g><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                money: <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>,
                edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></g>,
                settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
                check: <polyline points="20 6 9 17 4 12"/>,
                x: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
                alert: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12" y2="16"/></g>,
                history: <g><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></g>,
                upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
                download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>,
                desktop: <g><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></g>,
                mobile: <g><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/></g>,
                table: <g><path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/></g>,
                print: <g><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></g>,
                bus: <g><path d="M19 17h2l.64-2.54c.24-1.12.36-2.26.36-3.41V8.5a4.5 4.5 0 0 0-4.5-4.5h-11A4.5 4.5 0 0 0 2 8.5v2.55c0 1.15.12 2.29.36 3.41L3 17h2"/><path d="M15 17v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2"/><path d="M16 8.5h.01"/><path d="M8 8.5h.01"/></g>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="2"/>}</svg>;
        };

        const ResultModal = ({ result, onClose }) => {
            if (!result) return null;
            const { status, msg, subMsg, user, logs } = result;
            const isSuccess = status === 'success';
            
            useEffect(() => {
                if(isSuccess) {
                    const timer = setTimeout(onClose, 2000);
                    return () => clearTimeout(timer);
                }
            }, [isSuccess]);

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm animate-slide-up no-print">
                    <div className="bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl">
                        <div className={`p-8 text-center flex flex-col items-center justify-center ${isSuccess ? 'bg-emerald-50' : (status==='duplicate'?'bg-amber-50':'bg-rose-50')}`}>
                            <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 ${isSuccess ? 'bg-emerald-100 text-emerald-600' : (status==='duplicate'?'bg-amber-100 text-amber-600':'bg-rose-100 text-rose-600')}`}>
                                <Icon name={isSuccess ? 'check' : (status==='duplicate'?'alert':'x')} size={40} />
                            </div>
                            <h2 className={`text-2xl font-black mb-1 ${isSuccess ? 'text-emerald-800' : (status==='duplicate'?'text-amber-800':'text-rose-800')}`}>{msg}</h2>
                            <p className="text-slate-500 font-medium">{subMsg}</p>
                        </div>
                        {user && (
                            <div className="p-6 bg-white space-y-4">
                                <div className="flex items-center gap-4 p-4 rounded-2xl bg-slate-50 border border-slate-100">
                                    <div className="w-12 h-12 rounded-full bg-incar text-white flex items-center justify-center font-bold text-lg">{user.name[0]}</div>
                                    <div>
                                        <div className="font-bold text-lg text-slate-900">{user.name}</div>
                                        <div className="text-xs text-slate-400 font-bold">{user.org} | {user.uid}</div>
                                    </div>
                                </div>
                                {logs && logs.finalAmount !== undefined && (
                                    <div className="flex justify-between items-center p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                                        <span className="text-emerald-700 font-bold text-sm">최종 지급액</span>
                                        <div className="text-right">
                                            <span className="text-2xl font-black text-emerald-600">{CURRENCY}{logs.finalAmount}</span>
                                            {logs.penaltyApplied > 0 && <div className="text-[10px] text-rose-500 font-bold">(-패널티 {CURRENCY}{logs.penaltyApplied} 적용됨)</div>}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        <button onClick={onClose} className="w-full py-5 bg-slate-900 text-white font-bold text-lg hover:bg-slate-800 transition-colors">닫기</button>
                    </div>
                </div>
            );
        };

        const QRCodeCanvas = ({ text, size = 100, transparent = false }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (canvasRef.current && window.QRious) {
                    new QRious({
                        element: canvasRef.current,
                        value: text,
                        size: size,
                        level: 'H',
                        background: transparent ? 'transparent' : 'white',
                        foreground: 'black'
                    });
                }
            }, [text, size, transparent]);
            return <canvas ref={canvasRef} />;
        }

        // [컴포넌트 분리] App 내부에서 정의하지 않고 밖으로 분리하여 재렌더링 시 포커스 유지
        const DashboardView = ({ users, logs, scheduleStats, groupedStats, changeLogs }) => (
            <div className="space-y-6 animate-slide-up">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-incar">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Participants</div>
                        <div className="text-4xl font-black text-slate-800">{users.length}</div>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-emerald-500">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Payout</div>
                        <div className="text-4xl font-black text-slate-800">{CURRENCY}{logs.reduce((sum, l) => sum + (l.finalAmount||0), 0).toLocaleString()}</div>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-indigo-400 hidden md:block">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Completion Rate</div>
                        <div className="text-4xl font-black text-slate-800">
                            {scheduleStats.length > 0 ? Math.round(scheduleStats.reduce((acc, s) => acc + s.percent, 0) / scheduleStats.length) : 0}%
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-rose-400 hidden md:block">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Penalties</div>
                        <div className="text-4xl font-black text-slate-800">{changeLogs.length}건</div>
                    </div>
                </div>

                <div>
                    <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                        <Icon name="dashboard" className="text-incar"/> 일정별 진행률 (요약)
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {scheduleStats.map(stat => (
                            <div key={stat.id} className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-md transition-shadow">
                                <div className="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><Icon name={stat.type === 'PAYMENT' ? 'money' : 'bus'} size={60} /></div>
                                <div className="relative z-10">
                                    <div className="flex justify-between items-start mb-2">
                                        <span className={`text-[10px] font-black px-2 py-0.5 rounded ${stat.type==='PAYMENT'?'bg-emerald-100 text-emerald-600':'bg-indigo-50 text-incar'}`}>{stat.type==='PAYMENT'?'지급':'탑승'}</span>
                                        <span className="text-xs font-bold text-slate-400">{stat.displayDate}</span>
                                    </div>
                                    <h4 className="font-bold text-slate-800 mb-4 truncate pr-8">{stat.title}</h4>
                                    <div className="flex justify-between items-end mb-1">
                                        <span className="text-3xl font-black text-slate-800">{stat.doneCount}<span className="text-sm text-slate-400 font-medium ml-1">/ {stat.targetCount}</span></span>
                                        <span className={`text-xl font-bold ${stat.percent === 100 ? 'text-emerald-500' : 'text-incar'}`}>{stat.percent}%</span>
                                    </div>
                                    <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden mb-2">
                                        <div className={`h-full rounded-full transition-all duration-1000 ${stat.percent===100?'bg-emerald-500':'bg-incar'}`} style={{width: `${stat.percent}%`}}></div>
                                    </div>
                                    {stat.type === 'PAYMENT' && (
                                        <div className="pt-2 border-t border-slate-50 flex justify-between text-xs">
                                            <span className="text-slate-400">집행액: <b>{CURRENCY}{stat.actualAmount.toLocaleString()}</b></span>
                                            <span className="text-slate-400">예상: {CURRENCY}{stat.expectedAmount.toLocaleString()}</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                        {scheduleStats.length === 0 && <div className="col-span-full py-10 text-center text-slate-400 bg-white rounded-2xl border border-dashed border-slate-200">등록된 일정이 없습니다.</div>}
                    </div>
                </div>

                <div className="pc-only bg-white rounded-3xl border border-slate-200 shadow-card overflow-hidden mt-8">
                    <div className="p-5 border-b border-slate-100 bg-slate-50/50">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="table" className="text-incar"/> 상세 현황 분석표</h3>
                    </div>
                    {Object.entries(groupedStats).length === 0 ? <div className="p-10 text-center text-slate-400">데이터가 없습니다.</div> : (
                        <div className="p-6 space-y-8">
                            {Object.entries(groupedStats).sort().map(([date, stats]) => (
                                <div key={date}>
                                    <h4 className="text-xs font-black text-incar bg-indigo-50 px-3 py-1.5 rounded-lg inline-block mb-3">{date}</h4>
                                    <div className="overflow-hidden rounded-xl border border-slate-200">
                                        <table className="w-full text-left data-table">
                                            <thead><tr><th className="w-1/3">일정명</th><th className="text-center">구분</th><th className="text-right">대상(Target)</th><th className="text-right">완료(Done)</th><th className="text-center border-l border-slate-200">미완료</th><th className="text-right">예상 금액</th><th className="text-right">실제 집행</th><th className="text-center border-l border-slate-200">차액 (Diff)</th></tr></thead>
                                            <tbody>
                                                {stats.map(s => (
                                                    <tr key={s.id}>
                                                        <td className="font-bold">{s.title}</td>
                                                        <td className="text-center"><span className={`px-2 py-0.5 rounded text-[10px] font-black border ${s.type==='PAYMENT'?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-indigo-50 text-incar border-indigo-100'}`}>{s.type==='PAYMENT'?'지급':'탑승'}</span></td>
                                                        <td className="text-right text-slate-500">{s.targetCount}</td>
                                                        <td className="text-right font-bold text-slate-900">{s.doneCount}</td>
                                                        <td className="text-center border-l border-slate-50">{s.targetCount - s.doneCount === 0 ? <span className="text-emerald-500 font-bold text-xs">Complete</span> : <span className="text-rose-500 font-bold text-xs">{s.targetCount - s.doneCount}명 남음</span>}</td>
                                                        <td className="text-right text-slate-400">{s.type==='PAYMENT'?`${CURRENCY}${s.expectedAmount.toLocaleString()}`:'-'}</td>
                                                        <td className="text-right font-bold text-emerald-600">{s.type==='PAYMENT'?`${CURRENCY}${s.actualAmount.toLocaleString()}`:'-'}</td>
                                                        <td className="text-center border-l border-slate-50">{s.type !== 'PAYMENT' ? '-' : (s.diffAmount === 0 ? <span className="text-emerald-500 font-bold text-xs">OK</span> : s.diffAmount < 0 ? <span className="text-rose-500 font-bold text-xs">{s.diffAmount}</span> : <span className="text-blue-500 font-bold text-xs">+{s.diffAmount}</span>)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );

        const ScanView = ({ mode, schedules, targetSessionId, setTargetSessionId, targetBus, setTargetBus, manualBus, setManualBus, isScanning, setIsScanning, processScan, users, isMobile }) => {
            const scannerRef = useRef(null);
            const isRunningRef = useRef(false);
            
            const filteredSchedules = useMemo(() => {
                return schedules.filter(s => s.type === mode);
            }, [schedules, mode]);

            useEffect(() => {
                if (filteredSchedules.length > 0) {
                    // 현재 선택된 세션이 필터링된 목록에 없으면 첫번째꺼 선택
                    const exists = filteredSchedules.find(s => s.id === targetSessionId);
                    if (!exists) setTargetSessionId(filteredSchedules[0].id);
                } else {
                    setTargetSessionId('');
                }
            }, [mode, filteredSchedules]);

            useEffect(() => {
                return () => {
                    stopScanner();
                };
            }, []);

            const startScanner = () => {
                if (isRunningRef.current) return;
                setIsScanning(true);
                
                setTimeout(() => {
                    const element = document.getElementById("reader");
                    if (!element) {
                        setIsScanning(false);
                        return;
                    }
                    if (!scannerRef.current) {
                        scannerRef.current = new Html5Qrcode("reader");
                    }
                    const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
                    scannerRef.current.start({ facingMode: "environment" }, config, (decodedText) => {
                        stopScanner();
                        processScan(decodedText);
                    }, () => {}).then(() => {
                        isRunningRef.current = true;
                    }).catch(err => {
                        console.error("Camera start failed", err);
                        setIsScanning(false);
                        alert("카메라 시작 실패. 권한을 확인해주세요.");
                    });
                }, 300);
            };

            const stopScanner = () => {
                if (scannerRef.current && isRunningRef.current) {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current.clear();
                        isRunningRef.current = false;
                        setIsScanning(false);
                    }).catch(err => {
                        console.log("Failed to stop scanner", err);
                        setIsScanning(false);
                        isRunningRef.current = false;
                    });
                } else {
                    setIsScanning(false);
                }
            };

            return (
                <div className="space-y-6 h-full flex flex-col animate-slide-up">
                    <div className="bg-white p-6 rounded-3xl shadow-card border border-slate-200">
                        <div className="flex items-center gap-2 mb-4">
                            <span className={`px-2 py-1 rounded-lg text-xs font-black ${mode==='BOARDING'?'bg-incar text-white':'bg-emerald-500 text-white'}`}>{mode==='BOARDING' ? 'STEP 1' : '지급'}</span>
                            <h3 className="text-lg font-black text-slate-800">{mode==='BOARDING' ? '탑승 일정 선택' : '지급 항목 선택'}</h3>
                        </div>
                        <div className="mb-6">
                            <select value={targetSessionId} onChange={(e) => setTargetSessionId(e.target.value)} className={`w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-lg outline-none focus:ring-4 transition-all ${mode==='BOARDING'?'focus:ring-incar/20':'focus:ring-emerald-500/20'}`}>
                                {filteredSchedules.length === 0 && <option>해당하는 일정이 없습니다</option>}
                                {filteredSchedules.map(s => <option key={s.id} value={s.id}>[{s.displayDate}] {s.title}</option>)}
                            </select>
                        </div>
                        {mode === 'BOARDING' && (
                            <div className="animate-slide-up">
                                <div className="flex items-center gap-2 mb-3">
                                    <span className="px-2 py-1 rounded-lg text-xs font-black bg-slate-800 text-white">STEP 2</span>
                                    <div className="flex justify-between items-center flex-1">
                                        <h3 className="text-lg font-black text-slate-800">차량 번호 선택</h3>
                                        <button onClick={()=>setManualBus(!manualBus)} className="text-xs font-bold text-slate-400 underline decoration-slate-300">{manualBus ? '목록에서 선택' : '직접 입력'}</button>
                                    </div>
                                </div>
                                {manualBus ? 
                                    <input type="text" value={targetBus} onChange={e=>setTargetBus(e.target.value)} className="w-full p-4 bg-white border-2 border-slate-200 rounded-2xl font-bold text-center text-lg focus:border-incar outline-none" placeholder="차량 번호 입력" /> :
                                    <div className="grid grid-cols-4 gap-2">
                                        {[1,2,3,4,5,6,7,8,9,10,11,12].map(n => (
                                            <button key={n} onClick={()=>setTargetBus(`${n}호차`)} className={`py-3 rounded-xl text-sm font-black transition-all ${targetBus===`${n}호차`?'bg-incar text-white shadow-lg scale-105':'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>{n}호차</button>
                                        ))}
                                    </div>
                                }
                            </div>
                        )}
                    </div>

                    <div className="flex-1 flex flex-col justify-end">
                        {isScanning ? (
                            <div className="bg-black rounded-3xl overflow-hidden relative shadow-2xl flex-1 max-h-[400px]">
                                <div id="reader" className="w-full h-full"></div>
                                <div className={`scan-line ${mode==='BOARDING'?'bg-incar':'bg-emerald-500'}`}></div>
                                <button onClick={stopScanner} className="absolute bottom-6 left-1/2 -translate-x-1/2 bg-white/20 backdrop-blur text-white px-6 py-2 rounded-full font-bold text-sm border border-white/30 z-20">스캔 취소</button>
                            </div>
                        ) : (
                            <button onClick={startScanner} className={`w-full py-6 text-white rounded-3xl font-black text-xl shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-transform ${mode==='BOARDING'?'bg-incar shadow-incar/30':'bg-emerald-500 shadow-emerald-500/30'}`}>
                                <Icon name="qr" size={28}/> {mode==='BOARDING' ? '탑승 스캔 시작' : '지급 스캔 시작'}
                            </button>
                        )}
                        {!isMobile && users.length > 0 && <button onClick={()=>processScan(users[0].uid)} className="mt-4 text-xs text-slate-400 underline text-center">테스트: 첫번째 유저 강제 인식</button>}
                    </div>
                </div>
            );
        };

        const ChangeView = ({ searchQuery, setSearchQuery, selectedUser, setSelectedUser, editForm, setEditForm, handleUserUpdate, users }) => (
            <div className="space-y-6 animate-slide-up">
                <div className="bg-white p-6 rounded-3xl shadow-card">
                    <h3 className="font-bold text-lg mb-4 text-slate-800">참가자 일정 변경 및 패널티 관리</h3>
                    <div className="flex gap-2 mb-6">
                        <input type="text" value={searchQuery} onChange={(e)=>setSearchQuery(e.target.value)} placeholder="사번 또는 이름 검색" className="flex-1 p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold outline-none focus:border-incar" />
                        <button onClick={()=>{
                            const found = users.find(u => u.uid.includes(searchQuery) || u.name.includes(searchQuery));
                            if(found) setSelectedUser(found); else alert("사용자를 찾을 수 없습니다.");
                        }} className="bg-slate-800 text-white px-6 rounded-2xl font-bold">검색</button>
                    </div>
                    {selectedUser && (
                        <div className="border-t border-slate-100 pt-6 space-y-4">
                            <div className="flex flex-col md:flex-row gap-6 mb-6">
                                <div className="flex-1 bg-slate-50 p-5 rounded-2xl border border-slate-100 flex flex-col justify-center">
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <div className="font-black text-2xl text-slate-800">{selectedUser.name}</div>
                                            <div className="text-sm font-bold text-slate-500">{selectedUser.org}</div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-[10px] font-bold text-slate-400 uppercase">사번(ID)</div>
                                            <div className="font-mono font-bold text-incar">{selectedUser.uid}</div>
                                        </div>
                                    </div>
                                    <div className="mt-4 pt-4 border-t border-slate-200/50 flex justify-between items-center">
                                        <span className="text-xs font-bold text-slate-400">누적 패널티</span>
                                        <span className="font-black text-rose-500 text-lg">-{CURRENCY}{selectedUser.penaltyTotal || 0}</span>
                                    </div>
                                </div>
                                <div className="bg-white border-2 border-dashed border-slate-200 rounded-2xl p-4 flex flex-col items-center justify-center text-center w-full md:w-auto">
                                    <div className="mb-2 w-32 h-32 flex items-center justify-center bg-slate-50">
                                        <QRCodeCanvas text={selectedUser.uid} />
                                    </div>
                                    <p className="text-[10px] font-bold text-slate-400">QR 데이터: {selectedUser.uid}</p>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-xs font-bold text-slate-400 mb-1">변경할 옵션 (Key)</label><select value={editForm.optKey} onChange={e=>setEditForm({...editForm, optKey: e.target.value})} className="w-full p-3 border rounded-xl font-bold text-sm bg-white"><option value="">선택하세요</option>{Object.keys(selectedUser.options).map(key => <option key={key} value={key}>{key} (현재: {selectedUser.options[key]})</option>)}</select></div>
                                <div><label className="block text-xs font-bold text-slate-400 mb-1">변경값 (New)</label><input type="text" value={editForm.optVal} onChange={e=>setEditForm({...editForm, optVal: e.target.value})} className="w-full p-3 border rounded-xl font-bold text-sm" /></div>
                            </div>
                            <div><label className="block text-xs font-bold text-slate-400 mb-1">패널티 ({CURRENCY})</label><input type="number" value={editForm.penalty} onChange={e=>setEditForm({...editForm, penalty: e.target.value})} className="w-full p-3 border border-rose-200 bg-rose-50 rounded-xl font-bold text-rose-600" /></div>
                            <div><label className="block text-xs font-bold text-slate-400 mb-1">변경 사유</label><input type="text" value={editForm.reason} onChange={e=>setEditForm({...editForm, reason: e.target.value})} className="w-full p-3 border rounded-xl font-bold text-sm" /></div>
                            <button onClick={handleUserUpdate} className="w-full py-4 bg-incar text-white font-bold rounded-2xl shadow-lg mt-4 hover:bg-incar-dark">저장하기</button>
                        </div>
                    )}
                </div>
            </div>
        );

        const BadgePrintView = ({ users, onClose, config }) => (
            <div className="fixed inset-0 bg-white z-[100] overflow-auto animate-fade-in print-only-container">
                <div className="no-print fixed top-0 left-0 w-full bg-slate-900 text-white p-4 flex justify-between items-center shadow-xl z-50">
                    <div className="font-bold text-lg flex items-center gap-4">
                        <span className="bg-incar px-2 py-1 rounded text-xs">PRINT MODE</span> 
                        <span>명찰 일괄 출력 (총 {users.length}명)</span>
                    </div>
                    <div className="flex gap-3">
                        <button onClick={() => window.print()} className="bg-emerald-500 hover:bg-emerald-600 px-6 py-2 rounded-lg font-bold flex items-center gap-2">
                            <Icon name="print" /> 인쇄 / PDF저장
                        </button>
                        <button onClick={onClose} className="bg-slate-700 hover:bg-slate-600 px-6 py-2 rounded-lg font-bold">닫기</button>
                    </div>
                </div>
                <div className="p-8 pt-24 flex flex-col items-center gap-8 max-w-full mx-auto print:p-0 print:block">
                    {users.map((u, i) => (
                        <div key={u.uid} className="page-break relative shadow-sm overflow-hidden print:border-0 print:shadow-none" 
                                style={{
                                    width: '545px',
                                    height: '697px',
                                    border: config?.bgImage ? '1px solid #eee' : '2px solid #0f172a',
                                    borderRadius: '0.75rem',
                                    backgroundColor: 'white',
                                    marginBottom: '20px'
                                }}>
                            {config?.bgImage ? (
                                <>
                                    <img src={config.bgImage} className="absolute inset-0 w-full h-full object-cover z-0 print:block" />
                                    <div style={{ position: 'absolute', top: `${config.qr.y}%`, left: `${config.qr.x}%`, transform: 'translate(-50%, -50%)', zIndex: 10 }}>
                                        <QRCodeCanvas text={u.uid} size={config.qr.size} transparent={true} />
                                    </div>
                                    {config.org.show && <div style={{ position: 'absolute', top: `${config.org.y}%`, left: `${config.org.x}%`, transform: 'translate(-50%, -50%)', color: config.org.color, fontSize: `${config.org.size}px`, fontWeight: 'bold', whiteSpace: 'nowrap', zIndex: 10 }}>{u.org}</div>}
                                    {config.name.show && <div style={{ position: 'absolute', top: `${config.name.y}%`, left: `${config.name.x}%`, transform: 'translate(-50%, -50%)', color: config.name.color, fontSize: `${config.name.size}px`, fontWeight: '900', whiteSpace: 'nowrap', zIndex: 10 }}>{u.name}</div>}
                                    {config.uid.show && <div style={{ position: 'absolute', top: `${config.uid.y}%`, left: `${config.uid.x}%`, transform: 'translate(-50%, -50%)', color: config.uid.color, fontSize: `${config.uid.size}px`, fontFamily: 'monospace', zIndex: 10 }}>{u.uid}</div>}
                                </>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full p-6 text-center border-2 border-slate-900 m-4">
                                    <div className="w-40 h-40 bg-white mb-6">
                                        <QRCodeCanvas text={u.uid} size={160} />
                                    </div>
                                    <div className="overflow-hidden w-full space-y-2">
                                        <div className="text-2xl font-bold text-slate-500 truncate">{u.org}</div>
                                        <div className="text-6xl font-black text-slate-900 truncate leading-tight">{u.name}</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        );

        // [수정] setIsPrintMode를 props로 받도록 추가
        const ManageView = ({ users, handleUserUpload, handleScheduleUpload, badgeConfig, setBadgeConfig, db, serverError, schedules, logs, setIsPrintMode }) => {
            
            const handleBgImageUpload = (e) => {
                const file = e.target.files[0];
                if(file){
                    const reader = new FileReader();
                    reader.onload = (evt) => setBadgeConfig(prev => ({...prev, bgImage: evt.target.result}));
                    reader.readAsDataURL(file);
                }
            };

            const downloadTemplate = (type) => {
                let content = '';
                let filename = '';
                if(type === 'users') {
                    content = '\uFEFF사번,성명,소속,버스,2일차,3일차\n202401,홍길동,마케팅팀,1호차,힐링코스,투어\n202402,김철수,영업팀,미정,문화탐방,자유일정';
                    filename = '참가자명단_샘플.csv';
                } else {
                    content = '\uFEFF일정,장소,타입,지급,타겟옵션,타겟값\n1일차,공항미팅,관광,0,ALL,ALL\n2일차,자유식비,지급,30,2일차,자유일정\n2일차,힐링코스탑승,관광,0,2일차,힐링코스';
                    filename = '일정정보_샘플.csv';
                }
                const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            };

            // [NEW] 전체 데이터 엑셀 내보내기 기능
            const exportAllData = () => {
                if(logs.length === 0) return alert("내보낼 데이터가 없습니다.");
                
                const csvData = logs.map(l => ({
                    '스캔일시': l.timestamp ? new Date(l.timestamp).toLocaleString() : '',
                    '사번': l.uid,
                    '성명': l.name,
                    '소속': l.org,
                    '구분': l.action, // 탑승/지급
                    '일정명': l.sessionTitle,
                    '탑승차량': l.bus,
                    '금액': l.amount,
                    '최종지급액': l.finalAmount || l.amount,
                    '패널티적용': l.penaltyApplied > 0 ? 'Y' : 'N'
                }));

                const csv = Papa.unparse(csvData);
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `INCARPASS_FULL_DATA_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            const SliderGroup = ({ label, conf, onChange, colorPicker = false }) => (
                <div className="p-4 bg-slate-50 rounded-xl space-y-3 border border-slate-100">
                    <div className="flex justify-between items-center">
                        <span className="text-xs font-bold text-slate-700">{label}</span>
                        {conf.hasOwnProperty('show') && (
                            <label className="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" checked={conf.show} onChange={e => onChange('show', e.target.checked)} className="w-3 h-3 rounded text-incar focus:ring-incar"/>
                                <span className="text-[10px] text-slate-400">표시</span>
                            </label>
                        )}
                    </div>
                    <div className="grid grid-cols-1 gap-2">
                        <div className="flex gap-2 items-center"><span className="w-6 text-[10px] text-slate-400 font-bold">가로</span><input type="range" min="0" max="100" value={conf.x} onChange={e=>onChange('x', e.target.value)} className="flex-1 accent-incar h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"/></div>
                        <div className="flex gap-2 items-center"><span className="w-6 text-[10px] text-slate-400 font-bold">세로</span><input type="range" min="0" max="100" value={conf.y} onChange={e=>onChange('y', e.target.value)} className="flex-1 accent-incar h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"/></div>
                        <div className="flex gap-2 items-center"><span className="w-6 text-[10px] text-slate-400 font-bold">크기</span><input type="range" min="10" max={label==='QR코드'?250:100} value={conf.size} onChange={e=>onChange('size', e.target.value)} className="flex-1 accent-incar h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"/></div>
                        {colorPicker && (
                            <div className="flex gap-2 items-center"><span className="w-6 text-[10px] text-slate-400 font-bold">색상</span><input type="color" value={conf.color} onChange={e=>onChange('color', e.target.value)} className="w-full h-6 rounded cursor-pointer border border-slate-200"/></div>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="space-y-6 animate-slide-up no-print">
                    <div className="bg-slate-800 text-white p-6 rounded-3xl shadow-card">
                        <div className="flex justify-between items-center">
                            <div>
                                <h3 className="font-bold text-lg flex items-center gap-2">
                                    <div className={`w-3 h-3 rounded-full ${db ? 'bg-emerald-400 animate-pulse' : 'bg-rose-400'}`}></div> 
                                    {db ? '서버 연결 정상' : '로컬 모드 (서버 미연결)'}
                                </h3>
                                <p className="text-xs text-slate-400 mt-1">
                                    {db ? '모든 데이터가 클라우드에 실시간으로 저장됩니다.' : 
                                        serverError ? `오류: ${serverError}` : '현재 기기에만 데이터가 저장됩니다. (공유 불가)'}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-3xl shadow-card border border-slate-200">
                        <h3 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2"><Icon name="edit" className="text-incar"/> 명찰 디자인 설정</h3>
                        <div className="flex flex-col md:flex-row gap-8">
                            <div className="flex-1 flex justify-center items-start bg-slate-50 rounded-2xl p-4 border-2 border-dashed border-slate-200 min-h-[300px] overflow-auto">
                                <div className="relative overflow-hidden shadow-2xl bg-white sticky top-4 origin-top transform scale-75 md:scale-50 lg:scale-75" 
                                        style={{ width: '545px', height: '697px', borderRadius: '10px', flexShrink: 0 }}>
                                    {badgeConfig.bgImage ? (
                                        <>
                                            <img src={badgeConfig.bgImage} className="absolute inset-0 w-full h-full object-cover" />
                                            <div style={{ position: 'absolute', top: `${badgeConfig.qr.y}%`, left: `${badgeConfig.qr.x}%`, width: `${badgeConfig.qr.size}px`, height: `${badgeConfig.qr.size}px`, transform: 'translate(-50%, -50%)', border: '2px dashed red', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '10px', color: 'red', fontWeight: 'bold' }}>QR</div>
                                            {badgeConfig.org.show && <div style={{ position: 'absolute', top: `${badgeConfig.org.y}%`, left: `${badgeConfig.org.x}%`, transform: 'translate(-50%, -50%)', color: badgeConfig.org.color, fontSize: `${badgeConfig.org.size}px`, fontWeight: 'bold', border: '1px dashed blue', whiteSpace: 'nowrap' }}>소속 (Organization)</div>}
                                            {badgeConfig.name.show && <div style={{ position: 'absolute', top: `${badgeConfig.name.y}%`, left: `${badgeConfig.name.x}%`, transform: 'translate(-50%, -50%)', color: badgeConfig.name.color, fontSize: `${badgeConfig.name.size}px`, fontWeight: '900', border: '1px dashed blue', whiteSpace: 'nowrap' }}>성 명 (Name)</div>}
                                            {badgeConfig.uid.show && <div style={{ position: 'absolute', top: `${badgeConfig.uid.y}%`, left: `${badgeConfig.uid.x}%`, transform: 'translate(-50%, -50%)', color: badgeConfig.uid.color, fontSize: `${badgeConfig.uid.size}px`, fontFamily: 'monospace', border: '1px dashed blue', whiteSpace: 'nowrap' }}>12345678</div>}
                                        </>
                                    ) : (
                                        <div className="flex items-center justify-center h-full text-slate-400 text-sm flex-col gap-2"><Icon name="upload" size={32}/><span>배경 이미지를 업로드해주세요</span></div>
                                    )}
                                </div>
                            </div>
                            <div className="flex-1 space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-2">배경 이미지 업로드</label>
                                    <input type="file" accept="image/*" onChange={handleBgImageUpload} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-incar-light file:text-incar hover:file:bg-indigo-100"/>
                                </div>
                                {badgeConfig.bgImage && (
                                    <div className="space-y-3">
                                        <SliderGroup label="QR코드" conf={badgeConfig.qr} onChange={(k,v)=>setBadgeConfig(p=>({...p, qr:{...p.qr, [k]:v}}))} />
                                        <SliderGroup label="소속 (상단)" conf={badgeConfig.org} onChange={(k,v)=>setBadgeConfig(p=>({...p, org:{...p.org, [k]:v}}))} colorPicker={true} />
                                        <SliderGroup label="성명 (중앙)" conf={badgeConfig.name} onChange={(k,v)=>setBadgeConfig(p=>({...p, name:{...p.name, [k]:v}}))} colorPicker={true} />
                                        <SliderGroup label="사번 (하단)" conf={badgeConfig.uid} onChange={(k,v)=>setBadgeConfig(p=>({...p, uid:{...p.uid, [k]:v}}))} colorPicker={true} />
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="bg-incar text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
                        <div className="relative z-10">
                            <h3 className="font-black text-2xl">Master Data Setup</h3>
                            <p className="text-blue-200 text-sm mt-1 mb-6">엑셀 파일을 업로드하여 행사를 설정하세요.</p>
                            <div className="space-y-4">
                                <div className="bg-white/10 rounded-2xl border border-white/20 p-4">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-center gap-3"><Icon name="users" className="text-blue-200"/><div><div className="font-bold text-sm">1. 참가자 명단 (Users.csv)</div><div className="text-[10px] text-blue-300">사번, 성명, 옵션(2일차 등) 포함</div></div></div>
                                        <button onClick={()=>downloadTemplate('users')} className="text-[10px] bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1"><Icon name="download" size={12} /> 양식 다운로드</button>
                                    </div>
                                    <label className="flex items-center justify-center w-full p-3 bg-white text-incar font-bold rounded-xl cursor-pointer hover:bg-slate-100 transition-colors text-sm"><input type="file" accept=".csv" onChange={handleUserUpload} className="hidden" /><Icon name="upload" size={16} className="mr-2" /> 파일 업로드</label>
                                </div>
                                <div className="bg-white/10 rounded-2xl border border-white/20 p-4">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-center gap-3"><Icon name="dashboard" className="text-blue-200"/><div><div className="font-bold text-sm">2. 일정 정보 (Schedules.csv)</div><div className="text-[10px] text-blue-300">일정, 장소, 타입, 타겟옵션 포함</div></div></div>
                                        <button onClick={()=>downloadTemplate('schedules')} className="text-[10px] bg-white/20 hover:bg-white/30 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1"><Icon name="download" size={12} /> 양식 다운로드</button>
                                    </div>
                                    <label className="flex items-center justify-center w-full p-3 bg-white text-incar font-bold rounded-xl cursor-pointer hover:bg-slate-100 transition-colors text-sm"><input type="file" accept=".csv" onChange={handleScheduleUpload} className="hidden" /><Icon name="upload" size={16} className="mr-2" /> 파일 업로드</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* [NEW] 전체 엑셀 백데이터 다운로드 버튼 */}
                    <div className="bg-slate-100 border border-slate-200 p-6 rounded-3xl shadow-sm flex justify-between items-center">
                        <div>
                            <h4 className="font-bold text-lg text-slate-800 mb-1 flex items-center gap-2"><Icon name="download" /> 운영 데이터 내보내기</h4>
                            <p className="text-xs text-slate-400">모든 스캔 기록을 엑셀(CSV) 파일로 다운로드합니다.</p>
                        </div>
                        <button onClick={exportAllData} className="px-6 py-3 bg-slate-800 text-white rounded-xl font-bold text-sm hover:bg-slate-900 transition-colors shadow-lg active:scale-95">전체 내역 다운로드</button>
                    </div>

                    <div className="bg-slate-800 text-white p-6 rounded-3xl shadow-card flex justify-between items-center relative overflow-hidden group">
                        <div className="absolute right-0 bottom-0 opacity-10 p-4"><Icon name="print" size={80} /></div>
                        <div className="relative z-10">
                            <h4 className="font-bold text-lg mb-1 flex items-center gap-2"><Icon name="print" /> 명찰 일괄 출력</h4>
                            <p className="text-xs text-slate-400">등록된 {users.length}명의 QR 명찰을 한 번에 생성합니다.</p>
                        </div>
                        <button onClick={() => {
                            if(users.length === 0) return alert("참가자 데이터가 없습니다.");
                            setIsPrintMode(true);
                        }} className="relative z-10 px-6 py-3 bg-white text-slate-900 rounded-xl font-bold text-sm hover:bg-slate-100 transition-colors shadow-lg active:scale-95">전체 인쇄 모드</button>
                    </div>

                    <div className="bg-white p-6 rounded-3xl shadow-card">
                        <h4 className="font-bold text-slate-800 mb-4">현재 데이터 현황</h4>
                        <div className="grid grid-cols-2 gap-4 text-center">
                            <div className="p-4 bg-slate-50 rounded-2xl"><div className="text-2xl font-black text-incar">{users.length}</div><div className="text-xs text-slate-400 font-bold">참가자</div></div>
                            <div className="p-4 bg-slate-50 rounded-2xl"><div className="text-2xl font-black text-emerald-600">{schedules.length}</div><div className="text-xs text-slate-400 font-bold">세션</div></div>
                        </div>
                        <button onClick={()=>{ if(confirm("초기화?")) { localStorage.clear(); window.location.reload(); }}} className="w-full mt-6 py-4 bg-rose-50 text-rose-600 font-bold rounded-2xl hover:bg-rose-100">전체 초기화</button>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ activeTab, setActiveTab }) => (
            <aside className="w-64 bg-white h-full border-r border-slate-200 flex flex-col shadow-lg z-30 no-print">
                <div className="p-6 border-b border-slate-100 flex items-center gap-3">
                    <div className="w-8 h-8 bg-incar rounded-lg flex items-center justify-center text-white font-black">P</div>
                    <h1 className="font-black text-slate-800 tracking-tight">INCARPASS <span className="text-incar text-[10px] px-1.5 py-0.5 bg-indigo-50 rounded-md align-top">PC</span></h1>
                </div>
                <nav className="flex-1 p-4 space-y-2">
                    {[
                        {id:'dashboard', icon:'dashboard', label:'관제 대시보드'},
                        {id:'boarding', icon:'bus', label:'탑승 (Boarding)'},
                        {id:'payment', icon:'money', label:'지급 (Payment)'},
                        {id:'change', icon:'edit', label:'일정/패널티 관리'},
                        {id:'manage', icon:'settings', label:'마스터 설정'}
                    ].map(menu => (
                        <button key={menu.id} onClick={()=>setActiveTab(menu.id)} className={`w-full flex items-center gap-3 p-3 rounded-xl font-bold transition-all ${activeTab===menu.id ? 'bg-incar text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}>
                            <Icon name={menu.icon} /> {menu.label}
                        </button>
                    ))}
                </nav>
                <div className="p-6 border-t border-slate-100">
                    <div className="text-xs text-slate-400 font-bold mb-2">OPERATOR</div>
                    <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-slate-200"></div>
                        <div className="text-sm font-bold text-slate-700">관리자님</div>
                    </div>
                </div>
            </aside>
        );

        const MobileTab = ({ activeTab, setActiveTab }) => (
            <nav className="fixed bottom-0 w-full bg-white border-t border-slate-200 pb-safe pt-2 px-4 flex justify-around items-center z-30 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] no-print">
                <button onClick={()=>setActiveTab('dashboard')} className={`flex flex-col items-center gap-1 p-2 w-14 ${activeTab==='dashboard'?'text-incar':'text-slate-300'}`}><Icon name="dashboard" size={20} className={activeTab==='dashboard'?'fill-current':''} /><span className="text-[9px] font-bold">현황</span></button>
                <button onClick={()=>setActiveTab('boarding')} className={`flex flex-col items-center gap-1 p-2 w-14 relative ${activeTab==='boarding'?'text-incar':'text-slate-300'}`}><div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${activeTab==='boarding'?'bg-incar text-white shadow-lg ring-2 ring-slate-100 mb-1':''}`}><Icon name="bus" size={20} /></div>{activeTab!=='boarding' && <span className="text-[9px] font-bold">탑승</span>}</button>
                <button onClick={()=>setActiveTab('payment')} className={`flex flex-col items-center gap-1 p-2 w-14 relative ${activeTab==='payment'?'text-emerald-500':'text-slate-300'}`}><div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${activeTab==='payment'?'bg-emerald-500 text-white shadow-lg ring-2 ring-slate-100 mb-1':''}`}><Icon name="money" size={20} /></div>{activeTab!=='payment' && <span className="text-[9px] font-bold">지급</span>}</button>
                <button onClick={()=>setActiveTab('change')} className={`flex flex-col items-center gap-1 p-2 w-14 ${activeTab==='change'?'text-incar':'text-slate-300'}`}><Icon name="edit" size={20} className={activeTab==='change'?'fill-current':''} /><span className="text-[9px] font-bold">변경</span></button>
            </nav>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isPrintMode, setIsPrintMode] = useState(false);
            
            const [badgeConfig, setBadgeConfig] = useState({
                bgImage: null,
                qr: { x: 50, y: 70, size: 150 },
                name: { x: 50, y: 45, size: 40, color: '#000000', show: true },
                org: { x: 50, y: 35, size: 20, color: '#475569', show: true },
                uid: { x: 50, y: 85, size: 14, color: '#94a3b8', show: false } 
            });

            const [user, setUser] = useState(null); 
            const [db, setDb] = useState(null);    
            const [isLoading, setIsLoading] = useState(true);
            const [serverError, setServerError] = useState(null);

            const [users, setUsers] = useState([]);
            const [schedules, setSchedules] = useState([]);
            const [logs, setLogs] = useState([]);
            const [changeLogs, setChangeLogs] = useState([]);
            const [scanResult, setScanResult] = useState(null);
            
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const [isScanning, setIsScanning] = useState(false);
            const [targetSessionId, setTargetSessionId] = useState('');
            const [targetBus, setTargetBus] = useState('1호차');
            const [manualBus, setManualBus] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedUser, setSelectedUser] = useState(null);
            const [editForm, setEditForm] = useState({ optKey: '', optVal: '', penalty: 0, reason: '' });

            const SYSTEM_APP_ID = 'inca-prod-v1';

            // [사용자 설정 영역] 파이어베이스 키
            const firebaseConfig = {
  apiKey: "AIzaSyAh1dsSNobeF6Wz-0euP5AUggdqJANJ3dQ",
  authDomain: "incarpass.firebaseapp.com",
  projectId: "incarpass",
  storageBucket: "incarpass.firebasestorage.app",
  messagingSenderId: "955362361998",
  appId: "1:955362361998:web:166055dd392784f1827fdf",
  measurementId: "G-SNR3FPPQ7E"
};

            // ... (useEffect hooks for init and sync - same as before) ...
            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                const initSystem = async () => {
                    if (window.location.protocol === 'file:') {
                        alert("⚠️ 주의: HTML 파일을 직접 열면(file://) 파이어베이스 서버 연결이 차단됩니다.\n\nVS Code의 'Live Server'를 사용하거나, GitHub/Netlify에 올려서(http/https) 실행해주세요.");
                    }

                    if (firebaseConfig.apiKey && firebaseConfig.projectId) {
                        try {
                            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                            const _db = firebase.firestore();
                            await firebase.auth().signInAnonymously();
                            
                            setDb(_db);
                            setServerError(null);

                            const unsubS = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').onSnapshot(snap => {
                                const list = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>a.date>b.date?1:-1);
                                setSchedules(list);
                                if(list.length > 0 && !targetSessionId) setTargetSessionId(list[0].id);
                            }, err => console.error("Schedules Sync Error:", err));

                            const unsubL = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').orderBy('timestamp','desc').onSnapshot(snap => {
                                setLogs(snap.docs.map(d => ({id:d.id, ...d.data()})));
                            }, err => console.error("Logs Sync Error:", err));

                            const unsubC = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('changelogs').orderBy('timestamp','desc').onSnapshot(snap => {
                                setChangeLogs(snap.docs.map(d => ({id:d.id, ...d.data()})));
                            }, err => console.error("Changelogs Sync Error:", err));

                            const unsubU = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').onSnapshot(snap => {
                                setUsers(snap.docs.map(d => d.data()));
                            }, err => console.error("Users Sync Error:", err));

                            firebase.auth().onAuthStateChanged(u => {
                                setUser(u);
                                setIsLoading(false);
                            });

                            return () => { unsubS(); unsubL(); unsubC(); unsubU(); };

                        } catch (e) {
                            console.error("Firebase Init Failed:", e);
                            initLocal();
                        }
                    } else {
                        initLocal();
                    }
                };

                const initLocal = () => {
                    const loadedUsers = JSON.parse(localStorage.getItem('incar_pro_users') || '[]');
                    const loadedSched = JSON.parse(localStorage.getItem('incar_pro_schedules') || '[]');
                    const loadedLogs = JSON.parse(localStorage.getItem('incar_pro_logs') || '[]');
                    const loadedChanges = JSON.parse(localStorage.getItem('incar_pro_changelogs') || '[]');
                    
                    setUsers(loadedUsers);
                    setSchedules(loadedSched);
                    setLogs(loadedLogs);
                    setChangeLogs(loadedChanges);
                    
                    if (loadedSched.length > 0) setTargetSessionId(loadedSched[0].id);
                    setIsLoading(false);
                };

                initSystem();

                const loadedBadgeConfig = JSON.parse(localStorage.getItem('incar_pro_badge_config_v2_1') || 'null');
                if(loadedBadgeConfig && loadedBadgeConfig.name && loadedBadgeConfig.org) {
                    setBadgeConfig(loadedBadgeConfig);
                }
            }, []);

            useEffect(() => { if(!db) localStorage.setItem('incar_pro_users', JSON.stringify(users)); }, [users, db]);
            useEffect(() => { if(!db) localStorage.setItem('incar_pro_schedules', JSON.stringify(schedules)); }, [schedules, db]);
            useEffect(() => { if(!db) localStorage.setItem('incar_pro_logs', JSON.stringify(logs)); }, [logs, db]);
            useEffect(() => { if(!db) localStorage.setItem('incar_pro_changelogs', JSON.stringify(changeLogs)); }, [changeLogs, db]);
            useEffect(() => { localStorage.setItem('incar_pro_badge_config_v2_1', JSON.stringify(badgeConfig)); }, [badgeConfig]);

            // ... (Handlers) ...
            const handleUserUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        const parsed = results.data.map(row => {
                            const uid = row['사번'] || row['ID'] || row['uid'] || Object.values(row)[0];
                            const name = row['성명'] || row['이름'] || row['Name'] || Object.values(row)[1];
                            const org = row['소속'] || row['부서'] || row['Org'] || '-';
                            const bus = row['버스'] || row['탑승버스'] || row['Bus'] || '미정';
                            const options = {};
                            Object.keys(row).forEach(key => {
                                if(!['사번','ID','uid','성명','이름','Name','소속','부서','Org','버스','탑승버스','Bus'].includes(key)) {
                                    if(row[key]) options[key] = row[key];
                                }
                            });
                            return { uid, name, org, bus, options, penaltyTotal: 0 };
                        }).filter(u => u.uid);

                        if(confirm(`${parsed.length}명의 참가자 명단을 로드하시겠습니까?`)) {
                            if (db) {
                                const batch = db.batch();
                                parsed.forEach(u => {
                                    const ref = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(u.uid));
                                    batch.set(ref, u);
                                });
                                await batch.commit();
                                alert("서버 업로드 완료!");
                            } else {
                                setUsers(parsed);
                                alert("로컬 로드 완료!");
                            }
                        }
                    }
                });
            };

            const handleScheduleUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        const parsed = results.data.map((row, idx) => {
                            const rawDate = row['일정'] || row['Date'] || `Day ${idx+1}`;
                            const today = new Date();
                            const dateObj = new Date(today);
                            if(rawDate.includes('1일')) dateObj.setDate(today.getDate());
                            else if(rawDate.includes('2일')) dateObj.setDate(today.getDate()+1);
                            else if(rawDate.includes('3일')) dateObj.setDate(today.getDate()+2);
                            else if(rawDate.includes('4일')) dateObj.setDate(today.getDate()+3);
                            
                            const dateStr = dateObj.toISOString().split('T')[0];
                            const type = (row['타입'] && row['타입'].includes('지급')) || (row['지급'] && row['지급'] > 0) ? 'PAYMENT' : 'BOARDING';
                            
                            return {
                                id: `SCHED_${idx}`,
                                date: dateStr,
                                displayDate: rawDate,
                                title: row['장소'] || row['Title'] || '일정',
                                type: type,
                                price: parseInt(row['지급'] || row['Price'] || 0),
                                targetKey: row['타겟옵션'] || row['OptionKey'] || 'ALL',
                                targetVal: row['타겟값'] || row['OptionVal'] || 'ALL'
                            };
                        });

                        if(confirm(`${parsed.length}개의 스케줄을 로드하시겠습니까?`)) {
                            if (db) {
                                const batch = db.batch();
                                parsed.forEach(s => {
                                    const ref = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').doc(s.id);
                                    batch.set(ref, s);
                                });
                                await batch.commit();
                                alert("서버 업로드 완료!");
                            } else {
                                setSchedules(parsed);
                                if(parsed.length > 0) setTargetSessionId(parsed[0].id);
                                alert("로컬 로드 완료!");
                            }
                        }
                    }
                });
            };

            const processScan = async (scannedUid) => {
                const user = users.find(u => u.uid === scannedUid);
                if (!user) return setScanResult({ status: 'error', msg: '미등록 참가자', subMsg: `ID: ${scannedUid}` });

                const session = schedules.find(s => s.id === targetSessionId);
                if (!session) return setScanResult({ status: 'error', msg: '세션 미선택', subMsg: '관리자에게 문의하세요' });

                const isDuplicate = logs.some(l => l.uid === user.uid && l.sessionId === session.id);
                if (isDuplicate) return setScanResult({ status: 'duplicate', msg: '이미 처리됨', subMsg: `${session.displayDate} - ${session.title}`, user });

                if (session.targetKey !== 'ALL') {
                    const userChoice = user.options[session.targetKey];
                    const requiredChoice = session.targetVal;
                    if (!userChoice || (requiredChoice !== 'ALL' && !userChoice.includes(requiredChoice))) {
                        return setScanResult({ status: 'error', msg: '대상자 아님', subMsg: `필요: ${requiredChoice} / 본인: ${userChoice || '선택없음'}`, user });
                    }
                }

                let finalAmount = 0;
                let penaltyApplied = 0;

                if (session.type === 'PAYMENT') {
                    const baseAmount = session.price;
                    const deduction = user.penaltyTotal || 0;
                    finalAmount = Math.max(0, baseAmount - deduction);
                    penaltyApplied = (baseAmount - finalAmount);
                }

                const newLog = {
                    id: `LOG_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,
                    timestamp: new Date().toISOString(),
                    uid: user.uid,
                    name: user.name,
                    org: user.org,
                    action: session.type === 'PAYMENT' ? '지급' : '탑승',
                    sessionId: session.id,
                    sessionTitle: session.title,
                    bus: session.type === 'BOARDING' ? targetBus : '-',
                    amount: session.type === 'PAYMENT' ? session.price : 0,
                    penaltyApplied: penaltyApplied,
                    finalAmount: finalAmount
                };

                if (db) {
                    await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').add(newLog);
                    if (penaltyApplied > 0) {
                        const userRef = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(user.uid));
                        await userRef.update({ penaltyTotal: user.penaltyTotal - penaltyApplied });
                    }
                } else {
                    setLogs([newLog, ...logs]);
                    if (penaltyApplied > 0) {
                        const updatedUsers = users.map(u => u.uid === user.uid ? { ...u, penaltyTotal: u.penaltyTotal - penaltyApplied } : u);
                        setUsers(updatedUsers);
                    }
                }
                
                setScanResult({ status: 'success', msg: session.type==='PAYMENT'?'지급 완료':'탑승 확인', subMsg: session.title, user, logs: newLog });
            };

            const handleUserUpdate = async () => {
                if (!selectedUser || !editForm.optKey) return;
                
                const newPenalty = parseInt(editForm.penalty || 0);
                const changeLog = {
                    id: `CHG_${Date.now()}`,
                    timestamp: new Date().toLocaleString(),
                    uid: selectedUser.uid,
                    name: selectedUser.name,
                    targetOption: editForm.optKey,
                    oldVal: selectedUser.options[editForm.optKey],
                    newVal: editForm.optVal,
                    penalty: newPenalty,
                    reason: editForm.reason
                };

                if (db) {
                    const userRef = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(selectedUser.uid));
                    const updatedOptions = { ...selectedUser.options, [editForm.optKey]: editForm.optVal };
                    await userRef.update({ 
                        options: updatedOptions,
                        penaltyTotal: (selectedUser.penaltyTotal || 0) + newPenalty
                    });
                    await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('changelogs').add(changeLog);
                } else {
                    const updatedUsers = users.map(u => {
                        if (u.uid === selectedUser.uid) {
                            const newOptions = { ...u.options, [editForm.optKey]: editForm.optVal };
                            const totalPenalty = (u.penaltyTotal || 0) + newPenalty;
                            return { ...u, options: newOptions, penaltyTotal: totalPenalty };
                        }
                        return u;
                    });
                    setUsers(updatedUsers);
                    setChangeLogs([changeLog, ...changeLogs]);
                }
                
                alert("변경 및 패널티 적용이 완료되었습니다.");
                setEditForm({ optKey: '', optVal: '', penalty: 0, reason: '' });
                setSelectedUser(null);
                setSearchQuery('');
            };

            const scheduleStats = useMemo(() => {
                return schedules.map(s => {
                    let targetCount = 0;
                    if(s.targetKey === 'ALL') {
                        targetCount = users.length;
                    } else {
                        targetCount = users.filter(u => u.options && u.options[s.targetKey] && u.options[s.targetKey].includes(s.targetVal)).length;
                    }
                    
                    const doneCount = logs.filter(l => l.sessionId === s.id).length;
                    const percent = targetCount > 0 ? Math.round((doneCount / targetCount) * 100) : 0;
                    
                    const expectedAmount = targetCount * (s.price || 0);
                    const actualAmount = logs.filter(l => l.sessionId === s.id).reduce((sum, l) => sum + (l.finalAmount || 0), 0);
                    const diffCount = doneCount - targetCount;
                    const diffAmount = actualAmount - expectedAmount;

                    return { ...s, targetCount, doneCount, percent, expectedAmount, actualAmount, diffCount, diffAmount };
                });
            }, [schedules, users, logs]);

            const groupedStats = useMemo(() => {
                const groups = {};
                scheduleStats.forEach(stat => {
                    const date = stat.displayDate || '기타';
                    if(!groups[date]) groups[date] = [];
                    groups[date].push(stat);
                });
                return groups;
            }, [scheduleStats]);

            return (
                <div className="h-full flex flex-row bg-slate-50 w-full">
                    { !isMobile && <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} /> }
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative w-full">
                        { isMobile && (
                            <header className="bg-white px-6 py-4 shadow-sm flex justify-between items-center z-20 no-print">
                                <div className="flex items-center gap-2"><div className="w-8 h-8 bg-incar rounded-lg flex items-center justify-center text-white font-black">P</div><h1 className="font-black text-slate-800 tracking-tight">INCARPASS</h1></div>
                                <div className="text-xs font-bold text-slate-400">{users.length}명</div>
                            </header>
                        )}
                        <div className="flex-1 overflow-y-auto p-4 pb-24 md:p-8 md:pb-8 w-full no-print-scroll">
                            <div className="max-w-5xl mx-auto w-full">
                                {activeTab === 'dashboard' && <DashboardView users={users} logs={logs} scheduleStats={scheduleStats} groupedStats={groupedStats} changeLogs={changeLogs} />}
                                {activeTab === 'boarding' && <ScanView mode="BOARDING" schedules={schedules} targetSessionId={targetSessionId} setTargetSessionId={setTargetSessionId} targetBus={targetBus} setTargetBus={setTargetBus} manualBus={manualBus} setManualBus={setManualBus} isScanning={isScanning} setIsScanning={setIsScanning} processScan={processScan} users={users} isMobile={isMobile} />}
                                {activeTab === 'payment' && <ScanView mode="PAYMENT" schedules={schedules} targetSessionId={targetSessionId} setTargetSessionId={setTargetSessionId} targetBus={targetBus} setTargetBus={setTargetBus} manualBus={manualBus} setManualBus={setManualBus} isScanning={isScanning} setIsScanning={setIsScanning} processScan={processScan} users={users} isMobile={isMobile} />}
                                {activeTab === 'change' && <ChangeView searchQuery={searchQuery} setSearchQuery={setSearchQuery} selectedUser={selectedUser} setSelectedUser={setSelectedUser} editForm={editForm} setEditForm={setEditForm} handleUserUpdate={handleUserUpdate} users={users} />}
                                {activeTab === 'manage' && <ManageView users={users} handleUserUpload={handleUserUpload} handleScheduleUpload={handleScheduleUpload} badgeConfig={badgeConfig} setBadgeConfig={setBadgeConfig} db={db} serverError={serverError} schedules={schedules} logs={logs} setIsPrintMode={setIsPrintMode} />} {/* [수정] setIsPrintMode 추가 */}
                            </div>
                        </div>
                        { isMobile && <MobileTab activeTab={activeTab} setActiveTab={setActiveTab} /> }
                        {isPrintMode && <BadgePrintView users={users} config={badgeConfig} onClose={() => setIsPrintMode(false)} />}
                    </main>
                    <ResultModal result={scanResult} onClose={() => setScanResult(null)} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
