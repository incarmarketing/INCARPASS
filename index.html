<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>INCARPASS - í†µí•© ìš´ì˜ ì‹œìŠ¤í…œ</title>
    
    <!-- 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <!-- 2. Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- 3. ìŠ¤íƒ€ì¼ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { incar: '#27398C', 'incar-dark': '#1a2b6d', 'incar-light': '#eef2ff' },
                    boxShadow: { 'card': '0 4px 15px rgba(0,0,0,0.05)', 'nav': '0 -4px 20px rgba(0,0,0,0.05)' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; color: #1e293b; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        select, input { background-color: white !important; color: #1e293b !important; }
        option { color: #1e293b !important; background-color: #ffffff !important; }

        /* ì—‘ì…€ ìŠ¤íƒ€ì¼ í…Œì´ë¸” */
        .data-table th { background-color: #f8fafc; color: #64748b; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; padding: 12px 16px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        .data-table td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; font-weight: 500; }
        .data-table tr:hover td { background-color: #f8fafc; }
        
        #reader { width: 100%; border-radius: 1.5rem; overflow: hidden; border: none; }
        #reader video { object-fit: cover; border-radius: 1.5rem; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row bg-slate-50">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment } = React;

        // ============================================================
        // â–¼â–¼â–¼ [ì„¤ì •] íŒŒì´ì–´ë² ì´ìŠ¤ í‚¤ ì…ë ¥ë€ â–¼â–¼â–¼
        // ============================================================
        const firebaseConfig = {
            apiKey: "", 
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        const SYSTEM_APP_ID = 'inca-prod-v1';
        
        const DEFAULT_SCHEDULES = [
            { id: 'D1_1', date:'2026-03-11', title: '1ì¼ì°¨ ê³µí•­ ë¯¸íŒ… (08:00)', price: 0, type: 'BOARDING', expected: 100 },
            { id: 'D1_2', date:'2026-03-11', title: '1ì¼ì°¨ ë‹¨ìˆ˜ì´ íˆ¬ì–´', price: 0, type: 'BOARDING', expected: 100 },
            { id: 'D1_3', date:'2026-03-11', title: '1ì¼ì°¨ ì„ì‹ (íƒ€ì¹´ì˜¤ 1972)', price: 30, type: 'PAYMENT', expected: 100 },
            { id: 'D1_4', date:'2026-03-11', title: '1ì¼ì°¨ íƒ€ì´ë² ì´ 101', price: 0, type: 'BOARDING', expected: 100 },
            { id: 'D2_1', date:'2026-03-12', title: '2ì¼ì°¨ ì„ íƒê´€ê´‘ ì§‘ê²°', price: 0, type: 'BOARDING', expected: 100 },
            { id: 'D2_2', date:'2026-03-12', title: '2ì¼ì°¨ ì¸ì¹´ ë§Œì°¬ (í•„ìˆ˜)', price: 0, type: 'BOARDING', expected: 100 },
            { id: 'D3_1', date:'2026-03-13', title: '3ì¼ì°¨ ì•¼ë¥˜ í•´ì–‘ê³µì›', price: 0, type: 'BOARDING', expected: 100 },
            { id: 'D3_2', date:'2026-03-13', title: '3ì¼ì°¨ ì¤‘ì‹ (ì”¨í‘¸ë“œ)', price: 30, type: 'PAYMENT', expected: 100 },
            { id: 'D3_3', date:'2026-03-13', title: '3ì¼ì°¨ ìŠ¤í€ ì²œë“± ë‚ ë¦¬ê¸°', price: 0, type: 'BOARDING', expected: 100 },
            { id: 'D3_4', date:'2026-03-13', title: '3ì¼ì°¨ ì§€ìš°í€ ì•¼ê²½', price: 0, type: 'BOARDING', expected: 100 },
            { id: 'D4_1', date:'2026-03-14', title: '4ì¼ì°¨ ê³µí•­ ìƒŒë”©', price: 0, type: 'BOARDING', expected: 100 }
        ];

        // --- ê³µí†µ: ì •ë ¬ í•¨ìˆ˜ (ë‚ ì§œìˆœ -> IDìˆœ) ---
        const sortSchedules = (list) => {
            return list.sort((a, b) => {
                if (a.date !== b.date) return a.date > b.date ? 1 : -1;
                return a.id.localeCompare(b.id);
            });
        };

        // --- ì•„ì´ì½˜ ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                camera: <g><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></g>,
                qr: <g><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><path d="M3 14h7v7H3z"/></g>,
                layout: <g><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></g>,
                check: <polyline points="20 6 9 17 4 12"/>,
                x: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
                users: <g><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                dollar: <g><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></g>,
                settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
                plus: <g><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></g>,
                edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></g>,
                trash: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></g>,
                refresh: <g><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></g>,
                database: <g><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></g>,
                activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>,
                calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></g>,
                alert: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></g>,
                chevronRight: <polyline points="9 18 15 12 9 6"/>,
                bus: <g><path d="M19 17h2l.64-2.54c.24-1.12.36-2.26.36-3.41V8.5a4.5 4.5 0 0 0-4.5-4.5h-11A4.5 4.5 0 0 0 2 8.5v2.55c0 1.15.12 2.29.36 3.41L3 17h2"/><path d="M15 17v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2"/><path d="M16 8.5h.01"/><path d="M8 8.5h.01"/></g>,
                table: <g><path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/></g>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10"/>}</svg>;
        };

        // --- ê²°ê³¼ ëª¨ë‹¬ ---
        const ScanResultModal = ({ scanResult, setScanResult }) => {
            if (!scanResult) return null;
            const { status, msg, subMsg, amount, user } = scanResult;

            useEffect(() => {
                if (status === 'success') {
                    const timer = setTimeout(() => setScanResult(null), 2500);
                    return () => clearTimeout(timer);
                }
            }, [status]);

            const colors = {
                success: { bg: 'bg-emerald-50', text: 'text-emerald-700', icon: 'text-emerald-500', btn: 'bg-emerald-600' },
                duplicate: { bg: 'bg-amber-50', text: 'text-amber-700', icon: 'text-amber-500', btn: 'bg-amber-600' },
                error: { bg: 'bg-rose-50', text: 'text-rose-700', icon: 'text-rose-500', btn: 'bg-rose-600' }
            };
            const theme = colors[status] || colors.error;

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center z-[200] p-6 animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden ring-1 ring-black/5">
                        <div className={`p-10 flex flex-col items-center text-center ${theme.bg}`}>
                            <Icon name={status === 'success' ? 'check' : status === 'duplicate' ? 'alert' : 'x'} size={80} className={`${theme.icon} mb-4 drop-shadow-sm`} />
                            <h3 className={`text-2xl font-black ${theme.text} mb-1`}>{msg}</h3>
                            <p className="text-slate-500 text-sm font-medium">{subMsg}</p>
                        </div>
                        {user && (
                            <div className="p-8 bg-white space-y-4">
                                <div className="flex items-center gap-4 p-5 bg-slate-50 rounded-2xl border border-slate-100">
                                    <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center text-xl font-black text-incar border-2 border-slate-100 shadow-sm">{user.name[0]}</div>
                                    <div className="text-left">
                                        <div className="font-black text-gray-900 text-xl leading-none mb-1">{user.name}</div>
                                        <div className="text-xs text-slate-400 font-bold uppercase tracking-tight">{user.affiliation} Â· {user.bus}</div>
                                    </div>
                                </div>
                                {amount > 0 && (
                                    <div className="flex justify-between items-center p-4 bg-emerald-50/50 rounded-2xl border border-emerald-100">
                                        <span className="text-xs font-black text-emerald-700 uppercase tracking-widest">ì§€ê¸‰ ê¸ˆì•¡</span>
                                        <span className="text-3xl font-black text-emerald-600">${amount}</span>
                                    </div>
                                )}
                            </div>
                        )}
                        <div className="p-4 px-8 pb-8 bg-white">
                            <button onClick={() => setScanResult(null)} className={`w-full py-5 rounded-2xl font-black text-white shadow-xl transition-transform active:scale-95 ${theme.btn}`}>í™•ì¸ ì™„ë£Œ</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ì¼ì • í¸ì§‘ ëª¨ë‹¬ ---
        const ScheduleEditorModal = ({ editingSchedule, setEditingSchedule, handleSaveSchedule }) => {
            const [formData, setFormData] = useState({ title: '', price: 0, expected: 0, date: '' });
            useEffect(() => { if(editingSchedule) setFormData(editingSchedule); }, [editingSchedule]);
            if (!editingSchedule) return null;

            return (
                <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[200] p-6 animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h3 className="font-black text-slate-900 text-lg">{editingSchedule.id ? 'ì¼ì • ìˆ˜ì •' : 'ìƒˆ ì¼ì •'}</h3>
                            <button onClick={() => setEditingSchedule(null)} className="text-slate-400 hover:text-slate-600 transition-colors"><Icon name="x" size={24}/></button>
                        </div>
                        <div className="p-8 space-y-4">
                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">ë‚ ì§œ</label>
                                <input type="date" value={formData.date || ''} onChange={e=>setFormData({...formData, date: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-900 focus:ring-2 focus:ring-incar outline-none" />
                            </div>
                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">ì¼ì •ëª…</label>
                                <input type="text" value={formData.title} onChange={e=>setFormData({...formData, title: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-900 focus:ring-2 focus:ring-incar outline-none" />
                            </div>
                            <div className="flex gap-2">
                                {['BOARDING', 'PAYMENT'].map(type => (
                                    <button key={type} onClick={()=>setFormData(prev => ({...prev, type}))} className={`flex-1 py-3 rounded-xl text-xs font-black transition-all ${formData.type === type ? 'bg-white text-incar shadow-sm ring-2 ring-incar' : 'bg-slate-100 text-slate-500'}`}>
                                        {type === 'PAYMENT' ? 'ğŸ’° ì§€ê¸‰' : 'ğŸšŒ íƒ‘ìŠ¹'}
                                    </button>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">ì˜ˆìƒ ì¸ì›</label>
                                    <input type="number" value={formData.expected} onChange={e=>setFormData({...formData, expected: Number(e.target.value)})} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-900 focus:ring-2 focus:ring-incar outline-none text-center" />
                                </div>
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">1ì¸ ê¸ˆì•¡($)</label>
                                    <input type="number" value={formData.price} onChange={e=>setFormData({...formData, price: Number(e.target.value)})} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-900 focus:ring-2 focus:ring-incar outline-none text-center" disabled={formData.type !== 'PAYMENT'} />
                                </div>
                            </div>
                        </div>
                        <div className="p-6 border-t border-slate-100 flex gap-3 bg-slate-50/50">
                            <button onClick={() => setEditingSchedule(null)} className="flex-1 py-4 bg-white border border-slate-200 text-slate-600 font-bold rounded-2xl hover:bg-slate-50">ì·¨ì†Œ</button>
                            <button onClick={() => handleSaveSchedule(editingSchedule.id, formData)} className="flex-1 py-4 bg-incar text-white font-black rounded-2xl shadow-lg hover:bg-incar-dark">ì €ì¥</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- [í™”ë©´ 1] ëŒ€ì‹œë³´ë“œ ---
        const DashboardView = ({ stats, schedules, currentSessionId, logs, handleRefresh }) => {
            const groupedSchedules = useMemo(() => {
                const groups = {};
                sortSchedules([...schedules]).forEach(s => {
                    const date = s.date || 'ë‚ ì§œ ë¯¸ì •';
                    if (!groups[date]) groups[date] = [];
                    groups[date].push(s);
                });
                return groups;
            }, [schedules]);

            return (
                <div className="space-y-8 animate-fade-in pb-24 md:pb-8">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-8 rounded-[2rem] border-t-8 border-incar shadow-card hover:shadow-xl transition-all group">
                            <div className="flex justify-between items-start mb-4">
                                <p className="text-xs text-slate-400 font-black uppercase tracking-widest">Total Scans</p>
                                <div className="p-3 bg-indigo-50 rounded-2xl text-incar group-hover:scale-110 transition-transform"><Icon name="users" size={24} /></div>
                            </div>
                            <h3 className="text-5xl font-black text-slate-900 tracking-tighter leading-none mb-2">{stats.totalCount}<span className="text-xl font-bold text-slate-300 ml-1">ëª…</span></h3>
                        </div>
                        <div className="bg-white p-8 rounded-[2rem] border-t-8 border-emerald-500 shadow-card hover:shadow-xl transition-all group">
                            <div className="flex justify-between items-start mb-4">
                                <p className="text-xs text-slate-400 font-black uppercase tracking-widest">Total Settle</p>
                                <div className="p-3 bg-emerald-50 rounded-2xl text-emerald-600 group-hover:scale-110 transition-transform"><Icon name="dollar" size={24} /></div>
                            </div>
                            <h3 className="text-5xl font-black text-slate-900 tracking-tighter leading-none mb-2">${stats.totalAmount.toLocaleString()}</h3>
                        </div>
                        <div className="bg-incar-gradient p-8 rounded-[2rem] shadow-2xl border-t-8 border-blue-400 text-white relative overflow-hidden group">
                            <div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="layout" size={120} /></div>
                            <p className="text-xs text-blue-200 font-black uppercase tracking-widest mb-3">Live Session</p>
                            <h3 className="text-xl font-bold truncate mb-6 pb-4 border-b border-white/10">{schedules.find(s=>s.id===currentSessionId)?.title || 'ì„¸ì…˜ ë¯¸ì„ íƒ'}</h3>
                            <div className="flex justify-between items-end">
                                <span className="text-5xl font-black">{stats.currentCount}<span className="text-xl ml-2 font-bold opacity-70">ëª…</span></span>
                                <div className="flex items-center gap-1.5 text-[10px] font-black bg-white/20 px-3 py-1.5 rounded-full"><div className="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></div> LIVE</div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-8 rounded-[2rem] shadow-card border border-slate-200">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-black text-xl text-slate-900 flex items-center gap-3">
                                <div className="w-2 h-8 bg-incar rounded-full"></div> ì¼ìë³„ í˜„í™© ë¦¬í¬íŠ¸
                            </h3>
                            <button onClick={()=>window.print()} className="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl font-bold text-xs hover:bg-slate-200 flex items-center gap-2">
                                <Icon name="layout" size={14}/> ì¶œë ¥
                            </button>
                        </div>
                        {Object.entries(groupedSchedules).sort().map(([date, scheds]) => (
                            <div key={date} className="mb-8 last:mb-0">
                                <h4 className="text-xs font-black text-incar bg-indigo-50 px-3 py-1.5 rounded-lg inline-block mb-4 shadow-sm">{date}</h4>
                                <div className="overflow-x-auto rounded-xl border border-slate-200">
                                    <table className="w-full text-left data-table">
                                        <thead>
                                            <tr>
                                                <th className="w-1/3">ì¼ì •ëª…</th>
                                                <th className="text-center">êµ¬ë¶„</th>
                                                <th className="text-right">ì˜ˆì•½</th>
                                                <th className="text-right">ì‹¤ì œ</th>
                                                <th className="text-right">ì˜ˆìƒì•¡</th>
                                                <th className="text-right">ì§€ê¸‰ì•¡</th>
                                                <th className="text-center">ì°¨ì´</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {scheds.map(s => {
                                                const actualCount = logs.filter(l => l.sessionId === s.id).length;
                                                const actualAmount = logs.filter(l => l.sessionId === s.id).reduce((sum, l) => sum + (l.amount||0), 0);
                                                const expectedAmount = s.type === 'PAYMENT' ? (s.price * s.expected) : 0;
                                                const diff = actualCount - s.expected;
                                                return (
                                                    <tr key={s.id}>
                                                        <td className="font-bold text-slate-700">{s.title}</td>
                                                        <td className="text-center"><span className={`px-2 py-0.5 rounded text-[10px] font-black border ${s.type==='PAYMENT'?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-indigo-50 text-incar border-indigo-100'}`}>{s.type==='PAYMENT'?'ì§€ê¸‰':'íƒ‘ìŠ¹'}</span></td>
                                                        <td className="text-right text-slate-500">{s.expected}</td>
                                                        <td className="text-right font-bold text-slate-900">{actualCount}</td>
                                                        <td className="text-right text-slate-400">{s.type==='PAYMENT' ? `$${expectedAmount.toLocaleString()}` : '-'}</td>
                                                        <td className="text-right font-bold text-emerald-600">{s.type==='PAYMENT' ? `$${actualAmount.toLocaleString()}` : '-'}</td>
                                                        <td className="text-center">{diff === 0 ? <span className="text-emerald-500 font-bold text-xs">OK</span> : diff < 0 ? <span className="text-rose-500 font-bold text-xs">{diff}</span> : <span className="text-blue-500 font-bold text-xs">+{diff}</span>}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="bg-white rounded-[2.5rem] border border-slate-200 shadow-card overflow-hidden">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white">
                            <h3 className="font-black text-lg text-slate-900 flex items-center gap-3"><div className="w-2 h-6 bg-incar rounded-full"></div> ì‹¤ì‹œê°„ ë¡œê·¸</h3>
                            <button onClick={handleRefresh} className="text-xs border px-4 py-2 rounded-xl hover:bg-slate-50 flex items-center gap-2 font-bold text-slate-500"><Icon name="refresh" size={14}/> ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                        <div className="overflow-x-auto max-h-[400px]">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-50 text-slate-500 text-xs font-bold uppercase sticky top-0">
                                    <tr><th className="p-5 pl-8">Time</th><th className="p-5">User</th><th className="p-5">Session</th><th className="p-5">Type</th><th className="p-5 pr-8 text-right">Balance</th></tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    {logs.length === 0 ? <tr><td colSpan="5" className="p-20 text-center text-slate-300 font-bold italic">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr> : logs.map(log => (
                                        <tr key={log.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-5 pl-8 font-mono text-xs text-slate-400 font-medium">{log.displayTime.split(' ')[1]||log.displayTime}</td>
                                            <td className="p-5 font-bold text-slate-800">{log.name} <span className="text-xs text-slate-400 font-normal">({log.affiliation})</span></td>
                                            <td className="p-5 text-slate-600 font-bold text-xs">{log.sessionTitle}</td>
                                            <td className="p-5"><span className={`px-3 py-1 rounded-full text-[10px] font-black border ${log.action==='ì§€ê¸‰'?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-indigo-50 text-incar border-indigo-100'}`}>{log.action}</span></td>
                                            <td className="p-5 pr-8 text-right font-black text-slate-900 text-base">{log.amount>0 ? `$${log.amount}` : '-'}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- [í™”ë©´ 2] ìŠ¤ìº” ë·° ---
        const ScanView = ({ mode, schedules, currentSessionId, setCurrentSessionId, stats, scannerActive, setScannerActive, logs, handleScan }) => {
            const filteredSchedules = useMemo(() => {
                if (mode === 'PAYMENT') return schedules.filter(s => s.price > 0);
                return schedules; 
            }, [mode, schedules]);

            useEffect(() => {
                if (filteredSchedules.length > 0) {
                     const exists = filteredSchedules.find(s => s.id === currentSessionId);
                     if (!exists) setCurrentSessionId(filteredSchedules[0].id);
                } else {
                    setCurrentSessionId('');
                }
            }, [mode, filteredSchedules]);

            const currentCount = logs.filter(l => l.sessionId === currentSessionId && (mode === 'PAYMENT' ? l.action === 'ì§€ê¸‰' : l.action === 'íƒ‘ìŠ¹')).length;
            
            return (
                <div className="space-y-6 animate-fade-in max-w-lg mx-auto pb-24 md:pb-8">
                    <div className="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-card">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className={`font-black flex items-center gap-3 text-lg leading-none ${mode==='PAYMENT'?'text-emerald-700':'text-incar'}`}>
                                <Icon name={mode==='PAYMENT'?'dollar':'bus'} size={24} /> {mode==='PAYMENT'?'ë¹„ìš© ì§€ê¸‰':'íƒ‘ìŠ¹ í™•ì¸'}
                            </h3>
                            <span className="text-xs font-black text-slate-400 bg-slate-100 px-3 py-1.5 rounded-xl uppercase">{new Date().toLocaleDateString('ko-KR')}</span>
                        </div>
                        <div className="mb-6">
                            <label className="block text-[10px] font-black text-slate-400 mb-3 tracking-widest uppercase ml-1">Target Session</label>
                            <div className="relative group">
                                <select value={currentSessionId} onChange={(e) => setCurrentSessionId(e.target.value)} className={`w-full p-5 bg-slate-50 border border-slate-200 rounded-[1.5rem] font-black text-slate-900 appearance-none focus:outline-none focus:ring-4 transition-all text-xl shadow-inner group-hover:border-opacity-50 ${mode==='PAYMENT'?'focus:ring-emerald-500/10 group-hover:border-emerald-500':'focus:ring-incar/10 group-hover:border-incar'}`}>
                                    {filteredSchedules.length === 0 ? <option value="">ê°€ëŠ¥í•œ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</option> : filteredSchedules.map(s => <option key={s.id} value={s.id}>{s.title}</option>)}
                                </select>
                                <div className="absolute right-6 top-1/2 -translate-y-1/2 text-slate-300 pointer-events-none group-hover:text-slate-500"><Icon name="chevronRight" size={24} className="rotate-90" /></div>
                            </div>
                        </div>
                        <div className={`flex items-center justify-between p-5 rounded-[1.5rem] border border-dashed ${mode==='PAYMENT'?'bg-emerald-50 border-emerald-200':'bg-indigo-50 border-indigo-200'}`}>
                            <span className={`font-black uppercase tracking-tighter ${mode==='PAYMENT'?'text-emerald-700':'text-incar'}`}>ì™„ë£Œ ì¸ì›</span>
                            <span className="font-black text-slate-900 text-xl leading-none">{currentCount}<span className="text-xs font-bold text-slate-400 ml-1">ëª…</span></span>
                        </div>
                    </div>

                    <div className="bg-white rounded-[3rem] border border-slate-200 shadow-card p-8 flex flex-col items-center justify-center relative overflow-hidden group min-h-[400px]">
                        {scannerActive ? (
                            <div id="reader" className="w-full h-full relative z-10 animate-fade-in shadow-2xl overflow-hidden rounded-[2rem]"></div>
                        ) : (
                            <div className="text-center space-y-6 animate-fade-in">
                                <div className={`w-40 h-40 rounded-[3rem] flex items-center justify-center text-slate-200 mx-auto ring-1 ring-slate-100 shadow-inner ${mode==='PAYMENT'?'bg-emerald-50 text-emerald-200':'bg-indigo-50 text-indigo-200'}`}><Icon name="camera" size={80}/></div>
                                <div className="space-y-2">
                                    <h4 className="font-black text-slate-800 text-xl">ì¹´ë©”ë¼ ëŒ€ê¸° ì¤‘</h4>
                                    <p className="text-sm text-slate-400 font-medium">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŠ¤ìº”ì„ ì‹œì‘í•˜ì„¸ìš”</p>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="flex flex-col gap-3">
                        {!scannerActive ? (
                            <button onClick={()=>setScannerActive(true)} className={`w-full py-5 text-white font-black rounded-3xl shadow-2xl active:scale-95 transition-all text-xl flex items-center justify-center gap-4 ${mode==='PAYMENT'?'bg-emerald-600 shadow-emerald-900/30 hover:bg-emerald-700':'bg-incar shadow-indigo-900/30 hover:bg-incar-dark'}`}><Icon name="camera" size={28}/> ìŠ¤ìº” ì‹œì‘í•˜ê¸°</button>
                        ) : (
                            <button onClick={()=>setScannerActive(false)} className="w-full py-5 bg-rose-500 text-white font-black rounded-3xl shadow-xl active:scale-95 transition-all text-xl flex items-center justify-center gap-4"><Icon name="x" size={28}/> ìŠ¤ìº” ì¤‘ë‹¨</button>
                        )}
                    </div>
                </div>
            );
        };

        // --- [í™”ë©´ 4] ê´€ë¦¬ ë·° ---
        const ManageView = ({ schedules, setEditingSchedule, handleDeleteSchedule, handleInitializeDB, handleScan }) => (
            <div className="space-y-6 animate-fade-in pb-24 md:pb-8">
                <div className="bg-white p-8 rounded-[2.5rem] shadow-card flex justify-between items-center border border-slate-100">
                    <div><h3 className="text-2xl font-black text-slate-900 leading-none">ì¼ì • ê´€ë¦¬</h3><p className="text-sm text-slate-400 font-medium mt-2 uppercase tracking-wide">ê¸ˆì•¡ì´ $0ì´ë©´ 'íƒ‘ìŠ¹' ì „ìš©ì…ë‹ˆë‹¤.</p></div>
                    <button onClick={()=>setEditingSchedule({id:'',title:'',price:0, expected:100, date: new Date().toISOString().split('T')[0]})} className="p-4 bg-incar text-white rounded-2xl shadow-xl hover:bg-incar-dark active:scale-95 transition-all"><Icon name="plus" size={24}/></button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {sortSchedules([...schedules]).map(s => (
                        <div key={s.id} className="p-6 bg-white rounded-3xl border border-slate-100 shadow-sm flex justify-between items-center group hover:border-incar hover:shadow-xl transition-all duration-300">
                            <div className="flex items-center gap-4">
                                <div className={`p-3 rounded-2xl ${s.price > 0 ?'bg-emerald-50 text-emerald-600':'bg-indigo-50 text-incar'}`}><Icon name={s.price > 0 ?'dollar':'camera'} size={24}/></div>
                                <div>
                                    <div className="flex gap-2 mb-1">
                                        <span className="text-[10px] font-black bg-slate-100 text-slate-500 px-2 py-0.5 rounded">{s.date || 'ë‚ ì§œë¯¸ì •'}</span>
                                        <span className={`text-[10px] font-black uppercase px-2 py-0.5 rounded border inline-block ${s.price > 0 ?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-indigo-50 text-incar border-indigo-100'}`}>{s.price > 0 ?'ì§€ê¸‰/íƒ‘ìŠ¹':'íƒ‘ìŠ¹ì „ìš©'}</span>
                                    </div>
                                    <h4 className="font-black text-slate-800">{s.title}</h4>
                                    <p className="text-xs text-slate-400 font-bold mt-1">ì˜ˆì•½: {s.expected}ëª… {s.price > 0 ? ` / $${s.price}` : ''}</p>
                                </div>
                            </div>
                            <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-all translate-x-4 group-hover:translate-x-0"><button onClick={()=>setEditingSchedule(s)} className="p-3 bg-slate-50 rounded-xl hover:text-incar transition-colors"><Icon name="edit" size={16}/></button><button onClick={()=>handleDeleteSchedule(s.id)} className="p-3 bg-rose-50 text-rose-500 rounded-xl hover:bg-rose-100 transition-colors"><Icon name="trash" size={16}/></button></div>
                        </div>
                    ))}
                </div>

                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-card mt-6">
                    <h3 className="font-bold text-slate-800 mb-4 text-lg">ì‹œìŠ¤í…œ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h3>
                    <button onClick={()=>handleScan('1611499_A')} className="w-full py-3 bg-white border border-slate-200 text-slate-500 rounded-xl font-bold text-sm hover:bg-slate-50 active:scale-95 transition-all">
                        ìŠ¤ìº” ì‹œë®¬ë ˆì´ì…˜ (í™ê¸¸ë™)
                    </button>
                    <p className="text-xs text-slate-400 mt-2">* í˜„ì¬ ì„ íƒëœ ì„¸ì…˜(íƒ‘ìŠ¹/ì§€ê¸‰)ì„ ê¸°ì¤€ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</p>
                </div>

                <div className="p-8 bg-slate-900 rounded-[2.5rem] text-white flex justify-between items-center shadow-2xl relative overflow-hidden group">
                    <div className="absolute inset-0 bg-incar opacity-0 group-hover:opacity-20 transition-opacity"></div>
                    <div className="relative z-10"><h4 className="font-black text-lg leading-none uppercase tracking-widest mb-1">Database Maintenance</h4><p className="text-xs text-slate-400 font-medium italic">ISC 3ë°• 4ì¼ ì¼ì •ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p></div>
                    <button onClick={handleInitializeDB} className="px-8 py-4 bg-white text-slate-900 rounded-2xl font-black text-xs hover:bg-slate-100 transition-all shadow-lg active:scale-95">ì„œë²„ DB ì´ˆê¸°í™”</button>
                </div>
            </div>
        );

        // --- [ë©”ì¸ App] ---
        function App() {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [schedules, setSchedules] = useState([]);
            const [logs, setLogs] = useState([]);
            const [currentSessionId, setCurrentSessionId] = useState('');
            const [scanResult, setScanResult] = useState(null);
            const [editingSchedule, setEditingSchedule] = useState(null);
            const [scannerActive, setScannerActive] = useState(false);
            const [isLoading, setIsLoading] = useState(true);

            // ì´ˆê¸°í™”
            useEffect(() => {
                const init = async () => {
                    try {
                        if(firebaseConfig.apiKey) {
                            if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                            const _db = firebase.firestore();
                            setDb(_db);
                            await firebase.auth().signInAnonymously();
                            firebase.auth().onAuthStateChanged(u => { setUser(u); if(!u) setIsLoading(false); });
                        } else { initLocal(); }
                    } catch(e) { console.error(e); initLocal(); }
                };
                init();
                const resize = () => { setIsMobile(window.innerWidth < 768); if(window.innerWidth < 768 && activeTab === 'dashboard') setActiveTab('boarding'); };
                window.addEventListener('resize', resize);
                return () => window.removeEventListener('resize', resize);
            }, []);

            const initLocal = () => {
                setIsLoading(false);
                const localSched = JSON.parse(localStorage.getItem('inca_schedules') || '[]');
                const localLogs = JSON.parse(localStorage.getItem('inca_logs') || '[]');
                if(localSched.length === 0) setSchedules(DEFAULT_SCHEDULES);
                else setSchedules(localSched);
                setLogs(localLogs);
            };

            // DB ë™ê¸°í™”
            useEffect(() => {
                if(db && user) {
                    const unsubS = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').onSnapshot(snap => {
                        const list = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=> (a.date > b.date) ? 1 : -1);
                        if (list.length === 0) {
                             setSchedules([]);
                        } else {
                            setSchedules(list);
                        }
                    });
                    const unsubL = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').orderBy('timestamp','desc').onSnapshot(snap => {
                        setLogs(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        setIsLoading(false);
                    });
                    return () => { unsubS(); unsubL(); };
                } else if (!db) {
                    // ë¡œì»¬ ëª¨ë“œ ì €ì¥
                    if (schedules.length === 0) setSchedules(DEFAULT_SCHEDULES);
                    localStorage.setItem('inca_schedules', JSON.stringify(schedules));
                    localStorage.setItem('inca_logs', JSON.stringify(logs));
                }
            }, [db, user, schedules, logs]);

            useEffect(() => {
                if (scannerActive && (activeTab === 'boarding' || activeTab === 'payment')) {
                    const html5QrCode = new Html5Qrcode("reader");
                    const config = { fps: 10, qrbox: { width: 280, height: 280 } };
                    html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                        handleScan(decodedText);
                        setScannerActive(false);
                        html5QrCode.stop();
                    }).catch(err => { console.error("Camera access error:", err); setScannerActive(false); });
                    return () => { if (html5QrCode.isScanning) html5QrCode.stop().catch(e => {}); };
                }
            }, [scannerActive, activeTab]);

            const handleScan = async (uid) => {
                const MOCK_USERS = [
                    { uid: '1611499_A', name: 'í™ê¸¸ë™', bus: '1í˜¸ì°¨', affiliation: 'ë³¸ì‚¬' },
                    { uid: '1611499_B', name: 'ê¹€ì˜í¬', bus: '1í˜¸ì°¨', affiliation: 'ì§€ì‚¬' }
                ];
                const target = MOCK_USERS.find(u => u.uid === uid);
                const sched = schedules.find(s => s.id === currentSessionId);
                
                if(!target) return setScanResult({ status: 'error', msg: 'ë¯¸ë“±ë¡', subMsg: 'QR í™•ì¸ í•„ìš”' });
                if(!sched) return setScanResult({ status: 'error', msg: 'ì¼ì • ë¯¸ì„ íƒ', subMsg: 'ì„¸ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.' });
                
                const actionType = activeTab === 'payment' ? 'ì§€ê¸‰' : 'íƒ‘ìŠ¹';
                
                if(logs.some(l => l.uid === uid && l.sessionId === currentSessionId && l.action === actionType)) 
                    return setScanResult({ status: 'duplicate', msg: 'ì¤‘ë³µ', subMsg: 'ì´ë¯¸ ì²˜ë¦¬ë¨', user: target });

                const newLog = {
                    uid: target.uid, name: target.name, affiliation: target.affiliation,
                    sessionId: sched.id, sessionTitle: sched.title, action: actionType,
                    amount: actionType === 'ì§€ê¸‰' ? sched.price : 0,
                    timestamp: new Date().toISOString(), displayTime: new Date().toLocaleString()
                };

                if(db) await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').add(newLog);
                else setLogs(p => [newLog, ...p]);

                setScanResult({ status: 'success', msg: actionType + ' ì™„ë£Œ', subMsg: sched.title, amount: newLog.amount, user: target });
            };

            const handleInitDB = async () => {
                if(!confirm("DBë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ISC ëŒ€ë§Œ ì¼ì • ë°˜ì˜)")) return;
                setIsLoading(true);
                if(db) {
                    try {
                        const batch = db.batch();
                        DEFAULT_SCHEDULES.forEach(s => batch.set(db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').doc(s.id), s));
                        await batch.commit();
                        alert("ì„œë²„ ì´ˆê¸°í™” ì™„ë£Œ");
                    } catch(e) { alert("ì˜¤ë¥˜: "+e.message); }
                } else {
                    setSchedules(DEFAULT_SCHEDULES); setLogs([]); localStorage.clear();
                    localStorage.setItem('inca_schedules', JSON.stringify(DEFAULT_SCHEDULES));
                    alert("ë¡œì»¬ ì´ˆê¸°í™” ì™„ë£Œ");
                }
                setIsLoading(false);
            };

            const handleSaveSched = async (id, data) => {
                const sid = id || `S_${Date.now()}`;
                const newData = { ...data, id: sid };
                
                if(db) {
                    await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').doc(sid).set(newData);
                } else {
                    // [ë¡œì»¬ ëª¨ë“œ ìˆ˜ì •] ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ì—ì„œ idê°€ ë‹¤ë¥¸ ê²ƒë§Œ ë‚¨ê¸°ê³  ìƒˆ ë°ì´í„° ì¶”ê°€ í›„ ì •ë ¬
                    const next = schedules.filter(s => s.id !== id);
                    const updatedList = [...next, newData];
                    // ë‚ ì§œìˆœ ì •ë ¬ ë³´ì¥
                    sortSchedules(updatedList);
                    setSchedules(updatedList);
                }
                setEditingSchedule(null);
            };

            const handleDelSched = async (id) => {
                if(!confirm("ì‚­ì œ?")) return;
                if(db) await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').doc(id).delete();
                else setSchedules(schedules.filter(s => s.id !== id));
            };

            const stats = useMemo(() => {
                return {
                    totalCount: logs.length,
                    totalAmount: logs.reduce((s, l) => s + (Number(l.amount)||0), 0),
                    currentCount: logs.filter(l => l.sessionId === currentSessionId).length
                };
            }, [logs, currentSessionId]);

            // --- ë Œë”ë§ ---
            return (
                <div className="flex h-full w-full">
                    {/* PC Sidebar */}
                    {!isMobile && (
                        <aside className="w-72 bg-incar text-white h-full shadow-2xl flex flex-col z-20">
                            <div className="p-8 border-b border-white/10 flex items-center gap-3">
                                <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center font-black">P</div>
                                <div><span className="font-bold block leading-none">INCARPASS</span><span className="text-[10px] text-blue-200 opacity-80">PRO EDITION</span></div>
                            </div>
                            <nav className="flex-1 px-4 py-6 space-y-2">
                                <button onClick={()=>setActiveTab('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${activeTab==='dashboard'?'bg-white text-incar shadow-lg':'text-blue-200 hover:bg-white/10'}`}><Icon name="layout"/> ëŒ€ì‹œë³´ë“œ</button>
                                <button onClick={()=>setActiveTab('boarding')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${activeTab==='boarding'?'bg-white text-incar shadow-lg':'text-blue-200 hover:bg-white/10'}`}><Icon name="bus"/> íƒ‘ìŠ¹ í™•ì¸</button>
                                <button onClick={()=>setActiveTab('payment')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${activeTab==='payment'?'bg-white text-incar shadow-lg':'text-blue-200 hover:bg-white/10'}`}><Icon name="dollar"/> ë¹„ìš© ì§€ê¸‰</button>
                                <button onClick={()=>setActiveTab('manage')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${activeTab==='manage'?'bg-white text-incar shadow-lg':'text-blue-200 hover:bg-white/10'}`}><Icon name="settings"/> ìœ ì§€ë³´ìˆ˜</button>
                            </nav>
                            <div className="p-5 border-t border-white/10 flex items-center gap-2 text-xs font-bold text-blue-200">
                                <div className={`w-2.5 h-2.5 rounded-full ${db?'bg-emerald-400':'bg-amber-400'}`}></div> {db?'Server Online':'Local Mode'}
                            </div>
                        </aside>
                    )}

                    <div className="flex-1 flex flex-col relative bg-slate-50">
                        {/* Header */}
                        <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-10 shadow-sm">
                            <h2 className="text-lg font-bold text-slate-800">{activeTab==='dashboard'?'í†µí•© ëŒ€ì‹œë³´ë“œ':activeTab==='boarding'?'íƒ‘ìŠ¹ ìŠ¤ìº”':activeTab==='payment'?'ì§€ê¸‰ ìŠ¤ìº”':'ì‹œìŠ¤í…œ ìœ ì§€ë³´ìˆ˜'}</h2>
                            {isMobile && <div className="w-8 h-8 bg-incar rounded-lg flex items-center justify-center text-white font-bold text-xs">P</div>}
                        </header>

                        {/* Main Content */}
                        <main className="flex-1 overflow-y-auto p-4 pb-24 md:pb-8">
                            <div className="max-w-7xl mx-auto">
                                {isLoading ? <div className="flex flex-col items-center justify-center h-96 text-slate-400"><div className="loader mb-4"></div>ë¡œë”©ì¤‘...</div> : (
                                    <Fragment>
                                        {activeTab === 'dashboard' && <DashboardView stats={stats} schedules={schedules} currentSessionId={currentSessionId} logs={logs} handleRefresh={()=>window.location.reload()} />}
                                        {activeTab === 'boarding' && <ScanView mode="BOARDING" schedules={schedules} currentSessionId={currentSessionId} setCurrentSessionId={setCurrentSessionId} stats={stats} scannerActive={scannerActive} setScannerActive={setScannerActive} logs={logs} handleScan={handleScan} />}
                                        {activeTab === 'payment' && <ScanView mode="PAYMENT" schedules={schedules} currentSessionId={currentSessionId} setCurrentSessionId={setCurrentSessionId} stats={stats} scannerActive={scannerActive} setScannerActive={setScannerActive} logs={logs} handleScan={handleScan} />}
                                        {activeTab === 'manage' && <ManageView schedules={schedules} setEditingSchedule={setEditingSchedule} handleDeleteSchedule={handleDelSched} handleInitializeDB={handleInitDB} handleScan={handleScan} />}
                                    </Fragment>
                                )}
                            </div>
                        </main>

                        {/* Mobile Nav */}
                        {isMobile && (
                            <nav className="md:hidden bg-white border-t border-slate-200 flex justify-around pb-safe pt-3 px-2 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] fixed bottom-0 w-full z-50 rounded-t-3xl">
                                <button onClick={()=>setActiveTab('dashboard')} className={`flex-1 flex flex-col items-center gap-1 ${activeTab==='dashboard'?'text-incar':'text-slate-400'}`}><Icon name="layout"/><span className="text-[10px] font-bold">í˜„í™©</span></button>
                                <button onClick={()=>setActiveTab('boarding')} className={`flex-1 flex flex-col items-center gap-1 ${activeTab==='boarding'?'text-incar':'text-slate-400'}`}><Icon name="bus"/><span className="text-[10px] font-bold">íƒ‘ìŠ¹</span></button>
                                <button onClick={()=>setActiveTab('payment')} className={`flex-1 flex flex-col items-center gap-1 ${activeTab==='payment'?'text-incar':'text-slate-400'}`}><Icon name="dollar"/><span className="text-[10px] font-bold">ì§€ê¸‰</span></button>
                                <button onClick={()=>setActiveTab('manage')} className={`flex-1 flex flex-col items-center gap-1 ${activeTab==='manage'?'text-incar':'text-slate-400'}`}><Icon name="settings"/><span className="text-[10px] font-bold">ê´€ë¦¬</span></button>
                            </nav>
                        )}
                    </div>

                    <ScanResultModal scanResult={scanResult} setScanResult={setScanResult} />
                    <ScheduleEditorModal editingSchedule={editingSchedule} setEditingSchedule={setEditingSchedule} handleSaveSchedule={handleSaveSched} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
