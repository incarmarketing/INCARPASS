<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>INCARPASS - 통합 운영 시스템</title>
    
    <!-- 1. 필수 라이브러리 (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 2. Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- 3. QR 스캐너 -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <!-- 4. 스타일 및 폰트 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        incar: '#27398C', 
                        'incar-dark': '#1a2b6d',
                        'incar-light': '#eef2ff'
                    },
                    boxShadow: { 
                        'card': '0 4px 20px -2px rgba(0, 0, 0, 0.08)',
                        'nav': '0 -4px 20px rgba(0,0,0,0.05)' 
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; color: #1e293b; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 가시성 확보를 위한 강제 스타일 */
        select, input { color: #1e293b !important; background-color: #ffffff !important; }
        option { color: #1e293b !important; background-color: #ffffff !important; }
        
        /* 스캐너 */
        #reader { width: 100%; border-radius: 1rem; overflow: hidden; border: none; }
        #reader video { object-fit: cover; border-radius: 1rem; }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment } = React;

        // ============================================================
        // ▼▼▼ [설정] 파이어베이스 키 입력란 ▼▼▼
        // ============================================================
        const firebaseConfig = {
  apiKey: "AIzaSyAh1dsSNobeF6Wz-0euP5AUggdqJANJ3dQ",
  authDomain: "incarpass.firebaseapp.com",
  projectId: "incarpass",
  storageBucket: "incarpass.firebasestorage.app",
  messagingSenderId: "955362361998",
  appId: "1:955362361998:web:166055dd392784f1827fdf",
  measurementId: "G-SNR3FPPQ7E"
};
        const SYSTEM_APP_ID = 'inca-prod-v1';
        // ============================================================

        // --- [부품] 아이콘 ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                camera: <g><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></g>,
                qr: <g><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><path d="M3 14h7v7H3z"/></g>,
                layout: <g><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></g>,
                check: <polyline points="20 6 9 17 4 12"/>,
                x: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
                users: <g><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                dollar: <g><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></g>,
                settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
                plus: <g><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></g>,
                edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></g>,
                trash: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></g>,
                refresh: <g><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></g>,
                database: <g><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></g>,
                activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>,
                calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></g>,
                alert: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></g>,
                chevronRight: <polyline points="9 18 15 12 9 6"/>,
                chart: <g><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></g>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10"/>}</svg>;
        };

        // --- [화면 1] 대시보드 ---
        const DashboardView = ({ stats, schedules, currentSessionId, logs }) => (
            <div className="space-y-6 animate-fade-in pb-24 md:pb-8">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-card">
                        <div className="flex justify-between items-center mb-3">
                            <p className="text-xs text-slate-500 font-bold uppercase tracking-wider">누적 처리 인원</p>
                            <div className="p-2 bg-indigo-50 rounded-lg text-incar"><Icon name="users" size={20}/></div>
                        </div>
                        <h3 className="text-4xl font-black text-slate-900">{stats.totalCount}<span className="text-lg font-bold text-slate-400 ml-1">명</span></h3>
                    </div>
                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-card">
                        <div className="flex justify-between items-center mb-3">
                            <p className="text-xs text-slate-500 font-bold uppercase tracking-wider">총 지급액</p>
                            <div className="p-2 bg-emerald-50 rounded-lg text-emerald-600"><Icon name="dollar" size={20}/></div>
                        </div>
                        <h3 className="text-4xl font-black text-slate-900">${stats.totalAmount.toLocaleString()}</h3>
                    </div>
                    <div className="bg-incar p-6 rounded-2xl shadow-card text-white relative overflow-hidden">
                        <div className="relative z-10">
                            <p className="text-xs text-blue-200 font-bold uppercase mb-2">현재 진행 세션</p>
                            <h3 className="text-lg font-bold truncate mb-4">{schedules.find(s=>s.id===currentSessionId)?.title || '세션 미선택'}</h3>
                            <div className="flex justify-between items-end">
                                <span className="text-4xl font-black">{stats.currentCount}<span className="text-lg ml-1 font-medium opacity-80">명</span></span>
                                <span className="text-[10px] bg-white/20 px-2 py-1 rounded backdrop-blur-sm">실시간</span>
                            </div>
                        </div>
                        <div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="layout" size={100}/></div>
                    </div>
                </div>
                
                <div className="bg-white rounded-2xl border border-slate-200 shadow-card overflow-hidden">
                    <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-white">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="activity" size={18} className="text-incar"/> 실시간 로그</h3>
                        <button onClick={()=>window.location.reload()} className="text-xs border px-3 py-1 rounded hover:bg-slate-50">새로고침</button>
                    </div>
                    <div className="overflow-x-auto max-h-[400px]">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 text-slate-500 text-xs font-bold uppercase sticky top-0">
                                <tr><th className="p-4 w-20">시간</th><th className="p-4">이름</th><th className="p-4">세션</th><th className="p-4">유형</th><th className="p-4 text-right">금액</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                {logs.length === 0 ? <tr><td colspan="5" className="p-10 text-center text-slate-400">기록 없음</td></tr> : logs.map(log => (
                                    <tr key={log.id} className="hover:bg-slate-50 transition-colors">
                                        <td className="p-4 text-xs text-slate-400 font-mono">{log.displayTime.split(' ')[1]||log.displayTime}</td>
                                        <td className="p-4 font-bold text-slate-800">{log.name} <span className="text-xs text-slate-400 font-normal">({log.affiliation})</span></td>
                                        <td className="p-4 text-slate-600 text-xs">{log.sessionTitle}</td>
                                        <td className="p-4"><span className={`px-2 py-0.5 rounded text-[10px] font-bold border ${log.action==='지급'?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-indigo-50 text-incar border-indigo-100'}`}>{log.action}</span></td>
                                        <td className="p-4 text-right font-bold text-slate-900">{log.amount>0 ? `$${log.amount}` : '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );

        // --- [화면 2] 스캔 뷰 ---
        const ScanView = ({ schedules, currentSessionId, setCurrentSessionId, stats, scannerActive, setScannerActive, handleScan }) => (
            <div className="space-y-6 animate-fade-in pb-24 md:pb-8 max-w-lg mx-auto">
                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-card">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-slate-900 flex items-center gap-2"><Icon name="qr" size={20} className="text-incar"/> 스캔 모니터링</h3>
                        <span className="text-xs font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded">{new Date().toLocaleDateString()}</span>
                    </div>
                    <div className="mb-4">
                        <label className="block text-xs font-bold text-slate-400 mb-2">TARGET SESSION</label>
                        <div className="relative">
                            <select value={currentSessionId} onChange={(e)=>setCurrentSessionId(e.target.value)} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 appearance-none focus:ring-2 focus:ring-incar outline-none shadow-sm">
                                {schedules.length===0 ? <option>일정 없음</option> : schedules.map(s=><option key={s.id} value={s.id}>{s.title}</option>)}
                            </select>
                            <div className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><Icon name="chevronRight" className="rotate-90"/></div>
                        </div>
                    </div>
                    <div className="flex justify-between items-center p-4 bg-incar-light rounded-xl border border-indigo-100">
                        <span className="font-bold text-incar text-sm">현재 세션 완료</span>
                        <span className="font-black text-xl text-slate-900">{stats.currentCount}명</span>
                    </div>
                </div>

                <div className="bg-white rounded-3xl shadow-card p-6 min-h-[360px] flex flex-col items-center justify-center relative overflow-hidden border border-slate-200">
                    {scannerActive ? (
                        <div id="reader" className="w-full h-full relative z-10"></div>
                    ) : (
                        <div className="text-center space-y-4">
                            <div className="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mx-auto text-slate-300"><Icon name="camera" size={40}/></div>
                            <p className="text-slate-400 font-bold text-sm">카메라가 꺼져있습니다</p>
                        </div>
                    )}
                </div>

                <div className="flex gap-3">
                    <button onClick={()=>setScannerActive(!scannerActive)} className={`flex-1 py-4 rounded-xl font-bold text-white shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2 ${scannerActive ? 'bg-rose-500' : 'bg-incar'}`}>
                        <Icon name={scannerActive ? 'x' : 'camera'}/> {scannerActive ? '스캔 중단' : '스캔 시작'}
                    </button>
                    <button onClick={()=>handleScan('1611499_A')} className="px-6 py-4 bg-white border border-slate-200 text-slate-500 font-bold rounded-xl hover:bg-slate-50 active:scale-95 text-xs">테스트</button>
                </div>
            </div>
        );

        // --- [화면 3] 관리 뷰 (유지보수) ---
        const ManageView = ({ schedules, setEditingSchedule, handleDeleteSchedule, handleInitializeDB }) => (
            <div className="space-y-6 animate-fade-in pb-24 md:pb-8">
                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-card flex justify-between items-center">
                    <div><h2 className="text-xl font-bold text-slate-900">일정 관리</h2><p className="text-sm text-slate-500">행사 일정 및 지급액 설정</p></div>
                    <button onClick={()=>setEditingSchedule({id:'',title:'',price:0,type:'BOARDING'})} className="bg-incar text-white px-4 py-2.5 rounded-xl font-bold text-sm shadow-md flex items-center gap-2 active:scale-95 transition-transform"><Icon name="plus" size={18}/> 추가</button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {schedules.map(s => (
                        <div key={s.id} className="p-5 bg-white border border-slate-200 rounded-2xl shadow-sm flex justify-between items-center hover:border-incar transition-colors">
                            <div>
                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded border mb-1 inline-block ${s.type==='PAYMENT'?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-indigo-50 text-incar border-indigo-100'}`}>{s.type==='PAYMENT'?'지급':'탑승'}</span>
                                <h4 className="font-bold text-slate-800">{s.title}</h4>
                                <p className="text-xs text-slate-400 font-medium">{s.type==='PAYMENT'?`$${s.price}`:'인원체크'}</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>setEditingSchedule(s)} className="p-2 bg-slate-50 text-slate-400 rounded-lg hover:text-incar"><Icon name="edit" size={16}/></button>
                                <button onClick={()=>handleDeleteSchedule(s.id)} className="p-2 bg-slate-50 text-slate-400 rounded-lg hover:text-rose-500"><Icon name="trash" size={16}/></button>
                            </div>
                        </div>
                    ))}
                </div>

                <div className="p-6 bg-slate-800 rounded-2xl text-white flex justify-between items-center shadow-lg mt-8">
                    <div><h4 className="font-bold">시스템 유지보수</h4><p className="text-xs text-slate-400">데이터 오류 시 초기화</p></div>
                    <button onClick={handleInitializeDB} className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-xs font-bold flex items-center gap-2"><Icon name="database" size={14}/> DB 초기화</button>
                </div>
            </div>
        );

        // --- 모달 컴포넌트 ---
        const ScheduleEditorModal = ({ editingSchedule, setEditingSchedule, handleSaveSchedule }) => {
            const [formData, setFormData] = useState({ title: '', price: 0, type: 'BOARDING' });
            useEffect(() => { if(editingSchedule) setFormData(editingSchedule); }, [editingSchedule]);
            if (!editingSchedule) return null;
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] p-6 animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-lg text-slate-900">{editingSchedule.id ? '일정 수정' : '새 일정'}</h3>
                            <button onClick={()=>setEditingSchedule(null)}><Icon name="x" className="text-slate-400"/></button>
                        </div>
                        <div className="space-y-4 mb-6">
                            <input type="text" value={formData.title} onChange={e=>setFormData({...formData, title: e.target.value})} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-900 outline-none focus:border-incar" placeholder="일정명" />
                            <div className="flex gap-2">
                                {['BOARDING', 'PAYMENT'].map(type => (
                                    <button key={type} onClick={()=>setFormData({...formData, type})} className={`flex-1 py-3 rounded-xl text-xs font-bold ${formData.type===type?'bg-incar text-white':'bg-slate-100 text-slate-500'}`}>{type==='PAYMENT'?'지급':'탑승'}</button>
                                ))}
                            </div>
                            {formData.type === 'PAYMENT' && <input type="number" value={formData.price} onChange={e=>setFormData({...formData, price: Number(e.target.value)})} className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-900 outline-none focus:border-incar" placeholder="금액" />}
                        </div>
                        <button onClick={()=>handleSaveSchedule(editingSchedule.id, formData)} className="w-full py-4 bg-incar text-white font-bold rounded-xl shadow-lg">저장하기</button>
                    </div>
                </div>
            );
        };

        const ScanResultModal = ({ scanResult, setScanResult }) => {
            if (!scanResult) return null;
            const { status, msg, subMsg, amount, user } = scanResult;
            useEffect(() => { if (status === 'success') setTimeout(() => setScanResult(null), 2000); }, [status]);
            const color = status === 'success' ? 'text-emerald-500' : status === 'duplicate' ? 'text-amber-500' : 'text-rose-500';
            
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] p-6 animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 text-center">
                        <div className={`mx-auto mb-4 ${color}`}><Icon name={status==='success'?'check':'alert'} size={64}/></div>
                        <h3 className="text-2xl font-black text-slate-900 mb-1">{msg}</h3>
                        <p className="text-slate-500 text-sm mb-6">{subMsg}</p>
                        {user && <div className="bg-slate-50 p-4 rounded-xl text-left border border-slate-100 mb-6">
                            <div className="font-bold text-slate-900 text-lg">{user.name}</div>
                            <div className="text-xs text-slate-500">{user.affiliation} · {user.bus}</div>
                            {amount > 0 && <div className="mt-2 pt-2 border-t border-slate-200 flex justify-between text-emerald-600 font-bold"><span>지급</span><span>${amount}</span></div>}
                        </div>}
                        <button onClick={()=>setScanResult(null)} className="w-full py-4 bg-slate-900 text-white font-bold rounded-xl">닫기</button>
                    </div>
                </div>
            );
        };

        // --- [메인 앱] ---
        function App() {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [schedules, setSchedules] = useState([]);
            const [logs, setLogs] = useState([]);
            const [currentSessionId, setCurrentSessionId] = useState('');
            const [scanResult, setScanResult] = useState(null);
            const [editingSchedule, setEditingSchedule] = useState(null);
            const [scannerActive, setScannerActive] = useState(false);
            const [isLoading, setIsLoading] = useState(true);

            // 초기화
            useEffect(() => {
                const init = async () => {
                    if(firebaseConfig.apiKey) {
                        try {
                            if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                            const _db = firebase.firestore();
                            setDb(_db);
                            await firebase.auth().signInAnonymously();
                            firebase.auth().onAuthStateChanged(u => { setUser(u); if(!u) setIsLoading(false); });
                        } catch(e) { console.error(e); initLocal(); }
                    } else { initLocal(); }
                };
                init();
                const resize = () => { setIsMobile(window.innerWidth < 768); if(window.innerWidth < 768 && activeTab === 'dashboard') setActiveTab('scan'); };
                window.addEventListener('resize', resize);
                return () => window.removeEventListener('resize', resize);
            }, []);

            const initLocal = () => {
                setIsLoading(false);
                const localSched = JSON.parse(localStorage.getItem('inca_schedules') || '[]');
                const localLogs = JSON.parse(localStorage.getItem('inca_logs') || '[]');
                const INIT_SCHED = [
                    { id: 'D1', title: '1일차 공항 미팅', price: 0, type: 'BOARDING' },
                    { id: 'D2', title: '2일차 중식 (딘타이펑)', price: 30, type: 'PAYMENT' }
                ];
                setSchedules(localSched.length ? localSched : INIT_SCHED);
                setLogs(localLogs);
                if(!localSched.length && INIT_SCHED.length) setCurrentSessionId(INIT_SCHED[0].id);
                else if(localSched.length) setCurrentSessionId(localSched[0].id);
            };

            // DB 동기화
            useEffect(() => {
                if(db && user) {
                    const unsubS = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').onSnapshot(snap => {
                        const list = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>a.id.localeCompare(b.id));
                        setSchedules(list);
                        if(list.length && !currentSessionId) setCurrentSessionId(list[0].id);
                    });
                    const unsubL = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').orderBy('timestamp','desc').onSnapshot(snap => {
                        setLogs(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        setIsLoading(false);
                    });
                    return () => { unsubS(); unsubL(); };
                } else if (!db) {
                    localStorage.setItem('inca_schedules', JSON.stringify(schedules));
                    localStorage.setItem('inca_slogs', JSON.stringify(logs));
                }
            }, [db, user, schedules, logs]);

            // 로직
            const handleScan = async (uid) => {
                const MOCK_USERS = [
                    { uid: '1611499_A', name: '홍길동', bus: '1호차', affiliation: '본사' },
                    { uid: '1611499_B', name: '김영희', bus: '1호차', affiliation: '지사' }
                ];
                const target = MOCK_USERS.find(u => u.uid === uid);
                const sched = schedules.find(s => s.id === currentSessionId);
                
                if(!target) return setScanResult({ status: 'error', msg: '미등록', subMsg: 'QR 확인 필요' });
                if(!sched) return setScanResult({ status: 'error', msg: '일정 선택', subMsg: '관리 탭에서 초기화 필요' });
                
                if(logs.some(l => l.uid === uid && l.sessionId === currentSessionId)) 
                    return setScanResult({ status: 'duplicate', msg: '중복', subMsg: '이미 처리됨', user: target });

                const newLog = {
                    uid: target.uid, name: target.name, affiliation: target.affiliation,
                    sessionId: sched.id, sessionTitle: sched.title, action: sched.type === 'PAYMENT'?'지급':'탑승',
                    amount: sched.type === 'PAYMENT' ? sched.price : 0,
                    timestamp: new Date().toISOString(), displayTime: new Date().toLocaleString()
                };

                if(db) await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').add(newLog);
                else setLogs(p => [newLog, ...p]);

                setScanResult({ status: 'success', msg: '완료', subMsg: sched.title, amount: newLog.amount, user: target });
            };

            const handleInitDB = async () => {
                if(!confirm("초기화 하시겠습니까?")) return;
                setIsLoading(true);
                const INIT = [
                    { id: 'D1', title: '1일차 공항 미팅', price: 0, type: 'BOARDING' },
                    { id: 'D2', title: '2일차 중식 (딘타이펑)', price: 30, type: 'PAYMENT' }
                ];
                if(db) {
                    const batch = db.batch();
                    INIT.forEach(s => batch.set(db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').doc(s.id), s));
                    await batch.commit();
                    alert("서버 초기화 완료");
                } else {
                    setSchedules(INIT); setLogs([]); localStorage.clear(); alert("로컬 초기화 완료");
                }
                setIsLoading(false);
            };

            const handleSaveSched = async (id, data) => {
                const sid = id || `S_${Date.now()}`;
                const newData = { ...data, id: sid };
                if(db) await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').doc(sid).set(newData);
                else {
                    const next = schedules.filter(s => s.id !== id);
                    setSchedules([...next, newData]);
                }
                setEditingSchedule(null);
            };

            const handleDelSched = async (id) => {
                if(!confirm("삭제?")) return;
                if(db) await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').doc(id).delete();
                else setSchedules(schedules.filter(s => s.id !== id));
            };

            const stats = useMemo(() => {
                return {
                    totalCount: logs.length,
                    totalAmount: logs.reduce((s, l) => s + (Number(l.amount)||0), 0),
                    currentCount: logs.filter(l => l.sessionId === currentSessionId).length
                };
            }, [logs, currentSessionId]);

            // --- 렌더링 ---
            return (
                <div className="flex h-full w-full">
                    {/* PC Sidebar */}
                    {!isMobile && (
                        <aside className="w-72 bg-incar text-white h-full shadow-2xl flex flex-col z-20">
                            <div className="p-8 border-b border-white/10 flex items-center gap-3">
                                <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center font-black">P</div>
                                <div><span className="font-bold block leading-none">INCARPASS</span><span className="text-[10px] text-blue-200 opacity-80">PRO EDITION</span></div>
                            </div>
                            <nav className="flex-1 px-4 py-6 space-y-2">
                                <button onClick={()=>setActiveTab('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${activeTab==='dashboard'?'bg-white text-incar shadow-lg':'text-blue-200 hover:bg-white/10'}`}><Icon name="layout"/> 대시보드</button>
                                <button onClick={()=>setActiveTab('scan')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${activeTab==='scan'?'bg-white text-incar shadow-lg':'text-blue-200 hover:bg-white/10'}`}><Icon name="qr"/> 스캔 모니터링</button>
                                <button onClick={()=>setActiveTab('manage')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${activeTab==='manage'?'bg-white text-incar shadow-lg':'text-blue-200 hover:bg-white/10'}`}><Icon name="settings"/> 유지보수/설정</button>
                            </nav>
                            <div className="p-5 border-t border-white/10 flex items-center gap-2 text-xs font-bold text-blue-200">
                                <div className={`w-2.5 h-2.5 rounded-full ${db?'bg-emerald-400':'bg-amber-400'}`}></div> {db?'Server Online':'Local Mode'}
                            </div>
                        </aside>
                    )}

                    <div className="flex-1 flex flex-col relative bg-slate-50">
                        {/* Header */}
                        <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-10 shadow-sm">
                            <h2 className="text-lg font-bold text-slate-800">{activeTab==='dashboard'?'통합 대시보드':activeTab==='scan'?'스캔 모니터링':'시스템 유지보수'}</h2>
                            {isMobile && <div className="w-8 h-8 bg-incar rounded-lg flex items-center justify-center text-white font-bold text-xs">P</div>}
                        </header>

                        {/* Main Content */}
                        <main className="flex-1 overflow-y-auto p-4 pb-24 md:pb-8">
                            <div className="max-w-6xl mx-auto">
                                {isLoading ? <div className="flex flex-col items-center justify-center h-96 text-slate-400"><div className="loader mb-4"></div>로딩중...</div> : (
                                    <Fragment>
                                        {activeTab === 'dashboard' && <DashboardView stats={stats} schedules={schedules} currentSessionId={currentSessionId} logs={logs} />}
                                        {activeTab === 'scan' && <ScanView schedules={schedules} currentSessionId={currentSessionId} setCurrentSessionId={setCurrentSessionId} stats={stats} scannerActive={scannerActive} setScannerActive={setScannerActive} handleScan={handleScan} />}
                                        {activeTab === 'manage' && <ManageView schedules={schedules} setEditingSchedule={setEditingSchedule} handleDeleteSchedule={handleDeleteSchedule} handleInitializeDB={handleInitDB} />}
                                    </Fragment>
                                )}
                            </div>
                        </main>

                        {/* Mobile Nav */}
                        {isMobile && (
                            <nav className="md:hidden bg-white border-t border-slate-200 flex justify-around pb-safe pt-3 px-2 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] fixed bottom-0 w-full z-50 rounded-t-3xl">
                                <button onClick={()=>setActiveTab('dashboard')} className={`flex-1 flex flex-col items-center gap-1 ${activeTab==='dashboard'?'text-incar':'text-slate-400'}`}><Icon name="layout"/><span className="text-[10px] font-bold">현황</span></button>
                                <button onClick={()=>setActiveTab('scan')} className={`flex-1 flex flex-col items-center gap-1 ${activeTab==='scan'?'text-incar':'text-slate-400'}`}><Icon name="qr"/><span className="text-[10px] font-bold">스캔</span></button>
                                <button onClick={()=>setActiveTab('manage')} className={`flex-1 flex flex-col items-center gap-1 ${activeTab==='manage'?'text-incar':'text-slate-400'}`}><Icon name="settings"/><span className="text-[10px] font-bold">관리</span></button>
                            </nav>
                        )}
                    </div>

                    <ScanResultModal scanResult={scanResult} setScanResult={setScanResult} />
                    <ScheduleEditorModal editingSchedule={editingSchedule} setEditingSchedule={setEditingSchedule} handleSaveSchedule={handleSaveSched} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
